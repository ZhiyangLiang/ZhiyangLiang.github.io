<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>å¦‚ä½•æ‰“åŒ…è®­ç»ƒç¯å¢ƒ (conda pack)</title>
    <link href="/2024/04/17/%E5%A6%82%E4%BD%95%E6%89%93%E5%8C%85%E8%AE%AD%E7%BB%83%E7%8E%AF%E5%A2%83%20(conda-pack)/"/>
    <url>/2024/04/17/%E5%A6%82%E4%BD%95%E6%89%93%E5%8C%85%E8%AE%AD%E7%BB%83%E7%8E%AF%E5%A2%83%20(conda-pack)/</url>
    
    <content type="html"><![CDATA[<ul><li>æ‰“åŒ…ç¯å¢ƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@autodl-container-f4d5458449-4ea6d9e7:~<span class="hljs-comment"># conda create -n llm_env --clone base</span><br>Source:      /root/miniconda3<br>Destination: /root/miniconda3/envs/llm_env<br>The following packages cannot be cloned out of the root environment:<br> - defaults/linux-64::conda-4.10.3-py38h06a4308_0<br>Packages: 34<br>Files: 35817<br>Preparing transaction: <span class="hljs-keyword">done</span><br>Verifying transaction: <span class="hljs-keyword">done</span><br>Executing transaction: <span class="hljs-keyword">done</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># To activate this environment, use</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#     $ conda activate llm_env</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># To deactivate an active environment, use</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#     $ conda deactivate</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@autodl-container-f4d5458449-4ea6d9e7:~<span class="hljs-comment"># conda env list</span><br><span class="hljs-comment"># conda environments:</span><br><span class="hljs-comment">#</span><br>base                  *  /root/miniconda3<br>llm_env                    /root/miniconda3/envs/llm_env<br></code></pre></td></tr></table></figure><ul><li>conda pack</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®‰è£…conda pack</span><br>conda install conda-pack<br><br>RemoveError: â€˜requestsâ€™ is a dependency of conda and cannot be removed from condaâ€™s operating environment.<br>conda update --force conda<br><br>CondaHTTPError: HTTP 429 TOO MANY REQUESTS <span class="hljs-keyword">for</span> url &lt;https://mirrors.ustc.edu.cn/anaconda/pkgs/main/linux-64/current_repodata.json&gt; Elapsed: 00:46.163959<br><br>step 1:<br>root@autodl-container-f4d5458449-4ea6d9e7:~<span class="hljs-comment"># vim ~/.condarc</span><br>root@autodl-container-f4d5458449-4ea6d9e7:~<span class="hljs-comment"># cat ~/.condarc</span><br>auto_activate_base: <span class="hljs-literal">false</span><br>show_channel_urls: <span class="hljs-literal">true</span><br>ssl_verify: <span class="hljs-literal">false</span><br>channels:<br>  - conda-forge<br>  - &lt;http://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/&gt;<br>  - &lt;http://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge/&gt;<br>  - &lt;http://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/&gt;<br>  - &lt;https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/msys2/&gt;<br>  - &lt;https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud/conda-forge&gt;<br>  - &lt;https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/&gt;<br>  - defaults<br><br>step 2:<br>conda create --name superset python=3.8<br><br><span class="hljs-comment"># æ‰“åŒ…ç¯å¢ƒ</span><br>conda pack -n llm_env<br><br>root@autodl-container-30da119afa-edacec3e:~<span class="hljs-comment"># conda pack -n llm_env</span><br>Collecting packages...<br>CondaPackError: Cannot pack an environment with editable packages<br>installed (e.g. from `python setup.py develop` or<br> `pip install -e`). Editable packages found:<br><br>- /root/autodl-tmp/peft/src<br><br>conda pack -n llm_env --ignore-editable-packages<br></code></pre></td></tr></table></figure><ul><li>å®‰è£…ç¯å¢ƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åœ¨è·³æ¿æœºè¿›è¡Œä¸Šä¼ </span><br>scp llm_env.tar.gz lanlong@172.20.208.8:~/zyliang<br><br><span class="hljs-comment"># ä¸å‘ä¸Šä¼ ç›¸åº”çš„, è¡¥å……ä¸€ä¸ªå‘ä¸‹å–çš„ä¾‹å­; ä½†æ˜¯è·³æ¿æœºæ¯”è¾ƒç‰¹æ®Š, å°†æ–‡ä»¶ä¼ åˆ°è·³æ¿æœºéœ€è¦ç”¨FileZilla</span><br>scp -rP 35381 root@region-9.autodl.pro:~/llm_env.tar.gz ~/zyliang<br><br><span class="hljs-comment"># åœ¨ç›®æ ‡æœåŠ¡å™¨è¿›è¡Œå®‰è£…</span><br><span class="hljs-built_in">mkdir</span> -p llm_env<br><br>(base) lanlong@a101:~/zyliang$ tar -xzf llm_env.tar.gz -C llm_env<br>(base) lanlong@a101:~/zyliang$ <span class="hljs-built_in">cd</span> llm_env<br>(base) lanlong@a101:~/zyliang/llm_env$ <span class="hljs-built_in">ls</span><br>bin              conda-meta  include  lib    ssl                          x86_64-conda-linux-gnu<br>compiler_compat  etc         info     share  x86_64-conda_cos6-linux-gnu<br><br>./llm_env/bin/python <span class="hljs-comment"># æµ‹è¯•</span><br>ctrl + z é€€å‡º<br><span class="hljs-built_in">source</span> llm_env/bin/activate <span class="hljs-comment"># æ¿€æ´»ç¯å¢ƒ, llm_env/bin ä¼šè¢«æ·»åŠ åˆ°ç¯å¢ƒå˜é‡</span><br>python <span class="hljs-comment"># åœ¨ç¯å¢ƒä¸­è¿è¡Œpython</span><br>conda-unpack <span class="hljs-comment"># åœ¨æ¿€æ´»ç¯å¢ƒä¸­æ¸…æ¥šå‰ç¼€</span><br>ipython --version<br><br><span class="hljs-comment"># è‹¥ä¸å†ä½¿ç”¨</span><br><span class="hljs-built_in">source</span> llm_env/bin/deactivate <span class="hljs-comment"># åœç”¨ç¯å¢ƒå¹¶å°†å…¶ä»ç¯å¢ƒå˜é‡ä¸­åˆ é™¤</span><br></code></pre></td></tr></table></figure><ul><li>Ubuntuæ›´æ¢é•œåƒ</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">cd /etc/apt/<br>sudo cp sources.<span class="hljs-built_in">list</span> sources.<span class="hljs-built_in">list</span>.old<br>sudo vim /etc/apt/sources.<span class="hljs-built_in">list</span><br><br>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic main restricted universe multiverse<br>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse<br>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse<br>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse<br>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ trusty main universe restricted multiverse<br>deb http://archive.ubuntu.com/ubuntu/ trusty main universe restricted multiverse<br><span class="hljs-comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic main restricted universe multiverse</span><br><span class="hljs-comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="hljs-comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="hljs-comment"># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Basic Skills</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DeepSpeed</title>
    <link href="/2024/02/27/DeepSpeed/"/>
    <url>/2024/02/27/DeepSpeed/</url>
    
    <content type="html"><![CDATA[<ul><li>å®‰è£…DeepSpeed</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/microsoft/DeepSpeed.git<br><span class="hljs-built_in">cd</span> DeepSpeed<br>git checkout v0.9.5<br><br>TORCH_CUDA_ARCH_LIST=<span class="hljs-string">&quot;6.1;7.5;8.6;8.9&quot;</span> \<br>DS_BUILD_CCL_COMM=1 \<br>DS_BUILD_CPU_ADAM=1 \<br>DS_BUILD_CPU_ADAGRAD=1 \<br>DS_BUILD_FUSED_ADAM=1 \<br>DS_BUILD_FUSED_LAMB=1 \<br>DS_BUILD_UTILS=1 \<br>python setup.py build_ext -j24 bdist_wheel<br><br><span class="hljs-comment"># è¿›å…¥DeepSpeedç›®å½•ä¸‹çš„distç›®å½•, å®‰è£…whlæ–‡ä»¶</span><br>pip install *.whl<br></code></pre></td></tr></table></figure><p>æ›´å¤šé…ç½®ä¿¡æ¯å¯è§äº<ahref="https://github.com/OvJat/DeepSpeedTutorial">OvJat/DeepSpeedTutorial:DeepSpeed Tutorial (github.com)</a></p><ul><li>è®­ç»ƒçš„æ¨¡å‹ä¸æ­¢ä¸€ä¸ªæ—¶ (æ­¤å¤„ä»¥stable diffusionä¸ºä¾‹), an example:</li></ul><p><ahref="https://github.com/Azure/azureml-examples/tree/main/cli/jobs/deepspeed/deepspeed-training/src">cli/jobs/deepspeed/deepspeed-training/src</a></p><ul><li>å®‰è£…mpi4py</li></ul><p>sudo apt update sudo apt-get install libopenmpi-dev</p><p>pip install mpi4py</p><ul><li>hfä¸deepspeedçš„é…ç½®å†²çª, å°†deepspeedçš„ç›¸åº”é…ç½®ä¿®æ”¹ä¸ºâ€autoâ€</li></ul><p>"bf16": { "enabled": "auto" }</p><ul><li>ä½¿ç”¨deepspeedéœ€è¦å®‰è£…bitsandbytes</li></ul><p>pip install bitsandbytes</p><ul><li>å¤šå¡è¿è¡Œ</li></ul><p>CUDA_VISIBLE_DEVICES=0,1 torchrun --nproc_per_node=2--master_port=29500 finetune.py</p><p>è¿è¡Œæ—¶é—´: 03:33&lt;12:41:38</p><ul><li>å•å¡è¿è¡Œ</li></ul><p>CUDA_VISIBLE_DEVICES=0 torchrun --nproc_per_node=1--master_port=29500 finetune.py</p><p>è¿è¡Œæ—¶é—´: 03:38&lt;46:53:33</p><ul><li>å¦‚ä½•è°ƒç”¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å•GPUçš„ä½¿ç”¨æ–¹æ³•</span><br>deepspeed --num_gpus=1 examples/pytorch/translation/run_translation.py ...<br><span class="hljs-comment"># å•GPUå¹¶æŒ‡å®šå¯¹åº”çš„GPU</span><br>deepspeed --include localhost:1 examples/pytorch/translation/run_translation.py ...<br><span class="hljs-comment"># å•GPUä½¿ç”¨DeepSpeedçš„ä¼˜åŠ¿:</span><br><span class="hljs-comment"># ä½¿ç”¨ZeRO-offload, å°†éƒ¨åˆ†æ•°æ®offloadåˆ°CPUï¼Œé™ä½å¯¹æ˜¾å­˜çš„éœ€æ±‚</span><br><span class="hljs-comment"># æä¾›å¯¹æ˜¾å­˜çš„ç®¡ç†, å‡å°‘æ˜¾å­˜çš„ç¢ç‰‡</span><br><br><span class="hljs-comment"># å¤šGPUçš„ä½¿ç”¨æ–¹æ³•1</span><br>torch.distributed.run --nproc_per_node=2 your_program.py &lt;normal cl args&gt; --deepspeed ds_config.json<br><span class="hljs-comment"># å¤šGPUçš„ä½¿ç”¨æ–¹æ³•2</span><br>deepspeed --num_gpus=2 your_program.py &lt;normal cl args&gt; --deepspeed ds_config.json<br><br><span class="hljs-comment"># å¤šèŠ‚ç‚¹å¤šå¡æ–¹æ³•1ï¼Œéœ€è¦åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šæ‰‹åŠ¨å¯åŠ¨</span><br>python -m torch.distributed.run --nproc_per_node=8 --nnode=2 --node_rank=0 --master_addr=hostname1 --master_port=9901 your_program.py &lt;normal cl args&gt; --deepspeed ds_config.json<br><span class="hljs-comment"># å¤šèŠ‚ç‚¹å¤šå¡æ–¹æ³•2ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ª hostfile æ–‡ä»¶ï¼Œåªéœ€åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå¯åŠ¨</span><br>hostname1 slots=8  <span class="hljs-comment"># è¡¨ç¤ºè¯¥æœºå™¨æœ‰8ä¸ªGPUç”¨äºè®­ç»ƒ</span><br>hostname2 slots=8<br><span class="hljs-comment"># ç„¶åè¿è¡Œ</span><br>deepspeed --num_gpus 8 --num_nodes 2 --hostfile hostfile --master_addr hostname1 --master_port=9901 your_program.py &lt;normal cl args&gt; --deepspeed ds_config.json<br></code></pre></td></tr></table></figure><ul><li>ä¼ é€’å‚æ•°</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">TrainingArguments(..., deepspeed=<span class="hljs-string">&quot;config/ds_config.json&quot;</span>)<br><span class="hljs-comment"># or</span><br>ds_config_dict = <span class="hljs-built_in">dict</span>(scheduler=scheduler_params, optimizer=optimizer_params)<br>TrainingArguments(..., deepspeed=ds_config_dict)<br></code></pre></td></tr></table></figure><ul><li>ZeRO-stage-0é…ç½®ç¤ºä¾‹</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"># ç¦ç”¨æ‰€æœ‰çš„åˆ†ç‰‡<span class="hljs-punctuation">,</span> æŠŠDeepSpeedå½“ä½œDDPæ¥ä½¿ç”¨<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;zero_optimization&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ul><li>ZeRO-stage-1é…ç½®ç¤ºä¾‹</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;zero_optimization&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ul><li>ZeRO-stage-2é…ç½®ç¤ºä¾‹</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;fp16&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;loss_scale&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;loss_scale_window&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;initial_scale_power&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hysteresis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;min_loss_scale&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;optimizer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AdamW&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;lr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;betas&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;eps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;weight_decay&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;scheduler&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;WarmupLR&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;warmup_min_lr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;warmup_max_lr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;warmup_num_steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;zero_optimization&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;offload_optimizer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;device&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cpu&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;pin_memory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;allgather_partitions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;allgather_bucket_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2e8</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;overlap_comm&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;reduce_scatter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;reduce_bucket_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2e8</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;contiguous_gradients&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;gradient_accumulation_steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;gradient_clipping&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;steps_per_print&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;train_batch_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;train_micro_batch_size_per_gpu&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;wall_clock_breakdown&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ul><li>ZeRO-stage-3é…ç½®ç¤ºä¾‹</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;fp16&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;loss_scale&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;loss_scale_window&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;initial_scale_power&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hysteresis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;min_loss_scale&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;optimizer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AdamW&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;lr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;betas&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;eps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;weight_decay&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;scheduler&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;WarmupLR&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;warmup_min_lr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;warmup_max_lr&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;warmup_num_steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;zero_optimization&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stage&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;offload_optimizer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;device&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cpu&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;pin_memory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;offload_param&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;device&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;cpu&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;pin_memory&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;overlap_comm&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;contiguous_gradients&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;sub_group_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1e9</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;reduce_bucket_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;stage3_prefetch_bucket_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;stage3_param_persistence_threshold&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;stage3_max_live_parameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1e9</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;stage3_max_reuse_distance&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1e9</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;stage3_gather_16bit_weights_on_model_save&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>    <span class="hljs-attr">&quot;gradient_accumulation_steps&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;gradient_clipping&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;steps_per_print&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;train_batch_size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;train_micro_batch_size_per_gpu&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;auto&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;wall_clock_breakdown&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// original</span><br><span class="hljs-comment">// &#123;</span><br><span class="hljs-comment">//     &quot;zero_optimization&quot;: &#123;</span><br><span class="hljs-comment">//         &quot;stage&quot;: 3,</span><br><span class="hljs-comment">//         &quot;offload_optimizer&quot;: &#123;</span><br><span class="hljs-comment">//             &quot;device&quot;: &quot;none&quot;,</span><br><span class="hljs-comment">//             &quot;pin_memory&quot;: true</span><br><span class="hljs-comment">//         &#125;,</span><br><span class="hljs-comment">//         &quot;offload_param&quot;: &#123;</span><br><span class="hljs-comment">//             &quot;device&quot;: &quot;none&quot;,</span><br><span class="hljs-comment">//             &quot;pin_memory&quot;: true</span><br><span class="hljs-comment">//         &#125;,</span><br><span class="hljs-comment">//         &quot;overlap_comm&quot;: true,</span><br><span class="hljs-comment">//         &quot;contiguous_gradients&quot;: true,</span><br><span class="hljs-comment">//         &quot;sub_group_size&quot;: 1e9,</span><br><span class="hljs-comment">//         &quot;reduce_bucket_size&quot;: &quot;auto&quot;,</span><br><span class="hljs-comment">//         &quot;stage3_prefetch_bucket_size&quot;: &quot;auto&quot;,</span><br><span class="hljs-comment">//         &quot;stage3_param_persistence_threshold&quot;: &quot;auto&quot;,</span><br><span class="hljs-comment">//         &quot;stage3_max_live_parameters&quot;: 1e9,</span><br><span class="hljs-comment">//         &quot;stage3_max_reuse_distance&quot;: 1e9,</span><br><span class="hljs-comment">//         &quot;stage3_gather_16bit_weights_on_model_save&quot;: true</span><br><span class="hljs-comment">//     &#125;,</span><br><span class="hljs-comment">//     &quot;train_batch_size&quot;: &quot;auto&quot;,</span><br><span class="hljs-comment">//     &quot;train_micro_batch_size_per_gpu&quot;: &quot;auto&quot;,</span><br><span class="hljs-comment">//     &quot;gradient_accumulation_steps&quot;: &quot;auto&quot;,</span><br><span class="hljs-comment">//     &quot;bf16&quot;: &#123;</span><br><span class="hljs-comment">//         &quot;enabled&quot;: true</span><br><span class="hljs-comment">//     &#125;</span><br><span class="hljs-comment">// &#125;</span><br></code></pre></td></tr></table></figure><ul><li>inference</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">deepspeed --num_gpus=<span class="hljs-number">2</span> your_program.py &lt;normal cl args&gt; --do_eval --deepspeed ds_config.json<br></code></pre></td></tr></table></figure><ul><li>Accelerate</li></ul><p><ahref="https://zhuanlan.zhihu.com/p/462453622">ğŸ¤—Accelerateåº“çš„ä½¿ç”¨æŒ‡å—å’Œæ¡ˆä¾‹- çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>DDP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Prompt Engineering</title>
    <link href="/2024/02/12/Prompt%20Engineering/"/>
    <url>/2024/02/12/Prompt%20Engineering/</url>
    
    <content type="html"><![CDATA[<ul><li>åˆå§‹è®¾ç½®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> openai<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv, find_dotenv<br>_ = load_dotenv(find_dotenv())<br><br>openai.api_key  = os.getenv(<span class="hljs-string">&#x27;OPENAI_API_KEY&#x27;</span>)<br><br><span class="hljs-comment"># OpenAI library version 0.27.0</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_completion</span>(<span class="hljs-params">prompt, model=<span class="hljs-string">&quot;gpt-3.5-turbo&quot;</span></span>):<br>    messages = [&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: prompt&#125;]<br>    response = openai.ChatCompletion.create(<br>        model=model,<br>        messages=messages,<br>        temperature=<span class="hljs-number">0</span>, <span class="hljs-comment"># this is the degree of randomness of the model&#x27;s output</span><br>    )<br>    <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message[<span class="hljs-string">&quot;content&quot;</span>]<br>    <br><span class="hljs-comment"># OpenAI library version 1.0.0</span><br>client = openai.OpenAI()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_completion</span>(<span class="hljs-params">prompt, model=<span class="hljs-string">&quot;gpt-3.5-turbo&quot;</span></span>):<br>    messages = [&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: prompt&#125;]<br>    response = client.chat.completions.create(<br>        model=model,<br>        messages=messages,<br>        temperature=<span class="hljs-number">0</span><br>    )<br>    <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message.content<br></code></pre></td></tr></table></figure><ul><li><strong>Use delimiters to clearly indicate distinct parts of theinput</strong> â€¢ Delimiters can be anything like:``<code>, """, &lt; &gt;,</code><tag> </tag><code>,</code>:`</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">text = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">You should express what you want a model to do by \\ </span><br><span class="hljs-string">providing instructions that are as clear and \\ </span><br><span class="hljs-string">specific as you can possibly make them. \\ </span><br><span class="hljs-string">This will guide the model towards the desired output, \\ </span><br><span class="hljs-string">and reduce the chances of receiving irrelevant \\ </span><br><span class="hljs-string">or incorrect responses. Don&#x27;t confuse writing a \\ </span><br><span class="hljs-string">clear prompt with writing a short prompt. \\ </span><br><span class="hljs-string">In many cases, longer prompts provide more clarity \\ </span><br><span class="hljs-string">and context for the model, which can lead to \\ </span><br><span class="hljs-string">more detailed and relevant outputs.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Summarize the text delimited by triple backticks \\ </span><br><span class="hljs-string">into a single sentence.</span><br><span class="hljs-string">```<span class="hljs-subst">&#123;text&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li><strong>Ask for a structured output</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Generate a list of three made-up book titles along \\ </span><br><span class="hljs-string">with their authors and genres. </span><br><span class="hljs-string">Provide them in JSON format with the following keys: </span><br><span class="hljs-string">book_id, title, author, genre.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li><strong>Ask the model to check whether conditions aresatisfied</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python">text_1 = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Making a cup of tea is easy! First, you need to get some \\ </span><br><span class="hljs-string">water boiling. While that&#x27;s happening, \\ </span><br><span class="hljs-string">grab a cup and put a tea bag in it. Once the water is \\ </span><br><span class="hljs-string">hot enough, just pour it over the tea bag. \\ </span><br><span class="hljs-string">Let it sit for a bit so the tea can steep. After a \\ </span><br><span class="hljs-string">few minutes, take out the tea bag. If you \\ </span><br><span class="hljs-string">like, you can add some sugar or milk to taste. \\ </span><br><span class="hljs-string">And that&#x27;s it! You&#x27;ve got yourself a delicious \\ </span><br><span class="hljs-string">cup of tea to enjoy.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">You will be provided with text delimited by triple quotes. </span><br><span class="hljs-string">If it contains a sequence of instructions, \\ </span><br><span class="hljs-string">re-write those instructions in the following format:</span><br><span class="hljs-string"></span><br><span class="hljs-string">Step 1 - ...</span><br><span class="hljs-string">Step 2 - â€¦</span><br><span class="hljs-string">â€¦</span><br><span class="hljs-string">Step N - â€¦</span><br><span class="hljs-string"></span><br><span class="hljs-string">If the text does not contain a sequence of instructions, \\ </span><br><span class="hljs-string">then simply write \\&quot;No steps provided.\\&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">\\&quot;\\&quot;\\&quot;<span class="hljs-subst">&#123;text_1&#125;</span>\\&quot;\\&quot;\\&quot;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Completion for Text 1:&quot;</span>)<br><span class="hljs-built_in">print</span>(response)<br><br>text_2 = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">The sun is shining brightly today, and the birds are \\</span><br><span class="hljs-string">singing. It&#x27;s a beautiful day to go for a \\ </span><br><span class="hljs-string">walk in the park. The flowers are blooming, and the \\ </span><br><span class="hljs-string">trees are swaying gently in the breeze. People \\ </span><br><span class="hljs-string">are out and about, enjoying the lovely weather. \\ </span><br><span class="hljs-string">Some are having picnics, while others are playing \\ </span><br><span class="hljs-string">games or simply relaxing on the grass. It&#x27;s a \\ </span><br><span class="hljs-string">perfect day to spend time outdoors and appreciate the \\ </span><br><span class="hljs-string">beauty of nature.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">You will be provided with text delimited by triple quotes. </span><br><span class="hljs-string">If it contains a sequence of instructions, \\ </span><br><span class="hljs-string">re-write those instructions in the following format:</span><br><span class="hljs-string"></span><br><span class="hljs-string">Step 1 - ...</span><br><span class="hljs-string">Step 2 - â€¦</span><br><span class="hljs-string">â€¦</span><br><span class="hljs-string">Step N - â€¦</span><br><span class="hljs-string"></span><br><span class="hljs-string">If the text does not contain a sequence of instructions, \\ </span><br><span class="hljs-string">then simply write \\&quot;No steps provided.\\&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">\\&quot;\\&quot;\\&quot;<span class="hljs-subst">&#123;text_2&#125;</span>\\&quot;\\&quot;\\&quot;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Completion for Text 2:&quot;</span>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li><strong>"Few-shot" prompting</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Your task is to answer in a consistent style.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;child&gt;: Teach me about patience.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;grandparent&gt;: The river that carves the deepest \\ </span><br><span class="hljs-string">valley flows from a modest spring; the \\ </span><br><span class="hljs-string">grandest symphony originates from a single note; \\ </span><br><span class="hljs-string">the most intricate tapestry begins with a solitary thread.</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;child&gt;: Teach me about resilience.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li><strong>Specify the steps required to complete a task</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python">text = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">In a charming village, siblings Jack and Jill set out on \\ </span><br><span class="hljs-string">a quest to fetch water from a hilltop \\ </span><br><span class="hljs-string">well. As they climbed, singing joyfully, misfortune \\ </span><br><span class="hljs-string">struckâ€”Jack tripped on a stone and tumbled \\ </span><br><span class="hljs-string">down the hill, with Jill following suit. \\ </span><br><span class="hljs-string">Though slightly battered, the pair returned home to \\ </span><br><span class="hljs-string">comforting embraces. Despite the mishap, \\ </span><br><span class="hljs-string">their adventurous spirits remained undimmed, and they \\ </span><br><span class="hljs-string">continued exploring with delight.</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment"># example 1</span><br>prompt_1 = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Perform the following actions: </span><br><span class="hljs-string">1 - Summarize the following text delimited by triple \\</span><br><span class="hljs-string">backticks with 1 sentence.</span><br><span class="hljs-string">2 - Translate the summary into French.</span><br><span class="hljs-string">3 - List each name in the French summary.</span><br><span class="hljs-string">4 - Output a json object that contains the following \\</span><br><span class="hljs-string">keys: french_summary, num_names.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Separate your answers with line breaks.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Text:</span><br><span class="hljs-string">```<span class="hljs-subst">&#123;text&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt_1)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Completion for prompt 1:&quot;</span>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li><strong>Ask for output in a specified format</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt_2 = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Your task is to perform the following actions: </span><br><span class="hljs-string">1 - Summarize the following text delimited by </span><br><span class="hljs-string">  &lt;&gt; with 1 sentence.</span><br><span class="hljs-string">2 - Translate the summary into French.</span><br><span class="hljs-string">3 - List each name in the French summary.</span><br><span class="hljs-string">4 - Output a json object that contains the </span><br><span class="hljs-string">  following keys: french_summary, num_names.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Use the following format:</span><br><span class="hljs-string">Text: &lt;text to summarize&gt;</span><br><span class="hljs-string">Summary: &lt;summary&gt;</span><br><span class="hljs-string">Translation: &lt;summary translation&gt;</span><br><span class="hljs-string">Names: &lt;list of names in summary&gt;</span><br><span class="hljs-string">Output JSON: &lt;json with summary and num_names&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Text: &lt;<span class="hljs-subst">&#123;text&#125;</span>&gt;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt_2)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\\nCompletion for prompt 2:&quot;</span>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li><strong>Instructing the model to work out its own solutionfirst</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Your task is to determine if the student&#x27;s solution \\</span><br><span class="hljs-string">is correct or not.</span><br><span class="hljs-string">To solve the problem do the following:</span><br><span class="hljs-string">- First, work out your own solution to the problem including the final total. </span><br><span class="hljs-string">- Then compare your solution to the student&#x27;s solution \\ </span><br><span class="hljs-string">and evaluate if the student&#x27;s solution is correct or not. </span><br><span class="hljs-string">Don&#x27;t decide if the student&#x27;s solution is correct until </span><br><span class="hljs-string">you have done the problem yourself.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Use the following format:</span><br><span class="hljs-string">Question:</span><br></code></pre></td></tr></table></figure><p>question here</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">Student<span class="hljs-symbol">&#x27;s</span> solution:<br></code></pre></td></tr></table></figure><p>student's solution here</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">Actual solution</span><span class="hljs-punctuation">:</span><br></code></pre></td></tr></table></figure><p>steps to work out the solution and your solution here</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-built_in">Is</span> the student<span class="hljs-comment">&#x27;s solution the same as actual solution \\</span><br>just calculated:<br></code></pre></td></tr></table></figure><p>yes or no</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">Student grade</span><span class="hljs-punctuation">:</span><br></code></pre></td></tr></table></figure><p>correct or incorrect</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Question:</span><br></code></pre></td></tr></table></figure><p>I'm building a solar power installation and I need help Â working outthe financials.</p><ul><li>Land costs $100 / square foot</li><li>I can buy solar panels for $250 / square foot</li><li>I negotiated a contract for maintenance that will cost Â me a flat$100k per year, and an additional $10 / square Â foot What is the totalcost for the first year of operations Â as a function of the number ofsquare feet.</li></ul><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">Student<span class="hljs-symbol">&#x27;s</span> solution:<br></code></pre></td></tr></table></figure><p>Let x be the size of the installation in square feet. Costs:</p><ol type="1"><li>Land cost: 100x</li><li>Solar panel cost: 250x</li><li>Maintenance cost: 100,000 + 100x Total cost: 100x + 250x + 100,000 +100x = 450x + 100,000</li></ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim">Actual solution:<br><span class="hljs-string">&quot;&quot;</span><span class="hljs-comment">&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-keyword">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li>Iterative</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># original</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Your task is to help a marketing team create a </span><br><span class="hljs-string">description for a retail website of a product based </span><br><span class="hljs-string">on a technical fact sheet.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Write a product description based on the information </span><br><span class="hljs-string">provided in the technical specifications delimited by </span><br><span class="hljs-string">triple backticks.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Technical specifications: ```<span class="hljs-subst">&#123;fact_sheet_chair&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># The text is too long</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Your task is to help a marketing team create a </span><br><span class="hljs-string">description for a retail website of a product based </span><br><span class="hljs-string">on a technical fact sheet.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Write a product description based on the information </span><br><span class="hljs-string">provided in the technical specifications delimited by </span><br><span class="hljs-string">triple backticks.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Use at most 50 words.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Technical specifications: ```<span class="hljs-subst">&#123;fact_sheet_chair&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># Text focuses on the wrong details</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Your task is to help a marketing team create a </span><br><span class="hljs-string">description for a retail website of a product based </span><br><span class="hljs-string">on a technical fact sheet.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Write a product description based on the information </span><br><span class="hljs-string">provided in the technical specifications delimited by </span><br><span class="hljs-string">triple backticks.</span><br><span class="hljs-string"></span><br><span class="hljs-string">The description is intended for furniture retailers, </span><br><span class="hljs-string">so should be technical in nature and focus on the </span><br><span class="hljs-string">materials the product is constructed from.</span><br><span class="hljs-string"></span><br><span class="hljs-string">At the end of the description, include every 7-character </span><br><span class="hljs-string">Product ID in the technical specification.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Use at most 50 words.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Technical specifications: ```<span class="hljs-subst">&#123;fact_sheet_chair&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># Description needs a table of dimensions</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Your task is to help a marketing team create a </span><br><span class="hljs-string">description for a retail website of a product based </span><br><span class="hljs-string">on a technical fact sheet.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Write a product description based on the information </span><br><span class="hljs-string">provided in the technical specifications delimited by </span><br><span class="hljs-string">triple backticks.</span><br><span class="hljs-string"></span><br><span class="hljs-string">The description is intended for furniture retailers, </span><br><span class="hljs-string">so should be technical in nature and focus on the </span><br><span class="hljs-string">materials the product is constructed from.</span><br><span class="hljs-string"></span><br><span class="hljs-string">At the end of the description, include every 7-character </span><br><span class="hljs-string">Product ID in the technical specification.</span><br><span class="hljs-string"></span><br><span class="hljs-string">After the description, include a table that gives the </span><br><span class="hljs-string">product&#x27;s dimensions. The table should have two columns.</span><br><span class="hljs-string">In the first column include the name of the dimension. </span><br><span class="hljs-string">In the second column include the measurements in inches only.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Give the table the title &#x27;Product Dimensions&#x27;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Format everything as HTML that can be used in a website. </span><br><span class="hljs-string">Place the description in a &lt;div&gt; element.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Technical specifications: ```<span class="hljs-subst">&#123;fact_sheet_chair&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># To view HTML</span><br><span class="hljs-keyword">from</span> IPython.display <span class="hljs-keyword">import</span> display, HTML<br>display(HTML(response))<br></code></pre></td></tr></table></figure><ul><li>Summarizing</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Summarize with a focus on price and value</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Your task is to generate a short summary of a product \\</span><br><span class="hljs-string">review from an ecommerce site to give feedback to the \\</span><br><span class="hljs-string">pricing deparmtment, responsible for determining the \\</span><br><span class="hljs-string">price of the product.  </span><br><span class="hljs-string"></span><br><span class="hljs-string">Summarize the review below, delimited by triple </span><br><span class="hljs-string">backticks, in at most 30 words, and focusing on any aspects \\</span><br><span class="hljs-string">that are relevant to the price and perceived value. </span><br><span class="hljs-string"></span><br><span class="hljs-string">Review: ```<span class="hljs-subst">&#123;prod_review&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># Summarize multiple product reviews</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(reviews)):<br>    prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">    Your task is to generate a short summary of a product \\ </span><br><span class="hljs-string">    review from an ecommerce site. </span><br><span class="hljs-string"></span><br><span class="hljs-string">    Summarize the review below, delimited by triple \\</span><br><span class="hljs-string">    backticks in at most 20 words. </span><br><span class="hljs-string"></span><br><span class="hljs-string">    Review: ```<span class="hljs-subst">&#123;reviews[i]&#125;</span>```</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    response = get_completion(prompt)<br>    <span class="hljs-built_in">print</span>(i, response, <span class="hljs-string">&quot;\\n&quot;</span>)<br></code></pre></td></tr></table></figure><ul><li>Inferring</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Sentiment (positive/negative)</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">What is the sentiment of the following product review, </span><br><span class="hljs-string">which is delimited with triple backticks?</span><br><span class="hljs-string"></span><br><span class="hljs-string">Give your answer as a single word, either &quot;positive&quot; \\</span><br><span class="hljs-string">or &quot;negative&quot;.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Review text: &#x27;&#x27;&#x27;<span class="hljs-subst">&#123;lamp_review&#125;</span>&#x27;&#x27;&#x27;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># Identify types of emotions</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Identify a list of emotions that the writer of the \\</span><br><span class="hljs-string">following review is expressing. Include no more than \\</span><br><span class="hljs-string">five items in the list. Format your answer as a list of \\</span><br><span class="hljs-string">lower-case words separated by commas.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Review text: &#x27;&#x27;&#x27;<span class="hljs-subst">&#123;lamp_review&#125;</span>&#x27;&#x27;&#x27;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># Identify anger</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Is the writer of the following review expressing anger?\\</span><br><span class="hljs-string">The review is delimited with triple backticks. \\</span><br><span class="hljs-string">Give your answer as either yes or no.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Review text: &#x27;&#x27;&#x27;<span class="hljs-subst">&#123;lamp_review&#125;</span>&#x27;&#x27;&#x27;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># Doing multiple tasks at once</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Identify the following items from the review text: </span><br><span class="hljs-string">- Sentiment (positive or negative)</span><br><span class="hljs-string">- Is the reviewer expressing anger? (true or false)</span><br><span class="hljs-string">- Item purchased by reviewer</span><br><span class="hljs-string">- Company that made the item</span><br><span class="hljs-string"></span><br><span class="hljs-string">The review is delimited with triple backticks. \\</span><br><span class="hljs-string">Format your response as a JSON object with \\</span><br><span class="hljs-string">&quot;Sentiment&quot;, &quot;Anger&quot;, &quot;Item&quot; and &quot;Brand&quot; as the keys.</span><br><span class="hljs-string">If the information isn&#x27;t present, use &quot;unknown&quot; \\</span><br><span class="hljs-string">as the value.</span><br><span class="hljs-string">Make your response as short as possible.</span><br><span class="hljs-string">Format the Anger value as a boolean.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Review text: &#x27;&#x27;&#x27;<span class="hljs-subst">&#123;lamp_review&#125;</span>&#x27;&#x27;&#x27;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># Infer 5 topics</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Determine five topics that are being discussed in the \\</span><br><span class="hljs-string">following text, which is delimited by triple backticks.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Make each item one or two words long. </span><br><span class="hljs-string"></span><br><span class="hljs-string">Format your response as a list of items separated by commas.</span><br><span class="hljs-string"></span><br><span class="hljs-string">Text sample: &#x27;&#x27;&#x27;<span class="hljs-subst">&#123;story&#125;</span>&#x27;&#x27;&#x27;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li>Transforming</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Tone Transformation</span><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Translate the following from slang to a business letter: </span><br><span class="hljs-string">&#x27;Dude, This is Joe, check out this spec on this standing lamp.&#x27;</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># Format Conversion</span><br>data_json = &#123; <span class="hljs-string">&quot;resturant employees&quot;</span> :[ <br>    &#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;Shyam&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>:<span class="hljs-string">&quot;shyamjaiswal@gmail.com&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>:<span class="hljs-string">&quot;bob32@gmail.com&quot;</span>&#125;,<br>    &#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;Jai&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>:<span class="hljs-string">&quot;jai87@gmail.com&quot;</span>&#125;<br>]&#125;<br><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">Translate the following python dictionary from JSON to an HTML \\</span><br><span class="hljs-string">table with column headers and title: <span class="hljs-subst">&#123;data_json&#125;</span></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-keyword">from</span> IPython.display <span class="hljs-keyword">import</span> display, Markdown, Latex, HTML, JSON<br>display(HTML(response))<br><br><span class="hljs-comment"># Spellcheck/Grammar check</span><br>text = [ <br>  <span class="hljs-string">&quot;The girl with the black and white puppies have a ball.&quot;</span>,  <span class="hljs-comment"># The girl has a ball.</span><br>  <span class="hljs-string">&quot;Yolanda has her notebook.&quot;</span>, <span class="hljs-comment"># ok</span><br>  <span class="hljs-string">&quot;Its going to be a long day. Does the car need itâ€™s oil changed?&quot;</span>,  <span class="hljs-comment"># Homonyms</span><br>  <span class="hljs-string">&quot;Their goes my freedom. There going to bring theyâ€™re suitcases.&quot;</span>,  <span class="hljs-comment"># Homonyms</span><br>  <span class="hljs-string">&quot;Your going to need youâ€™re notebook.&quot;</span>,  <span class="hljs-comment"># Homonyms</span><br>  <span class="hljs-string">&quot;That medicine effects my ability to sleep. Have you heard of the butterfly affect?&quot;</span>, <span class="hljs-comment"># Homonyms</span><br>  <span class="hljs-string">&quot;This phrase is to cherck chatGPT for speling abilitty&quot;</span>  <span class="hljs-comment"># spelling</span><br>]<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> text:<br>    prompt = <span class="hljs-string">f&quot;&quot;&quot;Proofread and correct the following text</span><br><span class="hljs-string">    and rewrite the corrected version. If you don&#x27;t find</span><br><span class="hljs-string">    and errors, just say &quot;No errors found&quot;. Don&#x27;t use </span><br><span class="hljs-string">    any punctuation around the text:</span><br><span class="hljs-string">    ```<span class="hljs-subst">&#123;t&#125;</span>```&quot;&quot;&quot;</span><br>    response = get_completion(prompt)<br>    <span class="hljs-built_in">print</span>(response)<br>    <br><span class="hljs-keyword">from</span> redlines <span class="hljs-keyword">import</span> Redlines<br>diff = Redlines(text,response)<br>display(Markdown(diff.output_markdown))<br><br>prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">proofread and correct this review. Make it more compelling. </span><br><span class="hljs-string">Ensure it follows APA style guide and targets an advanced reader. </span><br><span class="hljs-string">Output in markdown format.</span><br><span class="hljs-string">Text: ```<span class="hljs-subst">&#123;text&#125;</span>```</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt)<br>display(Markdown(response))<br></code></pre></td></tr></table></figure><ul><li>Expanding</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">prompt = <span class="hljs-string">f&quot;&quot;&quot;</span><br><span class="hljs-string">You are a customer service AI assistant.</span><br><span class="hljs-string">Your task is to send an email reply to a valued customer.</span><br><span class="hljs-string">Given the customer email delimited by ```, \\</span><br><span class="hljs-string">Generate a reply to thank the customer for their review.</span><br><span class="hljs-string">If the sentiment is positive or neutral, thank them for \\</span><br><span class="hljs-string">their review.</span><br><span class="hljs-string">If the sentiment is negative, apologize and suggest that \\</span><br><span class="hljs-string">they can reach out to customer service. </span><br><span class="hljs-string">Make sure to use specific details from the review.</span><br><span class="hljs-string">Write in a concise and professional tone.</span><br><span class="hljs-string">Sign the email as `AI customer agent`.</span><br><span class="hljs-string">Customer review: ```<span class="hljs-subst">&#123;review&#125;</span>```</span><br><span class="hljs-string">Review sentiment: <span class="hljs-subst">&#123;sentiment&#125;</span></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>response = get_completion(prompt, temperature=<span class="hljs-number">0.7</span>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure><ul><li>Chatbot</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_completion</span>(<span class="hljs-params">prompt, model=<span class="hljs-string">&quot;gpt-3.5-turbo&quot;</span></span>):<br>    messages = [&#123;<span class="hljs-string">&quot;role&quot;</span>: <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>: prompt&#125;]<br>    response = openai.ChatCompletion.create(<br>        model=model,<br>        messages=messages,<br>        temperature=<span class="hljs-number">0</span>, <span class="hljs-comment"># this is the degree of randomness of the model&#x27;s output</span><br>    )<br>    <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message[<span class="hljs-string">&quot;content&quot;</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_completion_from_messages</span>(<span class="hljs-params">messages, model=<span class="hljs-string">&quot;gpt-3.5-turbo&quot;</span>, temperature=<span class="hljs-number">0</span></span>):<br>    response = openai.ChatCompletion.create(<br>        model=model,<br>        messages=messages,<br>        temperature=temperature, <span class="hljs-comment"># this is the degree of randomness of the model&#x27;s output</span><br>    )<br>    <span class="hljs-comment"># print(str(response.choices[0].message))</span><br>    <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message[<span class="hljs-string">&quot;content&quot;</span>]<br>    <br>messages =  [  <br>&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;content&#x27;</span>:<span class="hljs-string">&#x27;You are friendly chatbot.&#x27;</span>&#125;,<br>&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;content&#x27;</span>:<span class="hljs-string">&#x27;Hi, my name is Isa&#x27;</span>&#125;,<br>&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;assistant&#x27;</span>, <span class="hljs-string">&#x27;content&#x27;</span>: <span class="hljs-string">&quot;Hi Isa! It&#x27;s nice to meet you. \\</span><br><span class="hljs-string">Is there anything I can help you with today?&quot;</span>&#125;,<br>&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;content&#x27;</span>:<span class="hljs-string">&#x27;Yes, you can remind me, What is my name?&#x27;</span>&#125;  ]<br>response = get_completion_from_messages(messages, temperature=<span class="hljs-number">1</span>)<br><span class="hljs-built_in">print</span>(response)<br><br><span class="hljs-comment"># OrderBot</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">collect_messages</span>(<span class="hljs-params">_</span>):<br>    prompt = inp.value_input<br>    inp.value = <span class="hljs-string">&#x27;&#x27;</span><br>    context.append(&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;content&#x27;</span>:<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;prompt&#125;</span>&quot;</span>&#125;)<br>    response = get_completion_from_messages(context) <br>    context.append(&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;assistant&#x27;</span>, <span class="hljs-string">&#x27;content&#x27;</span>:<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;response&#125;</span>&quot;</span>&#125;)<br>    panels.append(<br>        pn.Row(<span class="hljs-string">&#x27;User:&#x27;</span>, pn.pane.Markdown(prompt, width=<span class="hljs-number">600</span>)))<br>    panels.append(<br>        pn.Row(<span class="hljs-string">&#x27;Assistant:&#x27;</span>, pn.pane.Markdown(response, width=<span class="hljs-number">600</span>, style=&#123;<span class="hljs-string">&#x27;background-color&#x27;</span>: <span class="hljs-string">&#x27;#F6F6F6&#x27;</span>&#125;)))<br> <br>    <span class="hljs-keyword">return</span> pn.Column(*panels)<br>    <br><span class="hljs-keyword">import</span> panel <span class="hljs-keyword">as</span> pn  <span class="hljs-comment"># GUI</span><br>pn.extension()<br><br>panels = [] <span class="hljs-comment"># collect display </span><br><br>context = [ &#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;content&#x27;</span>:<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">You are OrderBot, an automated service to collect orders for a pizza restaurant. \\</span><br><span class="hljs-string">You first greet the customer, then collects the order, \\</span><br><span class="hljs-string">and then asks if it&#x27;s a pickup or delivery. \\</span><br><span class="hljs-string">You wait to collect the entire order, then summarize it and check for a final \\</span><br><span class="hljs-string">time if the customer wants to add anything else. \\</span><br><span class="hljs-string">If it&#x27;s a delivery, you ask for an address. \\</span><br><span class="hljs-string">Finally you collect the payment.\\</span><br><span class="hljs-string">Make sure to clarify all options, extras and sizes to uniquely \\</span><br><span class="hljs-string">identify the item from the menu.\\</span><br><span class="hljs-string">You respond in a short, very conversational friendly style. \\</span><br><span class="hljs-string">The menu includes \\</span><br><span class="hljs-string">pepperoni pizza  12.95, 10.00, 7.00 \\</span><br><span class="hljs-string">cheese pizza   10.95, 9.25, 6.50 \\</span><br><span class="hljs-string">eggplant pizza   11.95, 9.75, 6.75 \\</span><br><span class="hljs-string">fries 4.50, 3.50 \\</span><br><span class="hljs-string">greek salad 7.25 \\</span><br><span class="hljs-string">Toppings: \\</span><br><span class="hljs-string">extra cheese 2.00, \\</span><br><span class="hljs-string">mushrooms 1.50 \\</span><br><span class="hljs-string">sausage 3.00 \\</span><br><span class="hljs-string">canadian bacon 3.50 \\</span><br><span class="hljs-string">AI sauce 1.50 \\</span><br><span class="hljs-string">peppers 1.00 \\</span><br><span class="hljs-string">Drinks: \\</span><br><span class="hljs-string">coke 3.00, 2.00, 1.00 \\</span><br><span class="hljs-string">sprite 3.00, 2.00, 1.00 \\</span><br><span class="hljs-string">bottled water 5.00 \\</span><br><span class="hljs-string">&quot;&quot;&quot;</span>&#125; ]  <span class="hljs-comment"># accumulate messages</span><br><br>inp = pn.widgets.TextInput(value=<span class="hljs-string">&quot;Hi&quot;</span>, placeholder=<span class="hljs-string">&#x27;Enter text hereâ€¦&#x27;</span>)<br>button_conversation = pn.widgets.Button(name=<span class="hljs-string">&quot;Chat!&quot;</span>)<br><br>interactive_conversation = pn.bind(collect_messages, button_conversation)<br><br>dashboard = pn.Column(<br>    inp,<br>    pn.Row(button_conversation),<br>    pn.panel(interactive_conversation, loading_indicator=<span class="hljs-literal">True</span>, height=<span class="hljs-number">300</span>),<br>)<br><br>dashboard<br>messages =  context.copy()<br>messages.append(<br>&#123;<span class="hljs-string">&#x27;role&#x27;</span>:<span class="hljs-string">&#x27;system&#x27;</span>, <span class="hljs-string">&#x27;content&#x27;</span>:<span class="hljs-string">&#x27;create a json summary of the previous food order. Itemize the price for each item\\</span><br><span class="hljs-string"> The fields should be 1) pizza, include size 2) list of toppings 3) list of drinks, include size   4) list of sides include size  5)total price &#x27;</span>&#125;,    <br>)<br> <span class="hljs-comment">#The fields should be 1) pizza, price 2) list of toppings 3) list of drinks, include size include price  4) list of sides include size include price, 5)total price &#x27;&#125;,    </span><br><br>response = get_completion_from_messages(messages, temperature=<span class="hljs-number">0</span>)<br><span class="hljs-built_in">print</span>(response)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>LLM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pytorch Distributed</title>
    <link href="/2024/01/21/Pytorch%20Distributed/"/>
    <url>/2024/01/21/Pytorch%20Distributed/</url>
    
    <content type="html"><![CDATA[<ul><li>nn.DataParallel</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset, DataLoader<br><br>input_size = <span class="hljs-number">5</span><br>output_size = <span class="hljs-number">2</span><br>batch_size = <span class="hljs-number">30</span><br>data_size = <span class="hljs-number">100</span><br>device = torch.device(<span class="hljs-string">&#x27;cuda:0&#x27;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;cpu&#x27;</span>) <br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, size, length</span>):<br>        self.<span class="hljs-built_in">len</span> = length<br>        <span class="hljs-comment"># 100*5</span><br>        self.data = torch.randn(length, size)<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, index</span>):<br>        <span class="hljs-comment"># (5, )</span><br>        <span class="hljs-keyword">return</span> self.data[index]<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-comment"># 100</span><br>        <span class="hljs-keyword">return</span> self.<span class="hljs-built_in">len</span><br><br>rand_loader = DataLoader(dataset=RandomDataset(input_size, data_size),<br>                         batch_size=batch_size, <br>                         shuffle=<span class="hljs-literal">True</span>)<br><span class="hljs-built_in">next</span>(<span class="hljs-built_in">iter</span>(rand_loader)).shape  <span class="hljs-comment"># torch.Size([30, 5])</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, input_size, output_size</span>):<br>        <span class="hljs-comment"># 5 =&gt; 2</span><br>        <span class="hljs-built_in">super</span>(Model, self).__init__()<br>        self.fc = nn.Linear(input_size, output_size)<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, <span class="hljs-built_in">input</span></span>):<br>        output = self.fc(<span class="hljs-built_in">input</span>)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;\\tIn Model: input size&quot;</span>, <span class="hljs-built_in">input</span>.size(),  <span class="hljs-comment"># æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šprint</span><br>              <span class="hljs-string">&quot;output size&quot;</span>, output.size())<br>        <span class="hljs-keyword">return</span> output<br>        <br>model = Model(input_size, output_size)<br><span class="hljs-keyword">if</span> torch.cuda.device_count() &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Let&#x27;s use&quot;</span>, torch.cuda.device_count(), <span class="hljs-string">&quot;GPUs!&quot;</span>)<br>    <span class="hljs-comment"># dim = 0 [30, xxx] -&gt; [10, ...], [10, ...], [10, ...] on 3 GPUs</span><br>    model = nn.DataParallel(model)<br><span class="hljs-built_in">print</span>(model)<br><span class="hljs-comment"># DataParallel(</span><br><span class="hljs-comment">#   (module): Model(</span><br><span class="hljs-comment">#     (fc): Linear(in_features=5, out_features=2, bias=True)</span><br><span class="hljs-comment">#   )</span><br><span class="hljs-comment"># )</span><br><br><span class="hljs-comment"># tensor: to(device)</span><br>a = torch.randn(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;a.is_cuda&#x27;</span>, a.is_cuda)  <span class="hljs-comment"># False</span><br>b = a.to(<span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;a.is_cuda&#x27;</span>, a.is_cuda)  <span class="hljs-comment"># False</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;b.is_cuda&#x27;</span>, b.is_cuda)  <span class="hljs-comment"># True</span><br><br><span class="hljs-comment"># model: to(device)</span><br>a = Model(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(a.parameters()).is_cuda)  <span class="hljs-comment"># False</span><br>b = a.to(<span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(a.parameters()).is_cuda)  <span class="hljs-comment"># True</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(b.parameters()).is_cuda)  <span class="hljs-comment"># True</span><br><br><span class="hljs-keyword">for</span> data <span class="hljs-keyword">in</span> rand_loader:<br>    <span class="hljs-built_in">input</span> = data.to(device)<br>    output = model(<span class="hljs-built_in">input</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Outside: input size&quot;</span>, <span class="hljs-built_in">input</span>.size(),<br>          <span class="hljs-string">&quot;output_size&quot;</span>, output.size())<br>          <br><span class="hljs-comment"># In Model: input size torch.Size([15, 5]) output size torch.Size([15, 2])</span><br><span class="hljs-comment"># In Model: input size torch.Size([15, 5]) output size torch.Size([15, 2])</span><br><span class="hljs-comment"># Outside: input size torch.Size([30, 5]) output_size torch.Size([30, 2])</span><br><span class="hljs-comment"># In Model: input size torch.Size([15, 5]) output size torch.Size([15, 2])</span><br><span class="hljs-comment"># In Model: input size torch.Size([15, 5]) output size torch.Size([15, 2])</span><br><span class="hljs-comment"># Outside: input size torch.Size([30, 5]) output_size torch.Size([30, 2])</span><br></code></pre></td></tr></table></figure><ul><li>åˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œæ—¶ï¼Œæ¨¡å‹ï¼ˆmodel parametersï¼‰/ä¼˜åŒ–å™¨ï¼ˆoptimizerstatesï¼‰æ¯å¼ å¡éƒ½ä¼šæ‹·è´ä¸€ä»½ï¼ˆreplicasï¼‰<ul><li>DDPå§‹ç»ˆåœ¨å¡é—´ç»´æŒç€æ¨¡å‹å‚æ•°å’Œä¼˜åŒ–å™¨çŠ¶æ€çš„åŒæ­¥ä¸€è‡´æ€§åœ¨æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹ä¸­</li></ul></li><li>Data Parallelï¼Œbatch inputï¼Œé€šè¿‡ <strong>DistributedSampler</strong>split &amp; åˆ†å‘åˆ°ä¸åŒçš„ gpus ä¸Š<ul><li>æ­¤æ—¶è™½ç„¶æ¨¡å‹/optimizer ç›¸åŒï¼Œä½†å› ä¸ºæ•°æ®è¾“å…¥ä¸åŒï¼Œå¯¼è‡´ lossä¸åŒï¼Œåå‘ä¼ æ’­æ—¶è®¡ç®—åˆ°çš„æ¢¯åº¦ä¹Ÿä¼šä¸åŒ</li><li>æ­¤æ—¶ ddp å¦‚ä½•ä¿è¯å¡é—´ï¼Œmodel/optimizer çš„åŒæ­¥ä¸€è‡´æ€§å‘¢<ul><li>ring all-reduce algorithmå…¶åŒæ­¥è¿‡ç¨‹ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰çš„å¡éƒ½è®¡ç®—å®Œæˆä¸€è½®æ¢¯åº¦</li></ul></li></ul></li><li>worldï¼Œworld_sizeï¼š<ul><li>worldï¼šas a group containing all the processes for your distributedtraining.<ul><li>é€šå¸¸ï¼Œæ¯ä¸€ä¸ª gpu ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹ï¼ˆprocessï¼‰</li><li>world å†…çš„ process å¯ä»¥å½¼æ­¤é€šä¿¡ï¼Œæ‰€ä»¥æœ‰ ddp åˆ†å¸ƒå¼è®­ç»ƒçš„ï¼›</li></ul></li></ul></li><li>rank<ul><li>rank: is the unique ID given to a process, è¿›ç¨‹çº§åˆ«çš„æ¦‚å¿µï¼Œrankæ˜¯ä¸ºäº†æ ‡è¯†ã€è¯†åˆ«è¿›ç¨‹ï¼Œå› ä¸ºè¿›ç¨‹é—´ï¼ˆprocessï¼‰éœ€è¦é€šä¿¡ï¼›</li><li>local rankï¼šis the a unique local ID for processes running in asingle node</li></ul></li><li>node ç†è§£ä¸ºä¸€ä¸ªserverï¼Œ2ä¸ªserversï¼ˆå¤šæœºï¼Œæœºå™¨ä¹‹é—´éœ€è¦é€šä¿¡ï¼‰å°±æ˜¯2ä¸ªnodes<ul><li>æ¯”å¦‚æ¯ä¸ª node/server/machine å„æœ‰4å¼ å¡ï¼ˆ4 gpusï¼‰ï¼Œä¸€ä¸ª 2ä¸ªnode/serverï¼›</li><li>world_size: 2*4 == 8</li><li>ranks: [0, 1, 2, 3, 4, 5, 6, 7]</li><li>local_rank: [0, 1, 2, 3], [0, 1, 2, 3]</li></ul></li><li>An example for setup</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ddp_setup</span>(<span class="hljs-params">rank, world_size</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        rank: Unique identifier of each process</span><br><span class="hljs-string">        world_size: Total number of processes</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    os.environ[<span class="hljs-string">&quot;MASTER_ADDR&quot;</span>] = <span class="hljs-string">&quot;localhost&quot;</span><br>    os.environ[<span class="hljs-string">&quot;MASTER_PORT&quot;</span>] = <span class="hljs-string">&quot;12355&quot;</span><br>    init_process_group(backend=<span class="hljs-string">&quot;nccl&quot;</span>, rank=rank, world_size=world_size)<br>    torch.cuda.set_device(rank)<br>    <br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> torch.distributed.is_initialized():<br>    torch.distributed.init_process_group(<span class="hljs-string">&quot;nccl&quot;</span>)<br><span class="hljs-comment"># torchrun --nproc_per_node çš„å‚æ•°</span><br>model_parallel_size = <span class="hljs-built_in">int</span>(os.environ.get(<span class="hljs-string">&quot;WORLD_SIZE&quot;</span>, <span class="hljs-number">1</span>))<br>local_rank = <span class="hljs-built_in">int</span>(os.environ.get(<span class="hljs-string">&quot;LOCAL_RANK&quot;</span>, <span class="hljs-number">0</span>))<br>torch.cuda.set_device(local_rank)<br></code></pre></td></tr></table></figure><ul><li>nn.parallel.DistributedDataParallel</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset, DataLoader<br><span class="hljs-comment"># custom trainer</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trainer</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, </span><br><span class="hljs-params">                 model: torch.nn.Module, </span><br><span class="hljs-params">                 train_dataloader: DataLoader, </span><br><span class="hljs-params">                 optimizer: torch.optim.Optimizer, </span><br><span class="hljs-params">                 gpu_id: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># rank</span><br>        self.gpu_id = gpu_id<br>        self.model = model.to(gpu_id)<br>        self.train_dataloader = train_dataloader<br>        self.optimizer = optimizer<br>        self.model = DDP(model, device_ids=[gpu_id])<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_run_batch</span>(<span class="hljs-params">self, xs, ys</span>):<br>        self.optimizer.zero_grad()<br>        output = self.model(xs)<br>        loss = F.cross_entropy(output, ys)<br>        loss.backward()<br>        self.optimizer.step()<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_run_epoch</span>(<span class="hljs-params">self, epoch</span>):<br>        batch_size = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">next</span>(<span class="hljs-built_in">iter</span>(self.train_dataloader))[<span class="hljs-number">0</span>])<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[GPU: <span class="hljs-subst">&#123;self.gpu_id&#125;</span>] Epoch: <span class="hljs-subst">&#123;epoch&#125;</span> | Batchsize: <span class="hljs-subst">&#123;batch_size&#125;</span> | Steps: <span class="hljs-subst">&#123;<span class="hljs-built_in">len</span>(self.train_dataloader)&#125;</span>&#x27;</span>)<br>        self.train_dataloader.sampler.set_epoch(epoch)<br>        <span class="hljs-keyword">for</span> xs, ys <span class="hljs-keyword">in</span> self.train_dataloader:<br>            xs = xs.to(self.gpu_id)<br>            ys = ys.to(self.gpu_id)<br>            self._run_batch(xs, ys)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">self, max_epoch: <span class="hljs-built_in">int</span></span>):<br>        <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_epoch):<br>            self._run_epoch(epoch)<br>    <br><span class="hljs-comment"># custom dataset</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTrainDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, size</span>):<br>        self.size = size<br>        self.data = [(torch.rand(<span class="hljs-number">20</span>), torch.rand(<span class="hljs-number">1</span>)) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(size)]<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self.size<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, index</span>):<br>        <span class="hljs-keyword">return</span> self.data[index]<br>train_dataset = MyTrainDataset(<span class="hljs-number">2048</span>)<br>train_dataset[<span class="hljs-number">0</span>]<br><span class="hljs-comment"># (tensor([0.4790, 0.5080, 0.1934, 0.5247, 0.6372, 0.9930, 0.2379, 0.9182, 0.3659,</span><br><span class="hljs-comment">#          0.8408, 0.2347, 0.1770, 0.8691, 0.2810, 0.2156, 0.8289, 0.9372, 0.6358,</span><br><span class="hljs-comment">#          0.4338, 0.2754]),</span><br><span class="hljs-comment">#  tensor([0.6307]))</span><br><br><span class="hljs-keyword">import</span> torch.multiprocessing <span class="hljs-keyword">as</span> mp<br><span class="hljs-keyword">from</span> torch.utils.data.distributed <span class="hljs-keyword">import</span> DistributedSampler<br><span class="hljs-keyword">from</span> torch.nn.parallel <span class="hljs-keyword">import</span> DistributedDataParallel <span class="hljs-keyword">as</span> DDP<br><span class="hljs-keyword">from</span> torch.distributed <span class="hljs-keyword">import</span> init_process_group, destroy_process_group<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">rank: <span class="hljs-built_in">int</span>, world_size: <span class="hljs-built_in">int</span>, max_epochs: <span class="hljs-built_in">int</span>, batch_size: <span class="hljs-built_in">int</span></span>):<br>    ddp_setup(rank, world_size)<br>    train_dataset = MyTrainDataset(<span class="hljs-number">2048</span>)<br>    train_dataloader = DataLoader(train_dataset, <br>                              batch_size=batch_size, <br>                              pin_memory=<span class="hljs-literal">True</span>, <br>                              shuffle=<span class="hljs-literal">False</span>, <br>                              <span class="hljs-comment"># batch input: split to each gpus (å„ä¸ª gpu ä¹‹é—´æ²¡æœ‰ overlaping samples)</span><br>                              sampler=DistributedSampler(train_dataset))<br>    model = torch.nn.Linear(<span class="hljs-number">20</span>, <span class="hljs-number">1</span>)<br>    optimzer = torch.optim.SGD(model.parameters(), lr=<span class="hljs-number">1e-3</span>)<br>    trainer = Trainer(model=model, gpu_id=rank, optimizer=optimzer, train_dataloader=train_dataloader)<br>    trainer.train(max_epochs)<br>    destroy_process_group()<br>world_size = torch.cuda.device_count()<br><span class="hljs-comment"># ç›´æ¥è¿è¡Œ</span><br>!python ddp_gpus.py --max_epochs <span class="hljs-number">5</span> --batch_size <span class="hljs-number">32</span>  <span class="hljs-comment"># å¤šå¡</span><br><span class="hljs-comment"># åŒºåˆ«:</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ddp_setup</span>(<span class="hljs-params">rank, world_size</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        rank: Unique identifier of each process</span><br><span class="hljs-string">        world_size: Total number of processes</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># rank 0 process</span><br>    os.environ[<span class="hljs-string">&quot;MASTER_ADDR&quot;</span>] = <span class="hljs-string">&quot;localhost&quot;</span><br>    os.environ[<span class="hljs-string">&quot;MASTER_PORT&quot;</span>] = <span class="hljs-string">&quot;12355&quot;</span><br>    <span class="hljs-comment"># ncclï¼šNVIDIA Collective Communication Library </span><br>    <span class="hljs-comment"># åˆ†å¸ƒå¼æƒ…å†µä¸‹çš„ï¼Œgpus é—´é€šä¿¡</span><br>    init_process_group(backend=<span class="hljs-string">&quot;nccl&quot;</span>, rank=rank, world_size=world_size)<br>    torch.cuda.set_device(rank)<br> <br>world_size = torch.cuda.device_count()<br>mp.spawn(main, args=(world_size, args.max_epochs, args.batch_size), nprocs=world_size)<br><br><span class="hljs-comment"># &lt;https://github.com/chunhuizhang/pytorch_distribute_tutorials/blob/main/tutorials/ddp_gpus.py&gt;</span><br><br><span class="hljs-comment"># torchrunè¿è¡Œ</span><br>!torchrun ddp_gpus_torchrun.py --max_epochs <span class="hljs-number">5</span> --batch_size <span class="hljs-number">32</span>  <span class="hljs-comment"># å•å¡</span><br>!torchrun --nproc-per-node=<span class="hljs-number">2</span> ddp_gpus_torchrun.py --max_epochs <span class="hljs-number">5</span> --batch_size <span class="hljs-number">32</span>  <span class="hljs-comment"># å¤šå¡</span><br>!python -m torch.distributed.launch --use-env --nproc-per-node=<span class="hljs-number">2</span> ddp_gpus_torchrun.py --max_epochs <span class="hljs-number">5</span> --batch_size <span class="hljs-number">32</span>  <span class="hljs-comment"># å¤šå¡, ä¸ä¸Šè¡Œç­‰ä»·</span><br><span class="hljs-comment"># åŒºåˆ«</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ddp_setup</span>():<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        rank: Unique identifier of each process</span><br><span class="hljs-string">        world_size: Total number of processes</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># rank 0 process</span><br>    <span class="hljs-comment"># os.environ[&quot;MASTER_ADDR&quot;] = &quot;localhost&quot;</span><br>    <span class="hljs-comment"># os.environ[&quot;MASTER_PORT&quot;] = &quot;12355&quot;</span><br>    <span class="hljs-comment"># ncclï¼šNVIDIA Collective Communication Library </span><br>    <span class="hljs-comment"># åˆ†å¸ƒå¼æƒ…å†µä¸‹çš„ï¼Œgpus é—´é€šä¿¡</span><br>    init_process_group(backend=<span class="hljs-string">&quot;nccl&quot;</span>)<br>    torch.cuda.set_device(<span class="hljs-built_in">int</span>(os.environ[<span class="hljs-string">&#x27;LOCAL_RANK&#x27;</span>]))<br>    <br><span class="hljs-comment"># world_size = torch.cuda.device_count()</span><br>main(args.max_epochs, args.batch_size)<br><br><span class="hljs-comment"># &lt;https://github.com/chunhuizhang/pytorch_distribute_tutorials/blob/main/tutorials/ddp_gpus_torchrun.py&gt;</span><br></code></pre></td></tr></table></figure><ul><li>model parallel</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> LlamaTokenizer, LlamaForCausalLM, GenerationConfig<br>model = LlamaForCausalLM.from_pretrained(<span class="hljs-string">&quot;decapoda-research/llama-7b-hf&quot;</span>,<br>    load_in_8bit=<span class="hljs-literal">True</span>,<br>    device_map=<span class="hljs-string">&quot;auto&quot;</span>,  <span class="hljs-comment"># &quot;auto&quot;, &quot;balanced&quot;, &quot;balanced_low_0&quot;, &quot;sequential&quot;</span><br>)                       <span class="hljs-comment"># GPU(s) &gt; CPU (RAM) &gt; Disk</span><br><span class="hljs-keyword">for</span> i, para <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(model.named_parameters()):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;i&#125;</span>, \\t <span class="hljs-subst">&#123;para[<span class="hljs-number">1</span>].device&#125;</span> \\t<span class="hljs-subst">&#123;para[<span class="hljs-number">1</span>].dtype&#125;</span>&#x27;</span>)<br>    <br><span class="hljs-comment"># An example on ToyModel</span><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn<br><span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ToyModel</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">super</span>(ToyModel, self).__init__()<br>        self.net1 = torch.nn.Linear(<span class="hljs-number">10000</span>, <span class="hljs-number">10</span>).to(<span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br>        self.relu = torch.nn.ReLU()<br>        self.net2 = torch.nn.Linear(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>).to(<span class="hljs-string">&#x27;cuda:1&#x27;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.relu(self.net1(x.to(<span class="hljs-string">&#x27;cuda:0&#x27;</span>)))<br>        <span class="hljs-keyword">return</span> self.net2(x.to(<span class="hljs-string">&#x27;cuda:1&#x27;</span>))<br><br>model = ToyModel()<br>loss_fn = nn.MSELoss()<br>optimizer = optim.SGD(model.parameters(), lr=<span class="hljs-number">0.001</span>)<br>optimizer.zero_grad()<br>outputs = model(torch.randn(<span class="hljs-number">20</span>, <span class="hljs-number">10000</span>))<br>labels = torch.randn(<span class="hljs-number">20</span>, <span class="hljs-number">5</span>).to(<span class="hljs-string">&#x27;cuda:1&#x27;</span>)<br>loss_fn(outputs, labels).backward()<br>optimizer.step()<br><br><span class="hljs-comment"># An example on ResNet</span><br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn<br><span class="hljs-keyword">from</span> torchvision.models.resnet <span class="hljs-keyword">import</span> ResNet, Bottleneck<br><span class="hljs-comment"># from torchvision.models.resnet import resnet18, resnet34, resnet50, resnet101, resnet152</span><br>model = ResNet(Bottleneck, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>])  <span class="hljs-comment"># resnet50</span><br><span class="hljs-keyword">from</span> torchsummary <span class="hljs-keyword">import</span> summary<br>summary(model, input_size=(<span class="hljs-number">3</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>), device=<span class="hljs-string">&#x27;cpu&#x27;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelParallelResNet50</span>(<span class="hljs-title class_ inherited__">ResNet</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_classes=<span class="hljs-number">1000</span></span>):<br>        <span class="hljs-built_in">super</span>().__init__(Bottleneck, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>], num_classes=num_classes)<br>        <span class="hljs-comment"># conv1 =&gt; bn1 =&gt; relu =&gt; maxpool =&gt; layer1-layer4 =&gt; avgpool =&gt; fc</span><br>        self.seq1 = nn.Sequential(<br>            self.conv1,<br>            self.bn1,<br>            self.relu,<br>            self.maxpool,<br>            self.layer1, <br>            self.layer2<br>        ).to(<span class="hljs-string">&#x27;cuda:0&#x27;</span>)<br>        <br>        self.seq2 = nn.Sequential(<br>            self.layer3, <br>            self.layer4,<br>            self.avgpool,<br>        ).to(<span class="hljs-string">&#x27;cuda:1&#x27;</span>)<br>        <br>        self.fc.to(<span class="hljs-string">&#x27;cuda:1&#x27;</span>)<br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = self.seq2(self.seq1(x).to(<span class="hljs-string">&#x27;cuda:1&#x27;</span>))<br>        <span class="hljs-keyword">return</span> self.fc(x.view(x.size(<span class="hljs-number">0</span>), -<span class="hljs-number">1</span>))<br>        <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">model_size</span>(<span class="hljs-params">model</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>([para.numel() <span class="hljs-keyword">for</span> para <span class="hljs-keyword">in</span> model.parameters()])<br><br>one_hot_indices = torch.LongTensor(<span class="hljs-number">5</span>) \\<br>                           .random_(<span class="hljs-number">0</span>, num_classes) \\<br>                           .view(<span class="hljs-number">5</span>, <span class="hljs-number">1</span>)<br>labels = torch.zeros(<span class="hljs-number">5</span>, num_classes) \\<br>                      .scatter_(<span class="hljs-number">1</span>, one_hot_indices, <span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>DDP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LLM Basics</title>
    <link href="/2024/01/10/LLM%20Basics/"/>
    <url>/2024/01/10/LLM%20Basics/</url>
    
    <content type="html"><![CDATA[<ul><li>åŸºæœ¬é…ç½®</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python">!pip install -q bitsandbytes datasets accelerate loralib<br>!pip install -q git+https://github.com/huggingface/transformers.git@main  <span class="hljs-comment"># æºç å®‰è£…</span><br>!pip install -q git+https://github.com/huggingface/peft.git<br><br>AutoConfig.from_pretrained(<span class="hljs-string">&quot;bigscience/bloom-7b1&quot;</span>)<br>AutoConfig  <span class="hljs-comment"># æŸ¥çœ‹æ¨¡å‹é…ç½®</span><br><br><span class="hljs-built_in">list</span>(model.parameters())[<span class="hljs-number">0</span>].dtype  <span class="hljs-comment"># æŸ¥çœ‹æ¨¡å‹å‚æ•°ç±»å‹</span><br><br><span class="hljs-keyword">for</span> i, param <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(model.parameters()):<br>    param.requires_grad = <span class="hljs-literal">False</span>  <span class="hljs-comment"># freeze the model - train adapters later</span><br>    <span class="hljs-keyword">if</span> param.ndim == <span class="hljs-number">1</span>:<br>        <span class="hljs-comment"># cast the small parameters (e.g. layernorm) to fp32 for stability</span><br>        param.data = param.data.to(torch.float32)  <span class="hljs-comment"># å¢åŠ ç²¾åº¦, è®­ç»ƒæ›´ç¨³å®š</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CastOutputToFloat</span>(nn.Sequential):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>): <br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().forward(x).to(torch.float32)<br>model.lm_head = CastOutputToFloat(model.lm_head)  <span class="hljs-comment"># å¢åŠ ç²¾åº¦, è®­ç»ƒæ›´ç¨³å®š</span><br><br>model.gradient_checkpointing_enable()  <span class="hljs-comment"># å‡å°‘å†…å­˜ä½¿ç”¨</span><br>model.enable_input_require_grads()  <span class="hljs-comment"># ä¼šè®¡ç®—æ¨¡å‹è¾“å…¥çš„æ¢¯åº¦</span><br><br><span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> LoraConfig, get_peft_model <br>config = LoraConfig(<br>    r=<span class="hljs-number">16</span>, <span class="hljs-comment">#low rank</span><br>    lora_alpha=<span class="hljs-number">32</span>,<br>    <span class="hljs-comment"># target_modules=[&quot;q_proj&quot;, &quot;v_proj&quot;],  # if you know</span><br>    lora_dropout=<span class="hljs-number">0.05</span>,<br>    bias=<span class="hljs-string">&quot;none&quot;</span>,<br>    task_type=<span class="hljs-string">&quot;CAUSAL_LM&quot;</span>  <span class="hljs-comment"># set this for CLM or Seq2Seq</span><br>)<br></code></pre></td></tr></table></figure><ul><li>æ•°æ®å¤„ç†</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset<br>dataset = load_dataset(<span class="hljs-string">&quot;Abirate/english_quotes&quot;</span>)<br><br>dataset[<span class="hljs-string">&#x27;train&#x27;</span>].to_pandas()  <span class="hljs-comment"># è½¬æˆpandaæ ¼å¼</span><br>dataset[<span class="hljs-string">&#x27;train&#x27;</span>][<span class="hljs-string">&#x27;author&#x27;</span>][:<span class="hljs-number">4</span>]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">merge</span>(<span class="hljs-params">row</span>):<br>    row[<span class="hljs-string">&#x27;prediction&#x27;</span>] = row[<span class="hljs-string">&#x27;quote&#x27;</span>] + <span class="hljs-string">&#x27; -&gt;: &#x27;</span> + <span class="hljs-built_in">str</span>(row[<span class="hljs-string">&#x27;tags&#x27;</span>])<br>    <span class="hljs-keyword">return</span> row<br>dataset[<span class="hljs-string">&#x27;train&#x27;</span>] = dataset[<span class="hljs-string">&#x27;train&#x27;</span>].<span class="hljs-built_in">map</span>(merge)  <span class="hljs-comment"># æ„å»ºæ–°è¡Œ</span><br><br>tokenizer(dataset[<span class="hljs-string">&#x27;train&#x27;</span>][<span class="hljs-string">&#x27;prediction&#x27;</span>][:<span class="hljs-number">4</span>])  <span class="hljs-comment"># è¿”å›å€¼ä¸ºinput_idså’Œattention_mask</span><br><br>dataset = dataset.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> samples: tokenizer(samples[<span class="hljs-string">&#x27;prediction&#x27;</span>]), batched=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># ç”±&#x27;prediction&#x27;å¾—åˆ°æ–°è¡Œ&#x27;input_ids&#x27;å’Œ&#x27;attention_mask&#x27;</span><br><br><span class="hljs-comment"># nvitop</span><br><br>batch = tokenizer(<span class="hljs-string">&quot;â€œTraining models with PEFT and LoRa is coolâ€ -&gt;: &quot;</span>, return_tensors=<span class="hljs-string">&#x27;pt&#x27;</span>)<br><span class="hljs-keyword">with</span> torch.cuda.amp.autocast():<br>    output_tokens = model.generate(**batch, max_new_tokens=<span class="hljs-number">50</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;\\n\\n&#x27;</span>, tokenizer.decode(output_tokens[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>))<br></code></pre></td></tr></table></figure><ul><li>æ··åˆç²¾åº¦; ä¸åŒçš„layerå¯ä»¥æ”¾åœ¨ä¸åŒçš„device</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># import os</span><br><span class="hljs-comment"># os.environ[&#x27;HTTP_PROXY&#x27;] = &#x27;&lt;http://127.0.0.1:7890&gt;&#x27;</span><br><span class="hljs-comment"># os.environ[&#x27;HTTPS_PROXY&#x27;] = &#x27;&lt;http://127.0.0.1:7890&gt;&#x27;</span><br><br><span class="hljs-comment"># https åè®®</span><br>!pip install -q git+https://github.com/huggingface/transformers.git<br><span class="hljs-comment"># ssh åè®®</span><br>!pip install -q git+ssh://git@github.com/huggingface/transformers.git<br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> LlamaTokenizer, LlamaForCausalLM, GenerationConfig<br>model = LlamaForCausalLM.from_pretrained(<span class="hljs-string">&quot;decapoda-research/llama-7b-hf&quot;</span>,<br>    load_in_8bit=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># æ··åˆç²¾åº¦</span><br>    device_map=<span class="hljs-string">&quot;auto&quot;</span>,  <span class="hljs-comment"># ä¸åŒçš„layerå¯ä»¥æ”¾åœ¨ä¸åŒçš„device</span><br>)<br>tokenizer = LlamaTokenizer.from_pretrained(<span class="hljs-string">&quot;decapoda-research/llama-7b-hf&quot;</span>)<br><br><span class="hljs-keyword">for</span> i, para <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(model.named_parameters()):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;i&#125;</span>, \\t <span class="hljs-subst">&#123;para[<span class="hljs-number">1</span>].device&#125;</span> \\t<span class="hljs-subst">&#123;para[<span class="hljs-number">1</span>].dtype&#125;</span>&#x27;</span>)  <span class="hljs-comment"># æŸ¥çœ‹parametersçš„ç²¾åº¦åŠå…¶æ‰€åœ¨çš„device</span><br><br><span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> PeftModel<br>model = PeftModel.from_pretrained(model, <span class="hljs-string">&quot;tloen/alpaca-lora-7b&quot;</span>)<br><br><span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> mapping<br><span class="hljs-keyword">from</span> peft.utils <span class="hljs-keyword">import</span> other<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;model_type&#x27;</span>, model.config.model_type)<br><span class="hljs-built_in">print</span>(model.peft_config[<span class="hljs-string">&#x27;default&#x27;</span>].target_modules)<br>other.TRANSFORMERS_MODELS_TO_LORA_TARGET_MODULES_MAPPING  <span class="hljs-comment"># æŸ¥çœ‹é»˜è®¤çš„target module</span><br></code></pre></td></tr></table></figure><ul><li>ä¸€ä¸ªalpaca inferenceçš„example</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_prompt</span>(<span class="hljs-params">instruction, <span class="hljs-built_in">input</span>=<span class="hljs-literal">None</span></span>):<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">input</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;&quot;&quot;Below is an instruction that describes a task, paired with an input that provides further context. Write a response that appropriately completes the request.</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Instruction:</span><br><span class="hljs-string"><span class="hljs-subst">&#123;instruction&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">### Input:</span><br><span class="hljs-string"><span class="hljs-subst">&#123;<span class="hljs-built_in">input</span>&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">### Response:&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">f&quot;&quot;&quot;Below is an instruction that describes a task. Write a response that appropriately completes the request.</span><br><span class="hljs-string"></span><br><span class="hljs-string">### Instruction:</span><br><span class="hljs-string"><span class="hljs-subst">&#123;instruction&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">### Response:&quot;&quot;&quot;</span><br><br>generation_config = GenerationConfig(<br>    temperature=<span class="hljs-number">1.5</span>,<br>    <span class="hljs-comment"># nucleus sampling</span><br>    top_p=<span class="hljs-number">0.8</span>,<br>    num_beams=<span class="hljs-number">4</span>,<br>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">inference</span>(<span class="hljs-params">instruction, <span class="hljs-built_in">input</span>=<span class="hljs-literal">None</span></span>):<br>    prompt = generate_prompt(instruction, <span class="hljs-built_in">input</span>)<br>    inputs = tokenizer(prompt, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>)<br>    input_ids = inputs[<span class="hljs-string">&quot;input_ids&quot;</span>].cuda()<br>    generation_output = model.generate(  <span class="hljs-comment"># model.generateè¾“å‡ºçš„ä»æ˜¯ç¼–ç </span><br>        input_ids=input_ids,             <span class="hljs-comment"># éœ€è¦é€šè¿‡tokenizer.decodeè§£ç </span><br>        generation_config=generation_config,<br>        return_dict_in_generate=<span class="hljs-literal">True</span>,<br>        output_scores=<span class="hljs-literal">True</span>,<br>        max_new_tokens=<span class="hljs-number">256</span><br>    )<br>    <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> generation_output.sequences:<br>        output = tokenizer.decode(s)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Response:&quot;</span>, output.split(<span class="hljs-string">&quot;### Response:&quot;</span>)[<span class="hljs-number">1</span>].strip())<br><br>inference(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Instruction: &quot;</span>))<br></code></pre></td></tr></table></figure><ul><li>torch.cuda.ampçš„ä½¿ç”¨: é€šè¿‡loss scaleæ¥æå‡æœ€å¤§çš„batch size</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Simple CNN</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CNN</span>(nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_channels=<span class="hljs-number">1</span>, num_classes=<span class="hljs-number">10</span></span>):<br>        <span class="hljs-built_in">super</span>(CNN, self).__init__()<br>        self.conv1 = nn.Conv2d(<br>            in_channels=in_channels,<br>            out_channels=<span class="hljs-number">5120</span>,<br>            kernel_size=<span class="hljs-number">3</span>,<br>            stride=<span class="hljs-number">1</span>,<br>            padding=<span class="hljs-number">1</span>,<br>        )<br>        <span class="hljs-comment"># /2, downsampling</span><br>        self.pool = nn.MaxPool2d(kernel_size=<span class="hljs-number">2</span>, stride=<span class="hljs-number">2</span>)<br>        self.conv2 = nn.Conv2d(<br>            in_channels=<span class="hljs-number">5120</span>,<br>            out_channels=<span class="hljs-number">10240</span>,<br>            kernel_size=<span class="hljs-number">3</span>,<br>            stride=<span class="hljs-number">1</span>,<br>            padding=<span class="hljs-number">1</span>,<br>        )<br>        <span class="hljs-comment"># (channels*w*h)</span><br>            <span class="hljs-comment"># w, h: å–å†³äºåˆå§‹çš„ width, height</span><br>        self.fc1 = nn.Linear(<span class="hljs-number">10240</span> * <span class="hljs-number">7</span> * <span class="hljs-number">7</span>, num_classes)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        x = F.relu(self.conv1(x))<br>        <span class="hljs-comment"># /2</span><br>        x = self.pool(x)<br>        x = F.relu(self.conv2(x))<br>        <span class="hljs-comment"># /2</span><br>        x = self.pool(x)<br>        <span class="hljs-comment"># 4d =&gt; 2d, (bs, features)</span><br>        x = x.reshape(x.shape[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>)<br>        x = self.fc1(x)<br>        <span class="hljs-keyword">return</span> x<br><br><span class="hljs-keyword">from</span> torchsummary <span class="hljs-keyword">import</span> summary<br>model = CNN(in_channels=<span class="hljs-number">3</span>)<br>summary(model, input_size=(<span class="hljs-number">3</span>, <span class="hljs-number">224</span>, <span class="hljs-number">224</span>), batch_size=<span class="hljs-number">32</span>, device=<span class="hljs-string">&#x27;cpu&#x27;</span>)  <span class="hljs-comment"># æ˜¾ç¤ºç»è¿‡ä¸åŒlayeråshapeçš„å˜åŒ–</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>():<br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(num_epochs)):<br>        <span class="hljs-keyword">for</span> batch_idx, (batch_x, batch_y) <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">enumerate</span>(train_loader)):<br>            batch_x = batch_x.to(device)<br>            batch_y = batch_y.to(device)<br>            <br>            <span class="hljs-comment"># forward</span><br>            <span class="hljs-comment"># logits = model(batch_x)</span><br>            <span class="hljs-comment"># loss = criterion(logits, batch_y)</span><br>            <span class="hljs-keyword">with</span> torch.cuda.amp.autocast():<br>                logits = model(batch_x)<br>                loss = criterion(logits, batch_y)            <br><br>            <span class="hljs-comment"># backward</span><br>            optimizer.zero_grad()<br>            <span class="hljs-comment"># loss.backward()</span><br>            scaler.scale(loss).backward()<br>            <br>            <span class="hljs-comment"># gradient descent</span><br>            <span class="hljs-comment"># optimizer.step()</span><br>            scaler.step(optimizer)<br>            scaler.update()<br></code></pre></td></tr></table></figure><ul><li>ä¸€ä¸ªmodel.generateçš„example</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># pip install bitsandbytes</span><br><span class="hljs-comment"># pip install transformers</span><br><span class="hljs-comment"># pip install accelerate</span><br><br>MAX_NEW_TOKENS = <span class="hljs-number">128</span><br>ckpt = <span class="hljs-string">&#x27;facebook/opt-6.7b&#x27;</span><br>sample = <span class="hljs-string">&#x27;hello, who are you?&#x27;</span><br>tokenizer = AutoTokenizer.from_pretrained(ckpt)<br>input_ids = tokenizer(sample, return_tensors=<span class="hljs-string">&#x27;pt&#x27;</span>).input_ids<br><br>model = AutoModelForCausalLM.from_pretrained(ckpt, device_map=<span class="hljs-string">&#x27;auto&#x27;</span>, load_in_8bit=<span class="hljs-literal">True</span>)<br>generated_ids = model.generate(input_ids, max_length=MAX_NEW_TOKENS)<br>tokenizer.decode(generated_ids[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><ul><li>tokenizerçš„åŸºæœ¬æ¥å£; å¦‚ä½•è®­ç»ƒtokenizer</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer<br>tokenizer_t5 = AutoTokenizer.from_pretrained(<span class="hljs-string">&#x27;t5-base&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize_str</span>(<span class="hljs-params">tokenizer, text</span>):  <span class="hljs-comment"># è¿”å›ç¼–ç å†è§£ç åçš„list, å¯ä»¥æŸ¥çœ‹å¸¸è§è¯æ˜¯å¦è¢«å†åˆ‡åˆ†</span><br>    input_ids = tokenizer(text, add_special_tokens=<span class="hljs-literal">False</span>)[<span class="hljs-string">&#x27;input_ids&#x27;</span>]<br>    <span class="hljs-keyword">return</span> [tokenizer.decode(token_id) <span class="hljs-keyword">for</span> token_id <span class="hljs-keyword">in</span> input_ids]<br><br>python_code = <span class="hljs-string">r&#x27;&#x27;&#x27;def say_hello():</span><br><span class="hljs-string">    print(&#x27;Hello, World!&#x27;)</span><br><span class="hljs-string">    </span><br><span class="hljs-string"># print hello</span><br><span class="hljs-string">say_hello()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>tokenizer = AutoTokenizer.from_pretrained(<span class="hljs-string">&#x27;gpt2&#x27;</span>)<br><span class="hljs-built_in">print</span>(tokenizer(python_code)[<span class="hljs-string">&#x27;input_ids&#x27;</span>])<br><span class="hljs-built_in">print</span>(tokenizer(python_code).tokens())  <span class="hljs-comment"># æŸ¥çœ‹åˆ‡åˆ†å¾—åˆ°çš„tokens</span><br><br>tokenizer.backend_tokenizer.normalizer<br>tokenizer.backend_tokenizer.pre_tokenizer.pre_tokenize_str(python_code)<br><br><span class="hljs-comment"># Unicode character composed of 1-4 bytes</span><br>a, e = <span class="hljs-string">u&#x27;a&#x27;</span>, <span class="hljs-string">u&#x27;â‚¬&#x27;</span><br><span class="hljs-comment"># 1 bytes</span><br>byte = <span class="hljs-built_in">ord</span>(a.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;a&#125;</span>, <span class="hljs-subst">&#123;a.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)&#125;</span>, <span class="hljs-subst">&#123;byte&#125;</span>&quot;</span>)<br><span class="hljs-comment"># 3 bytes</span><br><span class="hljs-comment"># byte = ord(e.encode(&#x27;utf-8&#x27;))</span><br><span class="hljs-comment"># ord æ¥å—çš„æ˜¯ä¸€ä¸ªchar</span><br><span class="hljs-comment"># ord: å­—ç¬¦è½¬æ•´æ•°; æ•´æ•°è½¬å­—ç¬¦</span><br>byte = [<span class="hljs-built_in">ord</span>(<span class="hljs-built_in">chr</span>(i)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> e.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;e&#125;</span>, <span class="hljs-subst">&#123;e.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)&#125;</span>, <span class="hljs-subst">&#123;byte&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># training a tokenizer</span><br><span class="hljs-comment"># ä¸æ¶‰åŠæƒé‡æˆ–è€…åå‘ä¼ æ’­</span><br><span class="hljs-comment"># tokenizer çš„ processing pipeline</span><br><span class="hljs-comment"># normalization</span><br><span class="hljs-comment"># pretokenization</span><br><span class="hljs-comment"># tokenizer model</span><br><span class="hljs-comment"># postprocesssing</span><br><span class="hljs-comment"># subword tokenization algorithms (subword: tokens are part of words)</span><br><span class="hljs-comment"># BPE: byte pair encoding</span><br><span class="hljs-comment"># è¿­ä»£å¼åœ°æ·»åŠ ç­–ç•¥ï¼Œç›´åˆ°ä¸€ä¸ª target vocabulary size</span><br><span class="hljs-comment"># word piece</span><br><span class="hljs-comment"># unigram</span><br><span class="hljs-comment"># è¿­ä»£å¼åœ°åˆ é™¤ç­–ç•¥ï¼Œç›´åˆ°ä¸€ä¸ª target vocabulary size</span><br></code></pre></td></tr></table></figure><figure><imgsrc="https://prod-files-secure.s3.us-west-2.amazonaws.com/f8430f06-3f4a-4ba4-994a-af512bbc3929/6e742602-a09b-41c5-8ccb-867da64b0dad/Untitled.png"alt="Untitled" /><figcaption aria-hidden="true">Untitled</figcaption></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers.models.gpt2.tokenization_gpt2 <span class="hljs-keyword">import</span> bytes_to_unicode<br>bytes_to_unicode_map = bytes_to_unicode()<br>bytes_to_unicode_map<br><br>unicode_to_bytes_map = <span class="hljs-built_in">dict</span>((v, k) <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> bytes_to_unicode_map.items())<br>unicode_to_bytes_map<br><br>base_vocab = <span class="hljs-built_in">list</span>(unicode_to_bytes_map.keys())<br><span class="hljs-built_in">print</span>(base_vocab[<span class="hljs-number">0</span>], base_vocab[-<span class="hljs-number">1</span>])<br><br>tokenizer = AutoTokenizer.from_pretrained(<span class="hljs-string">&#x27;gpt2&#x27;</span>)<br>tokenizer.backend_tokenizer.pre_tokenizer.pre_tokenize_str(python_code)<br>tokens = <span class="hljs-built_in">sorted</span>(tokenizer.vocab.items(), key=<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">len</span>(x[<span class="hljs-number">0</span>]), reverse=<span class="hljs-literal">True</span>)<br>[tokenizer.convert_tokens_to_string([token]) <span class="hljs-keyword">for</span> token, _ <span class="hljs-keyword">in</span> tokens[:<span class="hljs-number">10</span>]]<br>tokens = <span class="hljs-built_in">sorted</span>(tokenizer.vocab.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)<br>[tokenizer.convert_tokens_to_string([token]) <span class="hljs-keyword">for</span> token, _ <span class="hljs-keyword">in</span> tokens[:<span class="hljs-number">12</span>]]<br></code></pre></td></tr></table></figure><table><thead><tr class="header"><th>Description</th><th>Character</th><th>Bytes</th><th>Mapped bytes</th></tr></thead><tbody><tr class="odd"><td>Regular characters</td><td>a and ?</td><td>97 and 63</td><td>a and ?</td></tr><tr class="even"><td>A nonprintable control character (carriage return)</td><td>U+000D</td><td>13</td><td>Ä</td></tr><tr class="odd"><td>A space</td><td></td><td>32</td><td>Ä </td></tr><tr class="even"><td>A nonbreakable space</td><td></td><td>160</td><td>Å‚</td></tr><tr class="odd"><td>A newline character</td><td></td><td>10</td><td>ÄŠ</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># training a tokenizer</span><br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer<br><br>dataset = load_dataset(<span class="hljs-string">&#x27;./codeparrot/&#x27;</span>, split=<span class="hljs-string">&#x27;train&#x27;</span>, streaming=<span class="hljs-literal">True</span>)<br>iter_dataset = <span class="hljs-built_in">iter</span>(dataset)<br>tokenizer = AutoTokenizer.from_pretrained(<span class="hljs-string">&#x27;gpt2&#x27;</span>)<br><br><span class="hljs-keyword">from</span> transformers.models.gpt2.tokenization_gpt2 <span class="hljs-keyword">import</span> bytes_to_unicode<br>bytes_to_unicode_map = bytes_to_unicode()<br>unicode_to_bytes_map = <span class="hljs-built_in">dict</span>((v, k) <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> bytes_to_unicode_map.items())<br>base_vocab = <span class="hljs-built_in">list</span>(unicode_to_bytes_map.keys())<br><br>length = <span class="hljs-number">100000</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_iterator</span>(<span class="hljs-params">batch_size=<span class="hljs-number">1000</span></span>):<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, length, batch_size)):<br>        <span class="hljs-keyword">yield</span> [<span class="hljs-built_in">next</span>(iter_dataset)[<span class="hljs-string">&#x27;content&#x27;</span>] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(batch_size)]<br><br>new_tokenizer = tokenizer.train_new_from_iterator(batch_iterator(), <br>                                                  vocab_size=<span class="hljs-number">12500</span>, <br>                                                  initial_alphabet=base_vocab)<br><br>tokens = <span class="hljs-built_in">sorted</span>(new_tokenizer.vocab.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">False</span>)<br>[(t, new_tokenizer.convert_tokens_to_string([t])) <span class="hljs-keyword">for</span> t, _ <span class="hljs-keyword">in</span> tokens[<span class="hljs-number">257</span>:<span class="hljs-number">280</span>]]  <span class="hljs-comment"># æŸ¥çœ‹tokens</span><br><br><span class="hljs-keyword">import</span> keyword<br><span class="hljs-built_in">len</span>(keyword.kwlist)<br><span class="hljs-keyword">for</span> kw <span class="hljs-keyword">in</span> keyword.kwlist:  <span class="hljs-comment"># æŸ¥çœ‹å“ªäº›è¯è¿˜ä¸åœ¨vocabä¸­</span><br>    <span class="hljs-keyword">if</span> kw <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> new_tokenizer.vocab:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;`<span class="hljs-subst">&#123;kw&#125;</span>` not in the new tokenizer&#x27;</span>)<br><br><span class="hljs-comment"># ä¸Šä¼ åˆ°huggingface</span><br><span class="hljs-keyword">import</span> os<br>os.environ[<span class="hljs-string">&#x27;HTTP_PROXY&#x27;</span>] = <span class="hljs-string">&#x27;&lt;http://127.0.0.1:7890&gt;&#x27;</span><br>os.environ[<span class="hljs-string">&#x27;HTTPS_PROXY&#x27;</span>] = <span class="hljs-string">&#x27;&lt;http://127.0.0.1:7890&gt;&#x27;</span><br>ckpt = <span class="hljs-string">&#x27;asdfgh&#x27;</span><br>org = <span class="hljs-string">&#x27;asdfghjkl&#x27;</span><br>new_tokenizer.push_to_hub(ckpt, organization=org)<br></code></pre></td></tr></table></figure><ul><li>Dataset and IterableDataset</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader, Dataset, IterableDataset<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, m, n</span>):<br>        self.x = np.random.randn(m, n)<br>        self.y = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(m))<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, i</span>):<br>        <span class="hljs-keyword">return</span> self.x[i], self.y[i]<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.y)<br><br>ds = MyDataset(<span class="hljs-number">100</span>, <span class="hljs-number">5</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(ds))  <span class="hljs-comment"># 100</span><br>ds[<span class="hljs-number">0</span>]  <span class="hljs-comment"># (array([ 0.06201527, -0.77968078, -0.68125061, -1.77969614, -0.66575581]), 0)</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyIterableDataset</span>(<span class="hljs-title class_ inherited__">IterableDataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, x, y</span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        self.start = x<br>        self.end = y<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">iter</span>(<span class="hljs-built_in">range</span>(self.start, self.end))<br><br>ds1 = MyIterableDataset(<span class="hljs-number">3</span>, <span class="hljs-number">8</span>)<br>ds2 = MyIterableDataset(<span class="hljs-number">9</span>, <span class="hljs-number">15</span>)<br>ds3 = ds1 + ds2<br>[i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ds1]  <span class="hljs-comment"># [3, 4, 5, 6, 7]</span><br>[i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ds3]  <span class="hljs-comment"># [3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14]</span><br>loader = DataLoader(ds3)<br><span class="hljs-built_in">list</span>(loader)<br><span class="hljs-comment"># [tensor([3]),</span><br><span class="hljs-comment">#  tensor([4]),</span><br><span class="hljs-comment">#  tensor([5]),</span><br><span class="hljs-comment">#  tensor([6]),</span><br><span class="hljs-comment">#  tensor([7]),</span><br><span class="hljs-comment">#  tensor([9]),</span><br><span class="hljs-comment">#  tensor([10]),</span><br><span class="hljs-comment">#  tensor([11]),</span><br><span class="hljs-comment">#  tensor([12]),</span><br><span class="hljs-comment">#  tensor([13]),</span><br><span class="hljs-comment">#  tensor([14])]</span><br><br><span class="hljs-comment"># infinite dataset</span><br>rng = np.random.default_rng()<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">InfIterableDataset</span>(<span class="hljs-title class_ inherited__">IterableDataset</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n</span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        self._n = n<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):<br>        start = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            x = np.arange(start, start + self._n)<br>            y = rng.choice([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], size=<span class="hljs-number">1</span>, p=[<span class="hljs-number">0.4</span>, <span class="hljs-number">0.6</span>])<br>            <span class="hljs-keyword">yield</span> x, y<br>            start += self._n<br><br>window = <span class="hljs-number">5</span><br>cnt = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> (x, y) <span class="hljs-keyword">in</span> InfIterableDataset(window):<br>    <span class="hljs-built_in">print</span>(x, y)<br>    <span class="hljs-keyword">if</span> cnt &gt;= <span class="hljs-number">5</span>:<br>        <span class="hljs-keyword">break</span><br>    cnt += <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><ul><li>mapping and streaming</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset<br>data_files = <span class="hljs-string">&quot;/media/whaow/datasets/PUBMED_title_abstracts_2019_baseline.jsonl&quot;</span><br><span class="hljs-comment"># memory mapped</span><br><span class="hljs-comment"># large_dataset = load_dataset(&quot;json&quot;, data_files=data_files, split=&quot;train&quot;)</span><br><span class="hljs-comment"># tokenizer_dataset2 = large_dataset.map(lambda x: tokenizer(x[&#x27;text&#x27;]), batched=True, batch_size=20000)</span><br><span class="hljs-comment"># streaming</span><br>large_dataset_streamed = load_dataset(<span class="hljs-string">&quot;json&quot;</span>, data_files=data_files, split=<span class="hljs-string">&quot;train&quot;</span>, streaming=<span class="hljs-literal">True</span>)<br>tokenizer_dataset = large_dataset_streamed.<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: tokenizer(x[<span class="hljs-string">&#x27;text&#x27;</span>]))<br><br><span class="hljs-keyword">import</span> psutil<br><span class="hljs-comment"># å½“å‰è¿›ç¨‹çš„memory info</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;psutil.Process().memory_info().rss/(<span class="hljs-number">1024</span>**<span class="hljs-number">2</span>):<span class="hljs-number">.2</span>f&#125;</span> MB&#x27;</span>)<br><br><span class="hljs-keyword">import</span> timeit<br>code_snippet = <span class="hljs-string">&#x27;&#x27;&#x27;batch_size = 20000</span><br><span class="hljs-string">for idx in tqdm(range(0, len(large_dataset), batch_size)):</span><br><span class="hljs-string">    _ = large_dataset[idx: idx+batch_size]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>  <span class="hljs-comment"># å¯¹è¿™å¯¹ä»£ç æ‰§è¡Œä¸¤æ¬¡, å¹¶ç»Ÿè®¡è¿è¡Œçš„å¹³å‡æ—¶é—´</span><br>duration = timeit.timeit(stmt=code_snippet, number=<span class="hljs-number">2</span>, <span class="hljs-built_in">globals</span>=<span class="hljs-built_in">globals</span>())<br><br><span class="hljs-built_in">next</span>(<span class="hljs-built_in">iter</span>(tokenizer_dataset)).keys()<br><span class="hljs-built_in">list</span>(large_dataset_streamed.take(<span class="hljs-number">5</span>))[-<span class="hljs-number">1</span>]<br>large_dataset[<span class="hljs-number">4</span>]  <span class="hljs-comment"># ç»“æœä¸ä¸Šè¡Œä¸€è‡´</span><br><span class="hljs-built_in">next</span>(<span class="hljs-built_in">iter</span>(large_dataset_streamed.skip(<span class="hljs-number">1000</span>)))<br>large_dataset[<span class="hljs-number">1000</span>]  <span class="hljs-comment"># ç»“æœä¸ä¸Šè¡Œä¸€è‡´</span><br></code></pre></td></tr></table></figure><ul><li>retain graph and GPU memory occupied</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python">x = torch.tensor(<span class="hljs-number">1.</span>, requires_grad=<span class="hljs-literal">True</span>)<br>y = x**<span class="hljs-number">2</span><br>y.backward(retain_graph=<span class="hljs-literal">True</span>)<br><span class="hljs-built_in">print</span>(x.grad)  <span class="hljs-comment"># tensor(2.)</span><br>y.backward()<br><span class="hljs-built_in">print</span>(x.grad)  <span class="hljs-comment"># tensor(4.)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_gpu_utilization</span>():  <span class="hljs-comment"># GPU memory occupied: 21296 MB.</span><br>    nvmlInit()<br>    total_used = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(torch.cuda.device_count()):<br>        handle = nvmlDeviceGetHandleByIndex(i)<br>        info = nvmlDeviceGetMemoryInfo(handle)<br>        total_used += info.used<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;GPU memory occupied: <span class="hljs-subst">&#123;total_used//<span class="hljs-number">1024</span>**<span class="hljs-number">2</span>&#125;</span> MB.&quot;</span>)<br></code></pre></td></tr></table></figure><ul><li>sft</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset<br>train_dataset = load_dataset(<span class="hljs-string">&quot;tatsu-lab/alpaca&quot;</span>, split=<span class="hljs-string">&quot;train&quot;</span>)<br>train_dataset<br><span class="hljs-comment"># Dataset(&#123;</span><br><span class="hljs-comment">#     features: [&#x27;instruction&#x27;, &#x27;input&#x27;, &#x27;output&#x27;, &#x27;text&#x27;],</span><br><span class="hljs-comment">#     num_rows: 52002</span><br><span class="hljs-comment"># &#125;)</span><br><span class="hljs-built_in">print</span>(train_dataset[<span class="hljs-number">0</span>])<br><span class="hljs-built_in">print</span>(train_dataset[<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;text&#x27;</span>])<br><br><span class="hljs-comment"># check tokenizer çš„ vocab_size ä¸ model embedding layer æ˜¯å¦ä¸€è‡´</span><br><span class="hljs-built_in">print</span>(tokenizer)<br><span class="hljs-built_in">print</span>(model.model.embed_tokens)<br>model.resize_token_embeddings(<span class="hljs-built_in">len</span>(tokenizer))<br><br><span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> LoraConfig, get_peft_model, prepare_model_for_int8_training<br>model = prepare_model_for_int8_training(model)<br>peft_config = LoraConfig(r=<span class="hljs-number">16</span>, lora_alpha=<span class="hljs-number">32</span>, lora_dropout=<span class="hljs-number">0.05</span>, bias=<span class="hljs-string">&quot;none&quot;</span>, task_type=<span class="hljs-string">&quot;CAUSAL_LM&quot;</span>)<br>model = get_peft_model(model, peft_config)<br>training_args = TrainingArguments(<br>        output_dir=<span class="hljs-string">&quot;xgen-7b-tuned-alpaca-l1&quot;</span>,<br>        per_device_train_batch_size=<span class="hljs-number">4</span>,<br>        optim=<span class="hljs-string">&quot;adamw_torch&quot;</span>,<br>        logging_steps=<span class="hljs-number">10</span>,<br>        learning_rate=<span class="hljs-number">2e-4</span>,<br>        fp16=<span class="hljs-literal">True</span>,<br>        warmup_ratio=<span class="hljs-number">0.1</span>,<br>        lr_scheduler_type=<span class="hljs-string">&quot;linear&quot;</span>,<br>        num_train_epochs=<span class="hljs-number">1</span>,<br>        save_strategy=<span class="hljs-string">&quot;epoch&quot;</span>,<br>        push_to_hub=<span class="hljs-literal">False</span>,<br>    )<br>trainer = SFTTrainer(<br>    model=model,<br>    train_dataset=train_dataset,<br>    dataset_text_field=<span class="hljs-string">&quot;text&quot;</span>,<br>    max_seq_length=<span class="hljs-number">1024</span>,<br>    tokenizer=tokenizer,<br>    args=training_args,<br>    packing=<span class="hljs-literal">True</span>,<br>    peft_config=peft_config,<br>)<br>trainer.train()<br></code></pre></td></tr></table></figure><ul><li>gradient checkpoints</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> os<br>os.environ[<span class="hljs-string">&#x27;CUDA_VISIBLE_DEVICES&#x27;</span>] = <span class="hljs-string">&#x27;0&#x27;</span>  <span class="hljs-comment"># å•æœºå¤šå¡ -&gt; å•æœºå•å¡</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">print_summary</span>(<span class="hljs-params">result</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Time: <span class="hljs-subst">&#123;result.metrics[<span class="hljs-string">&#x27;train_runtime&#x27;</span>]:<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Samples/second: <span class="hljs-subst">&#123;result.metrics[<span class="hljs-string">&#x27;train_samples_per_second&#x27;</span>]:<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>)<br>    print_gpu_utilization()<br><br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> TrainingArguments, Trainer<br>default_args = &#123;<br>    <span class="hljs-string">&quot;output_dir&quot;</span>: <span class="hljs-string">&quot;tmp&quot;</span>,<br>    <span class="hljs-string">&quot;evaluation_strategy&quot;</span>: <span class="hljs-string">&quot;steps&quot;</span>,<br>    <span class="hljs-string">&quot;num_train_epochs&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;log_level&quot;</span>: <span class="hljs-string">&quot;error&quot;</span>,<br>    <span class="hljs-string">&quot;report_to&quot;</span>: <span class="hljs-string">&quot;none&quot;</span>,<br>&#125;<br><span class="hljs-comment"># training_args = TrainingArguments(per_device_train_batch_size=4, **default_args)</span><br>training_args = TrainingArguments(<br>    per_device_train_batch_size=<span class="hljs-number">1</span>, gradient_accumulation_steps=<span class="hljs-number">4</span>, gradient_checkpointing=<span class="hljs-literal">True</span>, **default_args<br>)<br>trainer = Trainer(model=model, args=training_args, train_dataset=ds)<br>result = trainer.train()<br>print_summary(result)<br></code></pre></td></tr></table></figure><ul><li>pipeline</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoTokenizer, AutoModelForCausalLM<br>model_name = <span class="hljs-string">&quot;meta-llama/Llama-2-7b-chat-hf&quot;</span><br>tokenizer = AutoTokenizer.from_pretrained(model_name)<br>pipeline = transformers.pipeline(<br>    <span class="hljs-string">&quot;text-generation&quot;</span>,<br>    model=model_name,<br>    torch_dtype=torch.float16,<br>    device_map=<span class="hljs-string">&quot;auto&quot;</span><br>)<br><span class="hljs-built_in">print</span>(tokenizer)<br><span class="hljs-built_in">print</span>(pipeline.model)<br><br>sequences = pipeline(<br>    <span class="hljs-string">&#x27;I liked &quot;Breaking Bad&quot; and &quot;Band of Brothers&quot;. Do you have any recommendations of other shows I might like?\\n&#x27;</span>,<br>    do_sample=<span class="hljs-literal">True</span>,<br>    top_k=<span class="hljs-number">10</span>,<br>    num_return_sequences=<span class="hljs-number">3</span>,<br>    eos_token_id=tokenizer.eos_token_id,<br>    max_length=<span class="hljs-number">200</span>,<br>)<br><span class="hljs-keyword">for</span> seq <span class="hljs-keyword">in</span> sequences:<br>    <span class="hljs-built_in">print</span>(seq[<span class="hljs-string">&#x27;generated_text&#x27;</span>] + <span class="hljs-string">&#x27;\\n\\n&#x27;</span>)<br></code></pre></td></tr></table></figure><ul><li>trl</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> GPT2Tokenizer<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForCausalLM<br><span class="hljs-keyword">from</span> trl <span class="hljs-keyword">import</span> AutoModelForCausalLMWithValueHead, PPOConfig, PPOTrainer<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_seed</span>(<span class="hljs-params">seed</span>):  <span class="hljs-comment"># ç¡®ä¿ç»“æœå¯å¤ç°</span><br>    torch.manual_seed(seed)<br>    torch.cuda.manual_seed_all(seed)<br>    np.random.seed(seed)<br>    random.seed(seed)<br>    torch.backends.cudnn.deterministic = <span class="hljs-literal">True</span><br>setup_seed(<span class="hljs-number">1</span>)<br><br>model = AutoModelForCausalLMWithValueHead.from_pretrained(<span class="hljs-string">&quot;gpt2&quot;</span>)<br>model_ref = AutoModelForCausalLMWithValueHead.from_pretrained(<span class="hljs-string">&quot;gpt2&quot;</span>)<br>tokenizer = GPT2Tokenizer.from_pretrained(<span class="hljs-string">&quot;gpt2&quot;</span>)<br>tokenizer.pad_token = tokenizer.eos_token<br><span class="hljs-built_in">print</span>(tokenizer)<br><span class="hljs-built_in">print</span>(model.pretrained_model)<br><span class="hljs-built_in">print</span>(model.v_head)<br><span class="hljs-comment"># ValueHead(</span><br><span class="hljs-comment">#   (dropout): Dropout(p=0.1, inplace=False)</span><br><span class="hljs-comment">#   (summary): Linear(in_features=768, out_features=1, bias=True)</span><br><span class="hljs-comment">#   (flatten): Flatten(start_dim=1, end_dim=-1)</span><br><span class="hljs-comment"># )</span><br><br>ppo_config = &#123;<span class="hljs-string">&quot;batch_size&quot;</span>: <span class="hljs-number">1</span>&#125;<br>config = PPOConfig(**ppo_config)<br>ppo_trainer = PPOTrainer(config, model, model_ref, tokenizer)<br><br>query_txt = <span class="hljs-string">&quot;This morning I went to the &quot;</span><br>query_tensor = tokenizer.encode(query_txt, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>).to(model.pretrained_model.device)<br>query_tensor  <span class="hljs-comment"># tensor([[1212, 3329,  314, 1816,  284,  262,  220]], device=&#x27;cuda:0&#x27;)</span><br><br>generation_kwargs = &#123;<br>    <span class="hljs-string">&quot;min_length&quot;</span>: -<span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;top_k&quot;</span>: <span class="hljs-number">0.0</span>,<br>    <span class="hljs-string">&quot;top_p&quot;</span>: <span class="hljs-number">1.0</span>,<br>    <span class="hljs-string">&quot;do_sample&quot;</span>: <span class="hljs-literal">True</span>,<br>    <span class="hljs-string">&quot;pad_token_id&quot;</span>: tokenizer.eos_token_id,<br>    <span class="hljs-string">&quot;max_new_tokens&quot;</span>: <span class="hljs-number">20</span>,<br>&#125;<br>response_tensor = ppo_trainer.generate([item <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> query_tensor], return_prompt=<span class="hljs-literal">True</span>, **generation_kwargs)<br>response_txt = tokenizer.decode(response_tensor[<span class="hljs-number">0</span>])<br>response_txt  <span class="hljs-comment"># &#x27;This morning I went to the vernacular and found myself at a bar, cook, with a wife. Buggas together in&#x27;</span><br>reward = [torch.tensor(<span class="hljs-number">1.0</span>, device=model.pretrained_model.device)]  <span class="hljs-comment"># æ­¤å¤„ä¸ºç®€åŒ–çš„è¡¨ç¤º</span><br>train_stats = ppo_trainer.step([query_tensor[<span class="hljs-number">0</span>]], [response_tensor[<span class="hljs-number">0</span>]], reward)<br><br>input_ids = torch.cat([query_tensor[<span class="hljs-number">0</span>], response_tensor[<span class="hljs-number">0</span>]])<br>base_model_output = model.pretrained_model(input_ids, output_hidden_states=<span class="hljs-literal">True</span>)<br>last_hidden_state = base_model_output.hidden_states[-<span class="hljs-number">1</span>]<br><span class="hljs-built_in">print</span>(last_hidden_state.shape)  <span class="hljs-comment"># torch.Size([34, 768])</span><br>lm_logits = base_model_output.logits<br><span class="hljs-built_in">print</span>(lm_logits.shape)  <span class="hljs-comment"># torch.Size([34, 50257])</span><br><span class="hljs-keyword">with</span> torch.no_grad():<br>    <span class="hljs-comment"># (34, 768) * (768, 1) =&gt; (34, 1)</span><br>    value = model.v_head(last_hidden_state).squeeze(-<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(value.shape)  <span class="hljs-comment"># torch.Size([34])</span><br></code></pre></td></tr></table></figure><ul><li>RMSNorm; Swish/SwiLU/SiLU</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RMSNorm</span>(torch.nn.Module):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dim: <span class="hljs-built_in">int</span>, eps: <span class="hljs-built_in">float</span> = <span class="hljs-number">1e-6</span></span>):<br>        <span class="hljs-built_in">super</span>().__init__()<br>        self.eps = eps<br>        self.weight = nn.Parameter(torch.ones(dim))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_norm</span>(<span class="hljs-params">self, x</span>):<br>        <span class="hljs-keyword">return</span> x * torch.rsqrt(x.<span class="hljs-built_in">pow</span>(<span class="hljs-number">2</span>).mean(-<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>) + self.eps)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):<br>        output = self._norm(x.<span class="hljs-built_in">float</span>()).type_as(x)<br>        <span class="hljs-keyword">return</span> output * self.weight<br><br>x = torch.randn(bs, seq_len, embedding_dim)<br>rms_norm = RMSNorm(embedding_dim)<br>x_rms = rms_norm(x)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sigmoid</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">return</span>  <span class="hljs-number">1</span>/(<span class="hljs-number">1</span> + np.exp(-x))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">swish</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">return</span> x*sigmoid(x)<br><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br>plt.rcParams[<span class="hljs-string">&#x27;figure.dpi&#x27;</span>] = <span class="hljs-number">120</span><br>x = np.arange(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">.01</span>)<br>plt.plot(x, swish(x))<br><br>x = torch.randn(<span class="hljs-number">5</span>)<br>x/(<span class="hljs-number">1</span>+torch.exp(-x))<br><span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F<br>F.silu(x)<br></code></pre></td></tr></table></figure><ul><li><strong>cache KV</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> AutoModelForCausalLM, AutoTokenizer<br>device = <span class="hljs-string">&quot;cuda&quot;</span> <span class="hljs-keyword">if</span> torch.cuda.is_available() <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;cpu&quot;</span><br>tokenizer = AutoTokenizer.from_pretrained(<span class="hljs-string">&quot;gpt2&quot;</span>)<br>model = AutoModelForCausalLM.from_pretrained(<span class="hljs-string">&quot;gpt2&quot;</span>).to(device)<br><br><span class="hljs-keyword">for</span> use_cache <span class="hljs-keyword">in</span> (<span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>):<br>    times = []<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):  <span class="hljs-comment"># measuring 10 generations</span><br>        start = time.time()<br>        model.generate(**tokenizer(<span class="hljs-string">&quot;What is KV caching?&quot;</span>, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>).to(device), <br>                       use_cache=use_cache, <br>                       max_new_tokens=<span class="hljs-number">1000</span>)<br>        times.append(time.time() - start)<br>    mu = <span class="hljs-built_in">round</span>(np.mean(times), <span class="hljs-number">3</span>)<br>    std = <span class="hljs-built_in">round</span>(np.std(times), <span class="hljs-number">3</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-string">&#x27;with&#x27;</span> <span class="hljs-keyword">if</span> use_cache <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;without&#x27;</span>&#125;</span> KV caching: <span class="hljs-subst">&#123;mu&#125;</span> +- <span class="hljs-subst">&#123;std&#125;</span> seconds&quot;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>LLM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Diffusers</title>
    <link href="/2023/12/28/Diffusers/"/>
    <url>/2023/12/28/Diffusers/</url>
    
    <content type="html"><![CDATA[<ul><li>Causal Attention</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">seq_ids = torch.arange(seq_length, device=device)<br>                causal_mask = seq_ids[<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, :].repeat(batch_size, seq_length, <span class="hljs-number">1</span>) &lt;= seq_ids[<span class="hljs-literal">None</span>, :, <span class="hljs-literal">None</span>]<br></code></pre></td></tr></table></figure><ul><li>DDPM</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DDPMPipeline<br>ddpm = DDPMPipeline.from_pretrained(<span class="hljs-string">&quot;google/ddpm-cat-256&quot;</span>, use_safetensors=<span class="hljs-literal">True</span>).to(<span class="hljs-string">&quot;cuda&quot;</span>)<br>image = ddpm(num_inference_steps=<span class="hljs-number">25</span>).images[<span class="hljs-number">0</span>]<br><br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DDPMScheduler, UNet2DModel<br>scheduler = DDPMScheduler.from_pretrained(<span class="hljs-string">&quot;google/ddpm-cat-256&quot;</span>)<br>model = UNet2DModel.from_pretrained(<span class="hljs-string">&quot;google/ddpm-cat-256&quot;</span>, use_safetensors=<span class="hljs-literal">True</span>).to(<span class="hljs-string">&quot;cuda&quot;</span>)<br>scheduler.set_timesteps(<span class="hljs-number">50</span>): <br><br><span class="hljs-comment"># scheduler.timesteps</span><br><span class="hljs-comment"># tensor([980, 960, 940, 920, 900, 880, 860, 840, 820, 800, 780, 760, 740, 720,</span><br><span class="hljs-comment">#    700, 680, 660, 640, 620, 600, 580, 560, 540, 520, 500, 480, 460, 440,</span><br><span class="hljs-comment">#    420, 400, 380, 360, 340, 320, 300, 280, 260, 240, 220, 200, 180, 160,</span><br><span class="hljs-comment">#    140, 120, 100,  80,  60,  40,  20,   0])</span><br><br><span class="hljs-keyword">import</span> torch<br>sample_size = model.config.sample_size<br>noise = torch.randn((<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, sample_size, sample_size), device=<span class="hljs-string">&quot;cuda&quot;</span>)<br><span class="hljs-built_in">input</span> = noise<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> scheduler.timesteps:<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        noisy_residual = model(<span class="hljs-built_in">input</span>, t).sample<br>    previous_noisy_sample = scheduler.step(noisy_residual, t, <span class="hljs-built_in">input</span>).prev_sample<br>    <span class="hljs-built_in">input</span> = previous_noisy_sample<br><br><span class="hljs-comment"># show</span><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np<br>image = (<span class="hljs-built_in">input</span> / <span class="hljs-number">2</span> + <span class="hljs-number">0.5</span>).clamp(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).squeeze()<br>image = (image.permute(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>) * <span class="hljs-number">255</span>).<span class="hljs-built_in">round</span>().to(torch.uint8).cpu().numpy()<br>image = Image.fromarray(image)<br></code></pre></td></tr></table></figure><ul><li>Stable Diffusion</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> StableDiffusionPipeline<br>pipe = StableDiffusionPipeline.from_pretrained(<span class="hljs-string">&quot;CompVis/stable-diffusion-v1-4&quot;</span>, revision=<span class="hljs-string">&quot;fp16&quot;</span>, torch_dtype=torch.float16)<br>prompt = <span class="hljs-string">&quot;a photograph of an astronaut riding a horse&quot;</span> <span class="hljs-comment"># revision=&quot;fp16&quot;è¡¨ç¤ºåŠç²¾åº¦</span><br>image = pipe(prompt).images[<span class="hljs-number">0</span>]<br><br>result = pipe(prompt)<br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-comment"># &#123;</span><br><span class="hljs-comment">#     &#x27;images&#x27;: [&lt;PIL.Image.Image image mode=RGB size=512x512&gt;],</span><br><span class="hljs-comment">#     &#x27;nsfw_content_detected&#x27;: [False]</span><br><span class="hljs-comment"># &#125;</span><br><br><span class="hljs-comment"># Advanced</span><br>generator = torch.Generator(<span class="hljs-string">&quot;cuda&quot;</span>).manual_seed(<span class="hljs-number">1024</span>)<br>image = pipe(prompt, guidance_scale=<span class="hljs-number">7.5</span>, num_inference_steps=<span class="hljs-number">15</span>, generator=generator).images[<span class="hljs-number">0</span>]<br><span class="hljs-comment"># é€šè¿‡generatorå’Œseedå¯ä»¥ä½¿æ¯æ¬¡ç”Ÿæˆçš„å›¾ç‰‡ä¸€è‡´</span><br><span class="hljs-comment"># guidance_scaleè¡¨ç¤ºç”Ÿæˆå›¾ç‰‡å’Œæ–‡æœ¬çš„è´´åˆç¨‹åº¦, ä½†å¯èƒ½ä¼šå¯¼è‡´è´¨é‡ä¸å¤šæ ·æ€§ä¸‹é™</span><br><span class="hljs-comment"># num_inference_stepsè¡¨ç¤ºå»å™ªæ­¥æ•°</span><br><br><span class="hljs-comment"># å¯¹å¤šå¼ å›¾ç‰‡ç”¨ç½‘æ ¼çš„æ–¹å¼æ¥å±•ç¤º</span><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">image_grid</span>(<span class="hljs-params">imgs, rows, cols</span>):<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(imgs) == rows*cols<br>    w, h = imgs[<span class="hljs-number">0</span>].size<br>    grid = Image.new(<span class="hljs-string">&#x27;RGB&#x27;</span>, size=(cols*w, rows*h))<br>    grid_w, grid_h = grid.size<br>    <span class="hljs-keyword">for</span> i, img <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(imgs):<br>        grid.paste(img, box=(i%cols*w, i//cols*h))<br>    <span class="hljs-keyword">return</span> grid<br><br>num_images = <span class="hljs-number">3</span><br>prompt = [<span class="hljs-string">&quot;a photograph of an astronaut riding a horse&quot;</span>] * num_images<br>images = pipe(prompt).images<br>grid = image_grid(images, rows=<span class="hljs-number">1</span>, cols=<span class="hljs-number">3</span>)<br><br><span class="hljs-comment"># ä¿®æ”¹å›¾ç‰‡çš„å°ºå¯¸</span><br>prompt = <span class="hljs-string">&quot;a photograph of an astronaut riding a horse&quot;</span><br>image = pipe(prompt, height=<span class="hljs-number">512</span>, width=<span class="hljs-number">768</span>).images[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><ul><li>Details of Stable Diffusion</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> CLIPTextModel, CLIPTokenizer<br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> AutoencoderKL, UNet2DConditionModel, PNDMScheduler<br>vae = AutoencoderKL.from_pretrained(<span class="hljs-string">&quot;CompVis/stable-diffusion-v1-4&quot;</span>, subfolder=<span class="hljs-string">&quot;vae&quot;</span>, use_safetensors=<span class="hljs-literal">True</span>)<br>tokenizer = CLIPTokenizer.from_pretrained(<span class="hljs-string">&quot;CompVis/stable-diffusion-v1-4&quot;</span>, subfolder=<span class="hljs-string">&quot;tokenizer&quot;</span>)<br>text_encoder = CLIPTextModel.from_pretrained(<br>    <span class="hljs-string">&quot;CompVis/stable-diffusion-v1-4&quot;</span>, subfolder=<span class="hljs-string">&quot;text_encoder&quot;</span>, use_safetensors=<span class="hljs-literal">True</span><br>)<br>unet = UNet2DConditionModel.from_pretrained(<br>    <span class="hljs-string">&quot;CompVis/stable-diffusion-v1-4&quot;</span>, subfolder=<span class="hljs-string">&quot;unet&quot;</span>, use_safetensors=<span class="hljs-literal">True</span><br>)<br><br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> LMSDiscreteScheduler<br>scheduler = LMSDiscreteScheduler(beta_start=<span class="hljs-number">0.00085</span>, beta_end=<span class="hljs-number">0.012</span>, beta_schedule=<span class="hljs-string">&quot;scaled_linear&quot;</span>, num_train_timesteps=<span class="hljs-number">1000</span>)<br><br>prompt = [<span class="hljs-string">&quot;a photograph of an astronaut riding a horse&quot;</span>]<br>height = <span class="hljs-number">512</span>  <span class="hljs-comment"># default height of Stable Diffusion</span><br>width = <span class="hljs-number">512</span>  <span class="hljs-comment"># default width of Stable Diffusion</span><br>num_inference_steps = <span class="hljs-number">25</span>  <span class="hljs-comment"># Number of denoising steps</span><br>guidance_scale = <span class="hljs-number">7.5</span>  <span class="hljs-comment"># Scale for classifier-free guidance</span><br>generator = torch.manual_seed(<span class="hljs-number">0</span>)  <span class="hljs-comment"># Seed generator to create the initial latent noise</span><br>batch_size = <span class="hljs-built_in">len</span>(prompt)<br><br>text_input = tokenizer(<br>    prompt, padding=<span class="hljs-string">&quot;max_length&quot;</span>, max_length=tokenizer.model_max_length, truncation=<span class="hljs-literal">True</span>, return_tensors=<span class="hljs-string">&quot;pt&quot;</span><br>)<br><span class="hljs-keyword">with</span> torch.no_grad():<br>    text_embeddings = text_encoder(text_input.input_ids.to(torch_device))[<span class="hljs-number">0</span>]<br>max_length = text_input.input_ids.shape[-<span class="hljs-number">1</span>]<br>uncond_input = tokenizer([<span class="hljs-string">&quot;&quot;</span>] * batch_size, padding=<span class="hljs-string">&quot;max_length&quot;</span>, max_length=max_length, return_tensors=<span class="hljs-string">&quot;pt&quot;</span>)<br>uncond_embeddings = text_encoder(uncond_input.input_ids.to(torch_device))[<span class="hljs-number">0</span>] <span class="hljs-comment"># for classifier-free guidance</span><br>text_embeddings = orch.cat([uncond_embeddings, text_embeddings])<br>latents = torch.randn(<br>    (batch_size, unet.config.in_channels, height // <span class="hljs-number">8</span>, width // <span class="hljs-number">8</span>),<br>    generator=generator,<br>    device=torch_device,<br>)<br><br>scheduler.set_timesteps(num_inference_steps)<br>latents = latents * scheduler.init_noise_sigma <span class="hljs-comment"># The K-LMS scheduler needs to multiply the latents by its sigma values</span><br><br><span class="hljs-keyword">from</span> tqdm.auto <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tqdm(scheduler.timesteps):<br>    <span class="hljs-comment"># expand the latents if we are doing classifier-free guidance to avoid doing two forward passes.</span><br>    latent_model_input = torch.cat([latents] * <span class="hljs-number">2</span>)<br>    latent_model_input = scheduler.scale_model_input(latent_model_input, timestep=t)<br>    <span class="hljs-comment"># predict the noise residual</span><br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        noise_pred = unet(latent_model_input, t, encoder_hidden_states=text_embeddings).sample<br>    <span class="hljs-comment"># perform guidance</span><br>    noise_pred_uncond, noise_pred_text = noise_pred.chunk(<span class="hljs-number">2</span>)<br>    noise_pred = noise_pred_uncond + guidance_scale * (noise_pred_text - noise_pred_uncond)<br>    <span class="hljs-comment"># compute the previous noisy sample x_t -&gt; x_t-1</span><br>    latents = scheduler.step(noise_pred, t, latents).prev_sample<br><br><span class="hljs-comment"># scale and decode the image latents with vae</span><br>latents = <span class="hljs-number">1</span> / <span class="hljs-number">0.18215</span> * latents<br><span class="hljs-keyword">with</span> torch.no_grad():<br>    image = vae.decode(latents).sample<br><br><span class="hljs-comment"># convert the image to PIL</span><br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br>image = (image / <span class="hljs-number">2</span> + <span class="hljs-number">0.5</span>).clamp(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).squeeze()<br>image = (image.permute(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>) * <span class="hljs-number">255</span>).to(torch.uint8).cpu().numpy()<br>images = (image * <span class="hljs-number">255</span>).<span class="hljs-built_in">round</span>().astype(<span class="hljs-string">&quot;uint8&quot;</span>)<br>image = Image.fromarray(image)<br></code></pre></td></tr></table></figure><ul><li><strong>AutoPipeline</strong></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> AutoPipelineForText2Image<br>pipeline = AutoPipelineForText2Image.from_pretrained(<br>    <span class="hljs-string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, torch_dtype=torch.float16, use_safetensors=<span class="hljs-literal">True</span><br>).to(<span class="hljs-string">&quot;cuda&quot;</span>)<br>prompt = <span class="hljs-string">&quot;peasant and dragon combat, wood cutting style, viking era, bevel with rune&quot;</span><br>image = pipeline(prompt, num_inference_steps=<span class="hljs-number">25</span>).images[<span class="hljs-number">0</span>]<br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> AutoPipelineForImage2Image<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br>pipeline = AutoPipelineForImage2Image.from_pretrained(<br>    <span class="hljs-string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, torch_dtype=torch.float16, use_safetensors=<span class="hljs-literal">True</span><br>).to(<span class="hljs-string">&quot;cuda&quot;</span>)<br>prompt = <span class="hljs-string">&quot;a portrait of a dog wearing a pearl earring&quot;</span><br>url = <span class="hljs-string">&quot;&lt;https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/1665_Girl_with_a_Pearl_Earring.jpg/800px-1665_Girl_with_a_Pearl_Earring.jpg&gt;&quot;</span><br>response = requests.get(url)<br>image = Image.<span class="hljs-built_in">open</span>(BytesIO(response.content)).convert(<span class="hljs-string">&quot;RGB&quot;</span>)<br>image.thumbnail((<span class="hljs-number">768</span>, <span class="hljs-number">768</span>)) <span class="hljs-comment"># ç”Ÿæˆå›¾åƒçš„ç¼©ç•¥å›¾, (768, 768) å®šä¹‰ç¼©ç•¥å›¾çš„æœ€å¤§å°ºå¯¸</span><br><span class="hljs-comment"># å¦‚æœåŸå§‹å›¾åƒçš„å®½åº¦æˆ–é«˜åº¦è¶…è¿‡ 768 åƒç´ , åˆ™ä¼šæŒ‰æ¯”ä¾‹ç¼©å°å›¾åƒ, ä½¿å¾—å®½åº¦æˆ–é«˜åº¦ç­‰äº 768 åƒç´ , å¦ä¸€ç»´åº¦ç›¸åº”åœ°æŒ‰æ¯”ä¾‹å‡å°, ä»¥ä¿æŒåŸå§‹çš„å®½é«˜æ¯”</span><br>image = pipeline(prompt, image, num_inference_steps=<span class="hljs-number">200</span>, strength=<span class="hljs-number">0.75</span>, guidance_scale=<span class="hljs-number">10.5</span>).images[<span class="hljs-number">0</span>]<br><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> diffusers.utils <span class="hljs-keyword">import</span> load_image<br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> AutoPipelineForInpainting<br><br>pipeline = AutoPipelineForInpainting.from_pretrained(<br>    <span class="hljs-string">&quot;stabilityai/stable-diffusion-xl-base-1.0&quot;</span>, torch_dtype=torch.float16, use_safetensors=<span class="hljs-literal">True</span><br>).to(<span class="hljs-string">&quot;cuda&quot;</span>)<br>img_url = <span class="hljs-string">&quot;&lt;https://raw.githubusercontent.com/CompVis/latent-diffusion/main/data/inpainting_examples/overture-creations-5sI6fQgYIuo.png&gt;&quot;</span><br>mask_url = <span class="hljs-string">&quot;&lt;https://raw.githubusercontent.com/CompVis/latent-diffusion/main/data/inpainting_examples/overture-creations-5sI6fQgYIuo_mask.png&gt;&quot;</span><br>init_image = load_image(img_url).convert(<span class="hljs-string">&quot;RGB&quot;</span>)<br>mask_image = load_image(mask_url).convert(<span class="hljs-string">&quot;RGB&quot;</span>)<br>prompt = <span class="hljs-string">&quot;A majestic tiger sitting on a bench&quot;</span><br>image = pipeline(prompt, image=init_image, mask_image=mask_image, num_inference_steps=<span class="hljs-number">50</span>, strength=<span class="hljs-number">0.80</span>).images[<span class="hljs-number">0</span>]<br></code></pre></td></tr></table></figure><ul><li>Training</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> torch<br><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass<br><span class="hljs-meta">@dataclass</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">TrainingConfig</span>:<br>    image_size = <span class="hljs-number">128</span>  <span class="hljs-comment"># the generated image resolution</span><br>    train_batch_size = <span class="hljs-number">16</span><br>    eval_batch_size = <span class="hljs-number">16</span>  <span class="hljs-comment"># how many images to sample during evaluation</span><br>    num_epochs = <span class="hljs-number">50</span><br>    gradient_accumulation_steps = <span class="hljs-number">1</span><br>    learning_rate = <span class="hljs-number">1e-4</span><br>    lr_warmup_steps = <span class="hljs-number">500</span><br>    save_image_epochs = <span class="hljs-number">10</span><br>    save_model_epochs = <span class="hljs-number">30</span><br>    mixed_precision = <span class="hljs-string">&quot;fp16&quot;</span>  <span class="hljs-comment"># `no` for float32, `fp16` for automatic mixed precision</span><br>    output_dir = <span class="hljs-string">&quot;ddpm-butterflies-128&quot;</span>  <span class="hljs-comment"># the model name locally and on the HF Hub</span><br><br>    push_to_hub = <span class="hljs-literal">True</span>  <span class="hljs-comment"># whether to upload the saved model to the HF Hub</span><br>    hub_model_id = <span class="hljs-string">&quot;&lt;your-username&gt;/&lt;my-awesome-model&gt;&quot;</span>  <span class="hljs-comment"># the name of the repository to create on the HF Hub</span><br>    hub_private_repo = <span class="hljs-literal">False</span><br>    overwrite_output_dir = <span class="hljs-literal">True</span>  <span class="hljs-comment"># overwrite the old model when re-running the notebook</span><br>    seed = <span class="hljs-number">0</span><br>config = TrainingConfig()<br><br><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset<br>config.dataset_name = <span class="hljs-string">&quot;huggan/smithsonian_butterflies_subset&quot;</span><br>dataset = load_dataset(config.dataset_name, split=<span class="hljs-string">&quot;train&quot;</span>)<br><br><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt<br>fig, axs = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">4</span>))<br><span class="hljs-keyword">for</span> i, image <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(dataset[:<span class="hljs-number">4</span>][<span class="hljs-string">&quot;image&quot;</span>]):<br>    axs[i].imshow(image)<br>    axs[i].set_axis_off()<br>fig.show()<br><span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms<br>preprocess = transforms.Compose(<br>    [<br>        transforms.Resize((config.image_size, config.image_size)),<br>        transforms.RandomHorizontalFlip(),<br>        transforms.ToTensor(),<br>        transforms.Normalize([<span class="hljs-number">0.5</span>], [<span class="hljs-number">0.5</span>]),<br>    ]<br>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">examples</span>):<br>    images = [preprocess(image.convert(<span class="hljs-string">&quot;RGB&quot;</span>)) <span class="hljs-keyword">for</span> image <span class="hljs-keyword">in</span> examples[<span class="hljs-string">&quot;image&quot;</span>]]<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;images&quot;</span>: images&#125;<br>dataset.set_transform(transform)<br><br>train_dataloader = torch.utils.data.DataLoader(dataset, batch_size=config.train_batch_size, shuffle=<span class="hljs-literal">True</span>)<br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> UNet2DModel<br>model = UNet2DModel(<br>    sample_size=config.image_size,  <span class="hljs-comment"># the target image resolution</span><br>    in_channels=<span class="hljs-number">3</span>,  <span class="hljs-comment"># the number of input channels, 3 for RGB images</span><br>    out_channels=<span class="hljs-number">3</span>,  <span class="hljs-comment"># the number of output channels</span><br>    layers_per_block=<span class="hljs-number">2</span>,  <span class="hljs-comment"># how many ResNet layers to use per UNet block</span><br>    block_out_channels=(<span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">256</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>),  <span class="hljs-comment"># the number of output channels for each UNet block</span><br>    down_block_types=(<br>        <span class="hljs-string">&quot;DownBlock2D&quot;</span>,  <span class="hljs-comment"># a regular ResNet downsampling block</span><br>        <span class="hljs-string">&quot;DownBlock2D&quot;</span>,<br>        <span class="hljs-string">&quot;DownBlock2D&quot;</span>,<br>        <span class="hljs-string">&quot;DownBlock2D&quot;</span>,<br>        <span class="hljs-string">&quot;AttnDownBlock2D&quot;</span>,  <span class="hljs-comment"># a ResNet downsampling block with spatial self-attention</span><br>        <span class="hljs-string">&quot;DownBlock2D&quot;</span>,<br>    ),<br>    up_block_types=(<br>        <span class="hljs-string">&quot;UpBlock2D&quot;</span>,  <span class="hljs-comment"># a regular ResNet upsampling block</span><br>        <span class="hljs-string">&quot;AttnUpBlock2D&quot;</span>,  <span class="hljs-comment"># a ResNet upsampling block with spatial self-attention</span><br>        <span class="hljs-string">&quot;UpBlock2D&quot;</span>,<br>        <span class="hljs-string">&quot;UpBlock2D&quot;</span>,<br>        <span class="hljs-string">&quot;UpBlock2D&quot;</span>,<br>        <span class="hljs-string">&quot;UpBlock2D&quot;</span>,<br>    ),<br>)<br><br><span class="hljs-keyword">from</span> diffusers.optimization <span class="hljs-keyword">import</span> get_cosine_schedule_with_warmup<br>optimizer = torch.optim.AdamW(model.parameters(), lr=config.learning_rate)<br>lr_scheduler = get_cosine_schedule_with_warmup(<br>    optimizer=optimizer,<br>    num_warmup_steps=config.lr_warmup_steps,<br>    num_training_steps=(<span class="hljs-built_in">len</span>(train_dataloader) * config.num_epochs),<br>)<br><br><span class="hljs-comment"># An example</span><br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DDPMScheduler<br>noise_scheduler = DDPMScheduler(num_train_timesteps=<span class="hljs-number">1000</span>)<br>noise = torch.randn(sample_image.shape)<br>timesteps = torch.LongTensor([<span class="hljs-number">50</span>])<br>noisy_image = noise_scheduler.add_noise(sample_image, noise, timesteps)<br>Image.fromarray(((noisy_image.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>) + <span class="hljs-number">1.0</span>) * <span class="hljs-number">127.5</span>).<span class="hljs-built_in">type</span>(torch.uint8).numpy()[<span class="hljs-number">0</span>])<br>noise_pred = model(noisy_image, timesteps).sample<br>loss = F.mse_loss(noise_pred, noise)<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> diffusers <span class="hljs-keyword">import</span> DDPMPipeline<br><span class="hljs-keyword">from</span> diffusers.utils <span class="hljs-keyword">import</span> make_image_grid<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">config, epoch, pipeline</span>):<br>    <span class="hljs-comment"># Sample some images from random noise (this is the backward diffusion process).</span><br>    <span class="hljs-comment"># The default pipeline output type is `List[PIL.Image]`</span><br>    images = pipeline(<br>        batch_size=config.eval_batch_size,<br>        generator=torch.manual_seed(config.seed),<br>    ).images<br><br>    <span class="hljs-comment"># Make a grid out of the images</span><br>    image_grid = make_image_grid(images, rows=<span class="hljs-number">4</span>, cols=<span class="hljs-number">4</span>)<br><br>    <span class="hljs-comment"># Save the images</span><br>    test_dir = os.path.join(config.output_dir, <span class="hljs-string">&quot;samples&quot;</span>)<br>    os.makedirs(test_dir, exist_ok=<span class="hljs-literal">True</span>)<br>    image_grid.save(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;test_dir&#125;</span>/<span class="hljs-subst">&#123;epoch:04d&#125;</span>.png&quot;</span>)<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><span class="hljs-keyword">from</span> tqdm.auto <span class="hljs-keyword">import</span> tqdm<br><span class="hljs-keyword">from</span> accelerate <span class="hljs-keyword">import</span> Accelerator<br><span class="hljs-keyword">from</span> huggingface_hub <span class="hljs-keyword">import</span> create_repo, upload_folder<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_loop</span>(<span class="hljs-params">config, model, noise_scheduler, optimizer, train_dataloader, lr_scheduler</span>):<br>    <span class="hljs-comment"># Initialize accelerator and tensorboard logging</span><br>    accelerator = Accelerator(<br>        mixed_precision=config.mixed_precision,<br>        gradient_accumulation_steps=config.gradient_accumulation_steps,<br>        log_with=<span class="hljs-string">&quot;tensorboard&quot;</span>,<br>        project_dir=os.path.join(config.output_dir, <span class="hljs-string">&quot;logs&quot;</span>),<br>    )<br>    <span class="hljs-keyword">if</span> accelerator.is_main_process:<br>        <span class="hljs-keyword">if</span> config.output_dir <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            os.makedirs(config.output_dir, exist_ok=<span class="hljs-literal">True</span>)<br>        <span class="hljs-keyword">if</span> config.push_to_hub:<br>            repo_id = create_repo(<br>                repo_id=config.hub_model_id <span class="hljs-keyword">or</span> Path(config.output_dir).name, exist_ok=<span class="hljs-literal">True</span><br>            ).repo_id<br>        accelerator.init_trackers(<span class="hljs-string">&quot;train_example&quot;</span>)<br><br>    <span class="hljs-comment"># Prepare everything</span><br>    <span class="hljs-comment"># There is no specific order to remember, you just need to unpack the</span><br>    <span class="hljs-comment"># objects in the same order you gave them to the prepare method.</span><br>    model, optimizer, train_dataloader, lr_scheduler = accelerator.prepare(<br>        model, optimizer, train_dataloader, lr_scheduler<br>    )<br><br>    global_step = <span class="hljs-number">0</span><br><br>    <span class="hljs-comment"># Now you train the model</span><br>    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(config.num_epochs):<br>        <span class="hljs-keyword">for</span> step, batch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_dataloader):<br>            clean_images = batch[<span class="hljs-string">&quot;images&quot;</span>]<br>            <span class="hljs-comment"># Sample noise to add to the images</span><br>            noise = torch.randn(clean_images.shape, device=clean_images.device)<br>            bs = clean_images.shape[<span class="hljs-number">0</span>]<br><br>            <span class="hljs-comment"># Sample a random timestep for each image</span><br>            timesteps = torch.randint(<br>                <span class="hljs-number">0</span>, noise_scheduler.config.num_train_timesteps, (bs,), device=clean_images.device,<br>                dtype=torch.int64<br>            )<br><br>            <span class="hljs-comment"># Add noise to the clean images according to the noise magnitude at each timestep</span><br>            <span class="hljs-comment"># (this is the forward diffusion process)</span><br>            noisy_images = noise_scheduler.add_noise(clean_images, noise, timesteps)<br><br>            <span class="hljs-keyword">with</span> accelerator.accumulate(model):<br>                <span class="hljs-comment"># Predict the noise residual</span><br>                noise_pred = model(noisy_images, timesteps, return_dict=<span class="hljs-literal">False</span>)[<span class="hljs-number">0</span>]<br>                loss = F.mse_loss(noise_pred, noise)<br>                accelerator.backward(loss)<br><br>                accelerator.clip_grad_norm_(model.parameters(), <span class="hljs-number">1.0</span>)<br>                optimizer.step()<br>                lr_scheduler.step()<br>                optimizer.zero_grad()<br><br>        <span class="hljs-comment"># After each epoch you optionally sample some demo images with evaluate() and save the model</span><br>        <span class="hljs-keyword">if</span> accelerator.is_main_process:<br>            pipeline = DDPMPipeline(unet=accelerator.unwrap_model(model), scheduler=noise_scheduler)<br><br>            <span class="hljs-keyword">if</span> (epoch + <span class="hljs-number">1</span>) % config.save_image_epochs == <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> epoch == config.num_epochs - <span class="hljs-number">1</span>:<br>                evaluate(config, epoch, pipeline)<br>                <span class="hljs-keyword">if</span> config.push_to_hub:<br>                    upload_folder(<br>                        repo_id=repo_id,<br>                        folder_path=config.output_dir,<br>                        commit_message=<span class="hljs-string">f&quot;Epoch <span class="hljs-subst">&#123;epoch&#125;</span>&quot;</span>,<br>                        ignore_patterns=[<span class="hljs-string">&quot;step_*&quot;</span>, <span class="hljs-string">&quot;epoch_*&quot;</span>],<br>                    )<br>                <span class="hljs-keyword">else</span>:<br>                    pipeline.save_pretrained(config.output_dir)<br><span class="hljs-keyword">from</span> accelerate <span class="hljs-keyword">import</span> notebook_launcher<br>args = (config, model, noise_scheduler, optimizer, train_dataloader, lr_scheduler)<br>notebook_launcher(train_loop, args, num_processes=<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">import</span> glob<br>sample_images = <span class="hljs-built_in">sorted</span>(glob.glob(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;config.output_dir&#125;</span>/samples/*.png&quot;</span>)) <span class="hljs-comment"># æ¥æ”¶ä¸€ä¸ªè·¯å¾„æ¨¡å¼, å¹¶è¿”å›ä¸è¯¥æ¨¡å¼åŒ¹é…çš„æ‰€æœ‰æ–‡ä»¶è·¯å¾„çš„åˆ—è¡¨</span><br>Image.<span class="hljs-built_in">open</span>(sample_images[-<span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Diffusion</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Zookeeper-Redis-MongoDB</title>
    <link href="/2023/12/16/Zookeeper-Redis-MongoDB/"/>
    <url>/2023/12/16/Zookeeper-Redis-MongoDB/</url>
    
    <content type="html"><![CDATA[<ul><li>Zookeeper: Apache Hadoopé¡¹ç›®ä¸‹çš„ä¸€ä¸ªå­é¡¹ç›®;ä¸€ä¸ªåˆ†å¸ƒå¼ã€å¼€æºçš„åˆ†å¸ƒå¼åº”ç”¨ç¨‹åºçš„åè°ƒæœåŠ¡; æä¾›çš„ä¸»è¦åŠŸèƒ½ä¸º: é…ç½®ç®¡ç†,åˆ†å¸ƒå¼é”, é›†ç¾¤ç®¡ç†</li><li>Redis(Remote Dictionary Server): é”®å€¼ç±»å‹çš„éå…³ç³»å‹æ•°æ®åº“,valueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„(æ–‡æ¡£ç±»å‹: MongoDB; åˆ—ç±»å‹: HBase; Graphç±»å‹:Neo4j)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><code class="hljs bash">// å®‰è£…Redis, æ­¤å¤„ä½¿ç”¨çš„ç¯å¢ƒä¸ºCentOS 7<br>// Redisæ˜¯åŸºäºCè¯­è¨€ç¼–å†™çš„, é¦–å…ˆéœ€è¦å®‰è£…Redisæ‰€éœ€çš„gccä¾èµ–<br>yum install -y gcc tcl<br>// å°†å®˜ç½‘ä¸‹è½½çš„å®‰è£…åŒ…ä¸Šä¼ è‡³è™šæ‹Ÿæœºçš„/usr/local/srcç›®å½•<br>// è¿›å…¥redis-6.2.6ç›®å½•, ç¼–è¯‘å¹¶å®‰è£…<br>make &amp;&amp; make install<br>// é»˜è®¤çš„å®‰è£…è·¯å¾„ä¸º/usr/local/bin, è¿›å…¥è¯¥è·¯å¾„èƒ½çœ‹åˆ°redisç›¸å…³çš„æ–‡ä»¶:<br>// redis-cli: redisæä¾›çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯<br>// redis-server: redisæœåŠ¡å™¨å¯åŠ¨è„šæœ¬, ç›´æ¥è¿è¡Œå³å¯å¯åŠ¨<br>// redis-sentinel: rediså“¨å…µå¯åŠ¨è„šæœ¬<br><br>// æŒ‡å®šé…ç½®å¯åŠ¨, éœ€ä¿®æ”¹redis-6.2.6ç›®å½•ä¸‹çš„redis.confæ–‡ä»¶<br>// æ–‡ä»¶å¤‡ä»½: <span class="hljs-built_in">cp</span> redis.conf redis.conf.bck<br>// ä¿®æ”¹é…ç½®å¦‚ä¸‹:<br><span class="hljs-built_in">bind</span> 0.0.0.0 // 127.0.0.1: åªèƒ½åœ¨æœ¬åœ°è®¿é—®; 0.0.0.0: å¯ä»¥åœ¨ä»»æ„IPè®¿é—®<br>daemonize <span class="hljs-built_in">yes</span> // å®ˆæŠ¤è¿›ç¨‹, <span class="hljs-built_in">yes</span>è¡¨ç¤ºå¯åœ¨åå°è¿è¡Œ<br>requirepass 123123 // è®¾ç½®åè®¿é—®rediséœ€è¾“å…¥å¯†ç <br>port 6379 // é»˜è®¤çš„ç›‘å¬ç«¯å£<br><span class="hljs-built_in">dir</span> . // é»˜è®¤ä¸ºå½“å‰ç›®å½•, è¿è¡Œredis-serveræ—¶, å‘½ä»¤ã€æ—¥å¿—ã€æŒä¹…åŒ–æ–‡ä»¶ä¼šä¿å­˜åœ¨è¿™ä¸ªç›®å½•<br>database 1 // æ•°æ®åº“æ•°é‡, æ­¤å¤„è¡¨ç¤ºåªä½¿ç”¨1ä¸ªæ•°æ®åº“(é»˜è®¤å€¼ä¸º16, å³æœ‰16ä¸ªæ•°æ®åº“, ç¼–å·ä¸º0-15)<br>maxmemory 512mb // redisèƒ½å¤Ÿä½¿ç”¨çš„æœ€å¤§å†…å­˜<br>logfile <span class="hljs-string">&quot;redis.log&quot;</span> // æ—¥å¿—æ–‡ä»¶, é»˜è®¤ä¸ºç©º(å³ä¸è®°å½•æ—¥å¿—), å¯ä»¥æŒ‡å®šæ—¥å¿—æ–‡ä»¶å<br><br>// ä¿®æ”¹å®Œæ¯•å, æ‰§è¡Œredis-server redis.confå‘½ä»¤è¿è¡Œ<br><br>// é…ç½®ç³»ç»Ÿæ–‡ä»¶<br>vi /etc/systemd/system/redis.service<br><br>[Unit]<br>Description=redis-server<br>After=network.target<br><br>[Service]<br>Type=forking<br>ExecStart=/usr/local/bin/redis-server /usr/local/src/redis-6.2.6/redis.conf<br>PrivateTmp=<span class="hljs-literal">true</span><br><br>[Install]<br>WantedBy=multi-user.target<br><br>// é‡è½½ç³»ç»ŸæœåŠ¡: systemctl daemon-reload // ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ<br>// å¯åŠ¨: systemctl start redis<br>// åœæ­¢: systemctl stop redis<br>// é‡å¯: systemctl restart redis<br>// æŸ¥çœ‹çŠ¶æ€: systemctl status redis<br>// è®©rediså¼€æœºè‡ªå¯: systemctl <span class="hljs-built_in">enable</span> redis<br><br>// å‘½ä»¤è¡Œå®¢æˆ·ç«¯<br>redis-cli<br>// -h(æŒ‡å®šè¦è¿æ¥çš„redisèŠ‚ç‚¹çš„IPåœ°å€, é»˜è®¤ä¸º127.0.0.1)<br>// -p(æŒ‡å®šè¦è¿æ¥çš„redisèŠ‚ç‚¹çš„ç«¯å£, é»˜è®¤ä¸º6379)<br>// -a(æŒ‡å®šredisçš„è®¿é—®å¯†ç )<br>redis-cli -h=127.0.0.1 -p=6379 -a=123123<br>// ä¹Ÿå¯ä»¥å…ˆé€šè¿‡redis-cli -h=127.0.0.1 -p=6379è¿æ¥, å†é€šè¿‡AUTH 123123è¾“å…¥å¯†ç <br><br><span class="hljs-built_in">set</span> age 20 // OK<br>get age // <span class="hljs-string">&quot;20&quot;</span><br><br>// Rediså›¾å½¢åŒ–ç•Œé¢çš„å®¢æˆ·ç«¯<br>// &lt;https://github.com/lework/RedisDesktopManager-Windows/releases&gt;<br>// è¿›å…¥1å·åº“: <span class="hljs-keyword">select</span> 1<br>// å®˜æ–¹æ–‡æ¡£: &lt;https://redis.io/commands&gt;<br><br>// Redisé€šç”¨å‘½ä»¤<br>KEYS *<br>KEYS *a // æŸ¥è¯¢åŒ¹é…çš„key<br>DEL age // åˆ é™¤ä¸€ä¸ªæŒ‡å®šçš„key<br>MSET k1, v1, k2, v2, k3, v3 // æ‰¹é‡æ’å…¥<br>EXISTS age // åˆ¤æ–­æŒ‡å®šçš„keyæ˜¯å¦å­˜åœ¨<br>EXPIRE age 20 // ç»™ä¸€ä¸ªkeyè®¾ç½®æœ‰æ•ˆæœŸ(æ•°å€¼çš„å•ä½ä¸ºs), åˆ°æœŸæ—¶è¯¥keyä¼šè¢«è‡ªåŠ¨åˆ é™¤<br>TTL // æŸ¥çœ‹ä¸€ä¸ªkeyçš„å‰©ä½™æœ‰æ•ˆæœŸ(-2è¡¨ç¤ºå·²è¿‡æœŸ, -1è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆ)<br><br>// Stringç±»å‹<br>// valueæ˜¯å­—ç¬¦ä¸², æ ¹æ®å­—ç¬¦ä¸²æ ¼å¼å¯åˆ†ä¸º3ç±»: string, int, <span class="hljs-built_in">float</span><br>// å¸¸è§å‘½ä»¤<br>// SET: æ·»åŠ æˆ–ä¿®æ”¹é”®å€¼å¯¹ e.g <span class="hljs-built_in">set</span> name zhangsan<br>// GET: æ ¹æ®keyè·å–value e.g get name<br>// MSET: å¤šæ¬¡æ·»åŠ æˆ–ä¿®æ”¹é”®å€¼å¯¹ e.g MSET k1, v1, k2, v2, k3, v3<br>// MGET: å¤šæ¬¡æ ¹æ®keyè·å–value e.g MSET k1, k2, k3<br>// INCR: ä½¿ä¸€ä¸ªæ•´å‹çš„è‡ªå¢1 e.g INCR age<br>// INCRBY: ä½¿ä¸€ä¸ªæ•´å‹çš„è‡ªå¢æŒ‡å®šæ­¥é•¿ e.g INCRBY age 2<br>// INCRBYFLOAT: ä½¿ä¸€ä¸ªæµ®ç‚¹å‹çš„è‡ªå¢æŒ‡å®šæ­¥é•¿ e.g INCRBYFLOAT socre 1.5<br>// SETNX: æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹(å‰ææ˜¯keyä¸å­˜åœ¨, å¦åˆ™ä¸æ‰§è¡Œ) e.g <span class="hljs-built_in">set</span> name lisi<br>//                                                ç­‰ä»·äº <span class="hljs-built_in">set</span> name lisi nx<br>// SETEX: æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹å¹¶è®¾ç½®æœ‰æ•ˆæœŸ e.g setex name 10 lisi<br><br>// keyå±‚çº§ç»“æ„<br>// Redisçš„keyå…è®¸æœ‰å¤šä¸ªå•è¯å½¢æˆå±‚çº§ç»“æ„, å•è¯ä¹‹é—´ç”¨<span class="hljs-string">&quot;:&quot;</span>éš”å¼€<br>// e.g é¡¹ç›®åç§°ä¸º<span class="hljs-built_in">test</span>, æœ‰userå’Œproductä¸¤ç§ä¸åŒç±»å‹çš„æ•°æ®, åˆ™å¯å®šä¹‰:<br>// userç›¸å…³çš„keyä¸º: <span class="hljs-built_in">test</span>:user:1 (1è¡¨ç¤º<span class="hljs-built_in">id</span>, æ­¤å¤„è¡¨ç¤º<span class="hljs-built_in">id</span>ä¸º1çš„userçš„ä¿¡æ¯)<br>// productç›¸å…³çš„keyä¸º: <span class="hljs-built_in">test</span>:product:1 (1è¡¨ç¤º<span class="hljs-built_in">id</span>, æ­¤å¤„è¡¨ç¤º<span class="hljs-built_in">id</span>ä¸º1çš„productçš„ä¿¡æ¯)<br>// e.g <span class="hljs-built_in">set</span> <span class="hljs-built_in">test</span>:user:1 <span class="hljs-string">&#x27;&#123;&quot;id&quot;: 1, &quot;name&quot;: zhangsan, &quot;age&quot;: 20&#125;&#x27;</span><br>//     <span class="hljs-built_in">set</span> <span class="hljs-built_in">test</span>:user:2 <span class="hljs-string">&#x27;&#123;&quot;id&quot;: 2, &quot;name&quot;: lisi, &quot;age&quot;: 21&#125;&#x27;</span><br><br>// Hashç±»å‹<br>// Hashç»“æ„å¯å°†å¯¹è±¡ä¸­çš„æ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨(fieldå¯¹åº”key), ä»è€Œé’ˆå¯¹å•ä¸ªå­—æ®µåšCRUD<br>// HSET e.g hset <span class="hljs-built_in">test</span>:user:3 name lucy<br>//          hset <span class="hljs-built_in">test</span>:user:3 age 21<br>// HMSET e.g hset <span class="hljs-built_in">test</span>:user:3 name lucy age 21<br>// HGET e.g hget <span class="hljs-built_in">test</span>:user:3 name<br>// HMSET e.g hset <span class="hljs-built_in">test</span>:user:3 name age<br>// HGETALL e.g hgetall <span class="hljs-built_in">test</span>:user:3 // è·å–keyå’Œvalue<br>// HKEYS e.g hkeys <span class="hljs-built_in">test</span>:user:3 // è·å–key<br>// HVALS e.g hvals <span class="hljs-built_in">test</span>:user:3 // è·å–value<br>// HINCRBY e.g hincrby <span class="hljs-built_in">test</span>:user:3 age 2 (æ³¨: 2ä¹Ÿå¯ä»¥æ¢æˆ-2)<br>// HSETNX e.g hsetnx <span class="hljs-built_in">test</span>:user:3 score 10 (åˆ¤æ–­çš„æ˜¯fieldæ˜¯å¦å­˜åœ¨, ä¸å­˜åœ¨åˆ™æ‰§è¡Œ)<br><br>// Listç±»å‹<br>// Redisä¸­çš„Listç±»å‹ä¸ä¸Javaä¸­çš„LinkedListç±»ä¼¼, å¯çœ‹ä½œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„<br>// ç‰¹ç‚¹: æœ‰åº; å…ƒç´ å¯ä»¥é‡å¤; æ’å…¥ä¸åˆ é™¤å¿«; æŸ¥è¯¢é€Ÿåº¦ä¸€èˆ¬<br>// LPUSH key element: åœ¨åˆ—è¡¨å·¦ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´  e.g lpush user 1 2 3 (1, 2, 3ä¸ºvalue)<br>// LPOP key: ç§»é™¤å¹¶è¿”å›åˆ—è¡¨å·¦ä¾§ç¬¬ä¸€ä¸ªå…ƒç´ , è‹¥æ²¡æœ‰åˆ™è¿”å›null e.g lpop user 1<br>// RPUSH key element: åœ¨åˆ—è¡¨å³ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ <br>// RPOP key: ç§»é™¤å¹¶è¿”å›åˆ—è¡¨å³ä¾§ç¬¬ä¸€ä¸ªå…ƒç´ , è‹¥æ²¡æœ‰åˆ™è¿”å›null<br>// LRANGE key start end: è¿”å›ä¸€æ®µèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´  e.g lrange user 1 2<br>// BLPOPå’ŒBRPOP: ä¸LPOPå’ŒRPOPç±»ä¼¼, ä½†åœ¨æ²¡æœ‰å…ƒç´ æ—¶ä¼šç­‰å¾…æŒ‡å®šæ—¶é—´, è€Œä¸æ˜¯ç›´æ¥è¿”å›null<br>// e.g blpop user 100 (ç­‰å¾…æ—¶é•¿ä¸º100s)<br><br>// Setç±»å‹<br>// Redisä¸­çš„Setç±»å‹ä¸Javaä¸­çš„HashSetç±»ä¼¼, å¯çœ‹ä½œæ˜¯ä¸€ä¸ªvalueä¸ºnullçš„HashMap<br>// ç‰¹ç‚¹: æ— åº, å…ƒç´ ä¸å¯é‡å¤, æŸ¥æ‰¾é€Ÿåº¦å¿«, æ”¯æŒäº¤é›†ã€å¹¶é›†ã€å·®é›†<br>// SADD key member: åœ¨<span class="hljs-built_in">set</span>ä¸­æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ <br>// SREM key member: ç§»é™¤<span class="hljs-built_in">set</span>ä¸­çš„æŒ‡å®šå…ƒç´ <br>// SCARD key: è¿”å›<span class="hljs-built_in">set</span>ä¸­çš„å…ƒç´ ä¸ªæ•°<br>// SISMEMBER key member: åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨<span class="hljs-built_in">set</span>ä¸­<br>// SMEMBERS: è·å–<span class="hljs-built_in">set</span>ä¸­çš„æ‰€æœ‰å…ƒç´ <br>// SINTER key1 key2: æ±‚key1ä¸key2çš„äº¤é›†<br>// SDIFF key1 key2: æ±‚key1ä¸key2çš„å·®é›†<br>// SUNION key1 key2: æ±‚key1ä¸key2çš„å¹¶é›†<br><br>// SortedSetç±»å‹<br>// Redisä¸­çš„SortedSetä¸Javaä¸­çš„TreeSetç±»ä¼¼, ä½†åº•å±‚æ•°æ®ç»“æ„å·®åˆ«å¾ˆå¤§<br>// SortedSetä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ æœ‰ä¸€ä¸ªscoreå±æ€§, å¯åŸºäºscoreå±æ€§å¯¹å…ƒç´ æ’åº<br>// ç‰¹ç‚¹: å¯æ’åº, å…ƒç´ ä¸å¯é‡å¤; æŸ¥è¯¢é€Ÿåº¦å¿«<br>// ZADD key score member: æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ°sorted <span class="hljs-built_in">set</span>, è‹¥å·²å­˜åœ¨åˆ™æ›´æ–°å…¶scoreå€¼<br>// e.g ZADD students 99 Jack 99 Lucy<br>// ZREM key member: ç§»é™¤sorted <span class="hljs-built_in">set</span>ä¸­çš„æŒ‡å®šå…ƒç´ <br>// ZSCORE key member: è·å–sorted <span class="hljs-built_in">set</span>ä¸­çš„æŒ‡å®šå…ƒç´ çš„scoreå€¼<br>// ZRANK key member: è·å–sorted <span class="hljs-built_in">set</span>ä¸­çš„æŒ‡å®šå…ƒç´ çš„æ’å // é»˜è®¤å‡åº, ZRERANKè¡¨ç¤ºé™åº<br>// e.g ZRANK students Rose<br>// ZCARD key: è·å–sorted <span class="hljs-built_in">set</span>ä¸­çš„å…ƒç´ ä¸ªæ•°<br>// ZCOUNT key min max: è·å–scoreå€¼åœ¨æŒ‡å®šèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ ä¸ªæ•°<br>// ZINCRBY key increment member: ä½¿sorted <span class="hljs-built_in">set</span>ä¸­çš„æŒ‡å®šå…ƒç´ æŒ‰ç…§æŒ‡å®šæ­¥é•¿è‡ªå¢<br>// e.g ZINCRBY students 2 Lucy<br>// ZRANGE key min max: æŒ‰ç…§scoreæ’åºå, è·å–æŒ‡å®šæ’åèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ <br>// e.g ZREVRANGE students 0 2<br>// ZRANGEBYSCORE key min max: æŒ‰ç…§scoreæ’åºå, è·å–æŒ‡å®šscoreèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ <br>// e.g ZRANGEBYSCORE students 0 80<br>// ZDIFFã€ZINTERã€ZUNION: è·å–å·®é›†ã€äº¤é›†ã€å¹¶é›†<br></code></pre></td></tr></table></figure><p>å•çº¿ç¨‹, æ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§; ä½å»¶è¿Ÿ, é€Ÿåº¦å¿«(åŸºäºå†…å­˜, IOå¤šè·¯å¤ç”¨;è‰¯å¥½çš„ç¼–ç ); æ”¯æŒæ•°æ®æŒä¹…åŒ–; æ”¯æŒä¸»ä»é›†ç¾¤, åˆ†ç‰‡é›†ç¾¤;æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯</p><ul><li>MongoDB: æ–‡æ¡£ç±»å‹çš„éå…³ç³»å‹æ•°æ®åº“; æ”¯æŒçš„æ•°æ®ç»“æ„éå¸¸æ¾æ•£,æ˜¯ä¸€ç§ç±»ä¼¼äºJSONçš„æ ¼å¼, å«BSON, å¯å­˜å‚¨æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç±»å‹</li></ul><p>tableâ†’collection, rowâ†’document, columnâ†’field(æ•°æ®å­—æ®µ/åŸŸ)</p><p>åº”ç”¨åœºæ™¯: å¯¹æ•°æ®åº“é«˜å¹¶å‘è¯»å†™; å¯¹æµ·é‡æ•°æ®é«˜æ•ˆå­˜å‚¨ä¸è®¿é—®;å¯¹æ•°æ®åº“é«˜å¯æ‰©å±•æ€§çš„è¦æ±‚</p><p>ä¸‹è½½çš„package: MSI: éœ€è¦å®‰è£…; ZIP: è§£å‹ç¼©å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs bash">// åœ¨Windowsç³»ç»Ÿ<br>// å‘½ä»¤è¡Œå¯åŠ¨<br>mongod --dbpath=..\\data\\db // æ­¤å¤„data\\dbä¸ºå­˜å‚¨æ•°æ®åº“çš„ç›®å½•<br>// é…ç½®æ–‡ä»¶å¯åŠ¨<br>// åœ¨è§£å‹ç›®å½•ä¸‹æ–°å»ºconfigæ–‡ä»¶å¤¹, æ–‡ä»¶å¤¹ä¸­æ–°å»ºé…ç½®æ–‡ä»¶mongod.conf:<br>storage:<br>dbPath:..\\data\\db // æ­¤å¤„éœ€æ”¹å†™ä¸ºç»å¯¹è·¯å¾„<br>// å¯åŠ¨<br>mongod -f ../config/mongod.conf<br>// æˆ– mongod --config ../config/mongod.conf<br>// æ­¤å¤„mongodå¯¹åº”çš„åº”è¯¥æ˜¯è¯¥ç›®å½•ä¸‹çš„mongod.exeæ–‡ä»¶<br><br>// å¯åŠ¨å, è¿æ¥MongoDBæ•°æ®åº“(æ³¨æ„æ­¤æ—¶å¯åŠ¨çš„cmdçª—å£ä¸èƒ½å…³, éœ€æ–°å¼€ä¸€ä¸ªcmdçª—å£)<br>// è¿æ¥æœ¬åœ°çš„MongoDBæ•°æ®åº“<br>mongo // æˆ– mongo --host=127.0.0.1 --port=27017<br>// è¿æ¥æˆåŠŸåæµ‹è¯•: show dbs æˆ– show databases<br><br>// ä¹Ÿå¯é€šè¿‡Compass(MongoDBçš„å›¾å½¢åŒ–ç•Œé¢)è¿›è¡Œè¿æ¥ç­‰æ“ä½œ<br>&lt;https://www.mongodb.com/zh-cn/products/tools/compass&gt;<br><br>// åœ¨Linuxç³»ç»Ÿ<br>// é…ç½®æ–‡ä»¶å¯åŠ¨<br>// æ–°å»ºæ•°æ®å­˜å‚¨ç›®å½•<br><span class="hljs-built_in">mkdir</span> -p mongodb/single/data/db<br>// æ–°å»ºæ—¥å¿—å­˜å‚¨ç›®å½•<br><span class="hljs-built_in">mkdir</span> -p mongodb/single/log<br>// æ–°å»ºå¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶<br>vi mongodb/single/mongod.conf<br>systemLog:<br>destination: file // æ—¥å¿—è¾“å‡ºçš„ç›®æ ‡æŒ‡å®šä¸ºæ–‡ä»¶<br>path: <span class="hljs-string">&quot;mongodb/single/log/mongod.log&quot;</span><br>logAppend: <span class="hljs-literal">true</span> // å°†æ–°æ¡ç›®æ·»åŠ åˆ°ç°æœ‰æ—¥å¿—æ–‡ä»¶çš„æœ«å°¾<br>storage:<br>dbPath: <span class="hljs-string">&quot;mongodb/single/data/db&quot;</span><br>journal:<br>enabled: <span class="hljs-literal">true</span> // å¯ç”¨æŒä¹…æ€§æ—¥å¿—ä»¥ç¡®ä¿æ•°æ®æ–‡ä»¶çš„å¯æ¢å¤<br>processManagement:<br>fork: <span class="hljs-literal">true</span> // å¯ç”¨åœ¨åå°è¿è¡Œmongodè¿›ç¨‹çš„å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼<br>net:<br>bindIp: localhost, ... // æœåŠ¡å®ä¾‹ç»‘å®šçš„IP<br>// å¯¹äºè¿œç¨‹è¿æ¥, ç»‘å®šçš„ä¸æ˜¯è¿œç¨‹ä¸»æœºçš„IP, è€Œæ˜¯äº‘æœåŠ¡å™¨æ‰€åœ¨å±€åŸŸç½‘çš„IP<br>// æŸ¥çœ‹æ‰€åœ¨å±€åŸŸç½‘çš„IP: ifconfigå‘½ä»¤, ç¬¬äºŒè¡Œ<br>port: 27017<br><br>// å¯åŠ¨åæŸ¥çœ‹è¿›ç¨‹<br>ps -ef // æ˜¾ç¤ºç³»ç»Ÿä¸­æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯<br>ps -ef | grep mongod // æ˜¾ç¤ºç³»ç»Ÿä¸­æ‰€æœ‰ä¸mongodç›¸å…³çš„æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹<br><br>// è‹¥è¿æ¥ä¸ä¸Š, å¯èƒ½æ˜¯é˜²ç«å¢™æœªå…³é—­<br>systemctl status firewalld // æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€<br>systemctl stop firewalld // ä¸´æ—¶å…³é—­é˜²ç«å¢™<br>systemctl disabled firewalld // ç¦æ­¢å¯åŠ¨é˜²ç«å¢™<br><br>// å…³é—­<br>// æ–¹å¼1: ç›´æ¥<span class="hljs-built_in">kill</span>è¿›ç¨‹<br>// æ–¹å¼2: æ ‡å‡†å…³é—­æ–¹å¼, æ•°æ®ä¸å®¹æ˜“å‡ºé”™<br>mongo --port=27017 // å®¢æˆ·ç«¯ç™»å½•, é€šè¿‡localhost<br>use admin // åˆ‡æ¢åˆ°adminåº“<br>db.shutdownServer() // å…³é—­æœåŠ¡<br>// åˆ›å»º/åˆ‡æ¢æ•°æ®åº“, æ–°å»ºçš„æ•°æ®åº“ä½äºå†…å­˜è€Œä¸æ˜¯ç£ç›˜(æŒä¹…åŒ–)<br>use ...<br>// æŸ¥çœ‹å½“å‰æ•°æ®åº“<br>db<br><br>// æœ‰ç‰¹æ®Šä½œç”¨çš„æ•°æ®åº“<br>admin: <span class="hljs-string">&quot;root&quot;</span>æ•°æ®åº“, è‹¥å°†ä¸€ä¸ªç”¨æˆ·æ·»åŠ åˆ°è¿™ä¸ªæ•°æ®åº“, è¿™ä¸ªç”¨æˆ·å¯ä»¥ç»§æ‰¿æ‰€æœ‰æ•°æ®åº“çš„æƒé™<br>// ä¸€äº›ç‰¹å®šçš„æœåŠ¡å™¨ç«¯å‘½ä»¤ä¹Ÿåªèƒ½åœ¨è¿™ä¸ªæœåŠ¡å™¨ç«¯è¿è¡Œ<br><span class="hljs-built_in">local</span>: ç”¨æ¥å­˜å‚¨é™äºæœ¬åœ°å•å°æœåŠ¡å™¨çš„ä»»æ„é›†åˆ, æ°¸è¿œä¸ä¼šè¢«å¤åˆ¶<br>config: å½“Mongoç”¨äºåˆ†ç‰‡è®¾ç½®æ—¶, configæ•°æ®åº“åœ¨å†…éƒ¨ä½¿ç”¨, ç”¨äºä¿å­˜åˆ†ç‰‡çš„ç›¸å…³ä¿¡æ¯<br><br>db.dropDatabase() // åˆ é™¤æ•°æ®åº“<br>// åˆ›å»ºé›†åˆ<br>db.createCollection(<span class="hljs-string">&quot;mycollection&quot;</span>) // æ˜¾å¼<br>// æŸ¥è¯¢é›†åˆ<br>show collections<br>// åˆ é™¤é›†åˆ<br>db.mycollection.drop() // db.é›†åˆåç§°.drop()<br>// æ–‡æ¡£æ’å…¥<br>db.mycomment.insert(<br>&#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;10&quot;</span>, <span class="hljs-string">&quot;datetime&quot;</span>: new Date(),<br> <span class="hljs-string">&quot;likenum&quot;</span>: NumberInt(5), <span class="hljs-string">&quot;state&quot;</span>: null&#125;<br>)<br>// è‹¥mycommenté›†åˆä¸å­˜åœ¨, åˆ™ä¼šéšå¼åˆ›å»º<br>// mongoä¸­çš„æ•°å­—é»˜è®¤ä¸ºdouble, è‹¥è¦å­˜å‚¨æ•´å‹åˆ™éœ€ä½¿ç”¨NumberInt(...)<br>// å½“å‰æ—¥æœŸ: new Date()<br>// è‹¥æ’å…¥æ•°æ®æ²¡æœ‰æŒ‡å®š_id, åˆ™ä¼šè‡ªåŠ¨ç”Ÿæˆä¸»é”®å€¼<br><br>// æŸ¥è¯¢æ–‡æ¡£<br>db.comment.find()<br>// å¤šæ¡æ–‡æ¡£æ’å…¥<br>db.mycomment.insert(<br>[&#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;10&quot;</span>, <span class="hljs-string">&quot;datetime&quot;</span>: new Date(),<br> <span class="hljs-string">&quot;likenum&quot;</span>: NumberInt(1), <span class="hljs-string">&quot;state&quot;</span>: null&#125;,<br> &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;zhangsan1&quot;</span>, <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;10&quot;</span>, <span class="hljs-string">&quot;datetime&quot;</span>: new Date(),<br> <span class="hljs-string">&quot;likenum&quot;</span>: NumberInt(2), <span class="hljs-string">&quot;state&quot;</span>: null&#125;,<br> &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;zhangsan2&quot;</span>, <span class="hljs-string">&quot;userid&quot;</span>: <span class="hljs-string">&quot;11&quot;</span>, <span class="hljs-string">&quot;datetime&quot;</span>: new Date(),<br> <span class="hljs-string">&quot;likenum&quot;</span>: NumberInt(3), <span class="hljs-string">&quot;state&quot;</span>: null&#125;]<br>)<br>db.mycomment.find(&#123;userid: <span class="hljs-string">&quot;10&quot;</span>&#125;)<br>db.mycomment.findOne(&#123;userid: <span class="hljs-string">&quot;10&quot;</span>&#125;)<br>// æŸ¥è¯¢ç»“æœåªæ˜¾ç¤ºname, userid<br>db.mycomment.find(&#123;userid: <span class="hljs-string">&quot;10&quot;</span>&#125;, &#123;name: 1, userid: 1&#125;)<br></code></pre></td></tr></table></figure><p>SQL(å…³ç³»å‹æ•°æ®åº“): ç»“æ„åŒ–; å…³è”çš„; æ ‡å‡†çš„SQLæŸ¥è¯¢; å­˜å‚¨åœ¨ç£ç›˜</p><p>NoSQL(éå…³ç³»å‹æ•°æ®åº“): éç»“æ„åŒ–(key-value; document; graph);éå…³è”çš„(å…³è”éœ€è¦è‡ªå·±å®šä¹‰); éSQLæŸ¥è¯¢; å­˜å‚¨åœ¨å†…å­˜</p>]]></content>
    
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Database</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Node.js Basics (2)</title>
    <link href="/2023/12/03/Node.js%20Basics%20(2)/"/>
    <url>/2023/12/03/Node.js%20Basics%20(2)/</url>
    
    <content type="html"><![CDATA[<ul><li>JSONP: æµè§ˆå™¨ç«¯é€šè¿‡&lt;script&gt;æ ‡ç­¾çš„srcå±æ€§, è¯·æ±‚æœåŠ¡å™¨ä¸Šçš„æ•°æ®;æœåŠ¡å™¨è¿”å›ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨</li></ul><p>å¿…é¡»åœ¨é…ç½®CORSä¸­é—´ä»¶ä¹‹å‰å£°æ˜JSONPçš„æ¥å£</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/api/jsonp&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">const</span> funcName = req.<span class="hljs-property">query</span>.<span class="hljs-property">callback</span> <span class="hljs-comment">// å¾—åˆ°å‡½æ•°åç§°</span><br><span class="hljs-keyword">const</span> data = &#123;<span class="hljs-attr">name</span>: <span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>&#125; <span class="hljs-comment">// å®šä¹‰è¦å‘é€ç»™å®¢æˆ·ç«¯çš„æ•°æ®å¯¹è±¡</span><br><span class="hljs-keyword">const</span> scriptStr = <span class="hljs-string">&quot;$&#123;funcName&#125;($&#123;JSON.stringify(data)&#125;)&quot;</span><br>res.<span class="hljs-title function_">send</span>(scriptStr)<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>mysqlæ¨¡å—</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs jsx">npm init -y<br>npm install mysql<br><br><span class="hljs-keyword">const</span> mysql = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;mysql&quot;</span>)<br><span class="hljs-keyword">const</span> db = mysql.<span class="hljs-title function_">createPool</span>(&#123;<br><span class="hljs-attr">host</span>: <span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br><span class="hljs-attr">user</span>: <span class="hljs-string">&quot;zyliang&quot;</span>,<br><span class="hljs-attr">password</span>: <span class="hljs-string">&quot;123123123&quot;</span>,<br><span class="hljs-attr">database</span>: <span class="hljs-string">&quot;my_db_01&quot;</span><br>&#125;)<br><br><span class="hljs-comment">// è°ƒç”¨db.query()å‡½æ•°, æŒ‡å®šè¦æ‰§è¡Œçš„SQLè¯­å¥</span><br><span class="hljs-comment">// select</span><br>db.<span class="hljs-title function_">query</span>(<span class="hljs-string">&quot;select * from users&quot;</span>, <span class="hljs-function">(<span class="hljs-params">err, results</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(results)<br>&#125;)<br><span class="hljs-comment">// insert</span><br><span class="hljs-keyword">const</span> user = &#123;<span class="hljs-attr">username</span>: <span class="hljs-string">&quot;test1&quot;</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;test2&quot;</span>&#125;<br><span class="hljs-keyword">const</span> sqlStr = <span class="hljs-string">&quot;insert into users (username, password) values (?, ?)&quot;</span><br>db.<span class="hljs-title function_">query</span>(sqlStr, [user.<span class="hljs-property">username</span>, user.<span class="hljs-property">password</span>], <span class="hljs-function">(<span class="hljs-params">err, results</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>)<br><span class="hljs-keyword">if</span>(results.<span class="hljs-property">affectedRows</span> === <span class="hljs-number">1</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;æ’å…¥æ•°æ®æˆåŠŸ&quot;</span>)<br>&#125;<br>&#125;)<br><span class="hljs-comment">// ç®€åŒ–å†™æ³•</span><br><span class="hljs-keyword">const</span> sqlStr = <span class="hljs-string">&quot;insert into users set ?&quot;</span><br>db.<span class="hljs-title function_">query</span>(sqlStr, user, <span class="hljs-function">(<span class="hljs-params">err, results</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>)<br><span class="hljs-keyword">if</span>(results.<span class="hljs-property">affectedRows</span> === <span class="hljs-number">1</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;æ’å…¥æ•°æ®æˆåŠŸ&quot;</span>)<br>&#125;<br>&#125;)<br><span class="hljs-comment">// update</span><br><span class="hljs-keyword">const</span> user = &#123;<span class="hljs-attr">id</span>: <span class="hljs-number">7</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">&quot;test1&quot;</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">&quot;test2&quot;</span>&#125;<br><span class="hljs-keyword">const</span> sqlStr = <span class="hljs-string">&quot;update users set username=?, password=? where id=?&quot;</span><br>db.<span class="hljs-title function_">query</span>(sqlStr, [user.<span class="hljs-property">username</span>, user.<span class="hljs-property">password</span>, user.<span class="hljs-property">id</span>], <span class="hljs-function">(<span class="hljs-params">err, results</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>)<br><span class="hljs-keyword">if</span>(results.<span class="hljs-property">affectedRows</span> === <span class="hljs-number">1</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;æ›´æ–°æ•°æ®æˆåŠŸ&quot;</span>)<br>&#125;<br>&#125;)<br><span class="hljs-comment">// ç®€åŒ–å†™æ³•</span><br><span class="hljs-keyword">const</span> sqlStr = <span class="hljs-string">&quot;update users set ? where id=?&quot;</span><br>db.<span class="hljs-title function_">query</span>(sqlStr, [user, user.<span class="hljs-property">id</span>], <span class="hljs-function">(<span class="hljs-params">err, results</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>)<br><span class="hljs-keyword">if</span>(results.<span class="hljs-property">affectedRows</span> === <span class="hljs-number">1</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;æ›´æ–°æ•°æ®æˆåŠŸ&quot;</span>)<br>&#125;<br>&#125;)<br><span class="hljs-comment">// delete</span><br><span class="hljs-keyword">const</span> sqlStr = <span class="hljs-string">&quot;delete from users where id=?&quot;</span><br>db.<span class="hljs-title function_">query</span>(sqlStr, <span class="hljs-number">7</span>, <span class="hljs-function">(<span class="hljs-params">err, results</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>)<br><span class="hljs-keyword">if</span>(results.<span class="hljs-property">affectedRows</span> === <span class="hljs-number">1</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;åˆ é™¤æ•°æ®æˆåŠŸ&quot;</span>)<br>&#125;<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>webå¼€å‘æ¨¡å¼:</li></ul><p>åŸºäºæœåŠ¡å™¨æ¸²æŸ“(ä¼ ç»Ÿ): æœåŠ¡å™¨å‘é€ç»™å®¢æˆ·ç«¯çš„HTMLé¡µé¢,æ˜¯åœ¨æœåŠ¡å™¨é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥åŠ¨æ€ç”Ÿæˆçš„; ç”¨Sessionè®¤è¯æœºåˆ¶æ¥è¿›è¡Œèº«ä»½è®¤è¯</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsx">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;index.html&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">const</span> user = &#123;<span class="hljs-attr">name</span>: <span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>&#125;<br><span class="hljs-keyword">const</span> html = <span class="hljs-string">&quot;&lt;h1&gt;å§“å: $&#123;user.name&#125;, å¹´é¾„: $&#123;user.age&#125;&lt;/h1&gt;&quot;</span><br>res.<span class="hljs-title function_">send</span>(html)<br>&#125;)<br></code></pre></td></tr></table></figure><p>åŸºäºå‰åç«¯åˆ†ç¦»(æ–°å‹): åç«¯åªè´Ÿè´£æä¾›APIæ¥å£, å‰ç«¯ä½¿ç”¨Ajaxè°ƒç”¨æ¥å£;ç”¨JWTè®¤è¯æœºåˆ¶æ¥è¿›è¡Œèº«ä»½è®¤è¯</p><p>HTTPåè®®çš„æ— çŠ¶æ€æ€§: æ¯æ¬¡HTTPè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„,æœåŠ¡å™¨ä¸ä¼šä¿ç•™æ¯æ¬¡HTTPè¯·æ±‚çš„çŠ¶æ€</p><p>Cookie: å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸­çš„ä¸€æ®µä¸è¶…è¿‡4KBçš„å­—ç¬¦ä¸², æœ‰1ä¸ªåç§°, 1ä¸ªå€¼,å‡ ä¸ªå¯é€‰å±æ€§(å…³äºæœ‰æ•ˆæœŸ, å®‰å…¨æ€§, ä½¿ç”¨èŒƒå›´),ç±»ä¼¼äºç°å®ä¸­ä¼šå‘˜å¡èº«ä»½è®¤è¯æ–¹å¼</p><p>Cookieç‰¹æ€§: è‡ªåŠ¨å‘é€(å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶); åŸŸåç‹¬ç«‹; æœ‰è¿‡æœŸæ—¶é™;4KBé™åˆ¶</p><p>å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¯·æ±‚æœåŠ¡å™¨æ—¶, æœåŠ¡å™¨é€šè¿‡å“åº”å¤´çš„å½¢å¼,å‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªèº«ä»½éªŒè¯ç›¸å…³çš„Cookie,å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨å°†Cookieä¿å­˜åœ¨æµè§ˆå™¨ä¸­; å½“å®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚æœåŠ¡å™¨,æµè§ˆå™¨ä¼šè‡ªåŠ¨å°†èº«ä»½éªŒè¯ç›¸å…³çš„Cookieé€šè¿‡è¯·æ±‚å¤´çš„å½¢å¼å‘é€ç»™æœåŠ¡å™¨,æœåŠ¡å™¨å³å¯éªŒè¯å®¢æˆ·ç«¯çš„èº«ä»½</p><ul><li>express-sessionä¸­é—´ä»¶: ä½¿ç”¨sessionè®¤è¯</li></ul><p>å±€é™æ€§: Cookieä¸æ”¯æŒè·¨åŸŸè®¿é—®, å‰ç«¯è·¨åŸŸè¯·æ±‚åç«¯æ¥å£æ—¶éœ€è¦é¢å¤–é…ç½®</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs jsx">npm install express-session<br><span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express-session&quot;</span>)<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">session</span>(&#123;<br><span class="hljs-attr">secret</span>: <span class="hljs-string">&quot;keyboard cat&quot;</span>, <span class="hljs-comment">// å¯ä¸ºä»»æ„å­—ç¬¦ä¸²</span><br><span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">true</span><br>&#125;))<br><span class="hljs-comment">// express-sessionä¸­é—´ä»¶é…ç½®æˆåŠŸå, å³å¯é€šè¿‡req.sessionæ¥è®¿é—®å’Œä½¿ç”¨sessionå¯¹è±¡</span><br><span class="hljs-comment">// ä»è€Œå­˜å‚¨ç”¨æˆ·çš„å…³é”®ä¿¡æ¯</span><br><br><span class="hljs-comment">// ç™»å½•çš„APIæ¥å£</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/api/login&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">username</span> !== <span class="hljs-string">&quot;admin&quot;</span> || req.<span class="hljs-property">body</span>.<span class="hljs-property">password</span> !== <span class="hljs-string">&quot;123123123&quot;</span>)&#123;<br><span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(&#123;<span class="hljs-attr">status</span>: <span class="hljs-number">1</span>, msg=<span class="hljs-string">&quot;ç™»é™†å¤±è´¥&quot;</span>&#125;)<br>&#125;<br>req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span> = req.<span class="hljs-property">body</span><br>req.<span class="hljs-property">session</span>.<span class="hljs-property">islogin</span> = <span class="hljs-literal">true</span><br>res.<span class="hljs-title function_">send</span>(&#123;<span class="hljs-attr">status</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;ç™»é™†æˆåŠŸ&quot;</span>&#125;)<br>&#125;)<br><span class="hljs-comment">// è·å–ç”¨æˆ·å§“åçš„æ¥å£</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/api/username&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(!req.<span class="hljs-property">session</span>.<span class="hljs-property">islogin</span>)&#123;<br><span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(&#123;<span class="hljs-attr">status</span>: <span class="hljs-number">1</span>, msg=<span class="hljs-string">&quot;fail&quot;</span>&#125;)<br>&#125;<br>res.<span class="hljs-title function_">send</span>(&#123;<span class="hljs-attr">status</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-attr">username</span>: req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">username</span>&#125;)<br>&#125;)<br><span class="hljs-comment">// é€€å‡ºç™»å½•çš„æ¥å£</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/api/logout&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>req.<span class="hljs-property">session</span>.<span class="hljs-title function_">destroy</span>()<br>res.<span class="hljs-title function_">send</span>(&#123;<span class="hljs-attr">status</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">msg</span>: <span class="hljs-string">&quot;é€€å‡ºç™»é™†æˆåŠŸ&quot;</span>&#125;)<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>JWT(JSON Web Token): ç›®å‰æœ€æµè¡Œçš„è·¨åŸŸè®¤è¯è§£å†³æ–¹æ¡ˆ</li></ul><p>JWTç”±ä¸‰éƒ¨åˆ†ç»„æˆ: Header(å¤´éƒ¨), Payload(æœ‰æ•ˆè½½è·,å³ç”¨æˆ·ä¿¡æ¯ç»è¿‡åŠ å¯†åç”Ÿæˆçš„å­—ç¬¦ä¸²), Signature(ç­¾å),ä¸‰è€…ä¹‹é—´é€šè¿‡â€.â€è¿›è¡Œåˆ†éš”</p><p>ä½¿ç”¨: å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„JWTå,é€šå¸¸ä¼šå°†å…¶å­˜å‚¨åœ¨localStorageæˆ–sessionStorageä¸­</p><p>ä¹‹åå®¢æˆ·ç«¯æ¯æ¬¡ä¸æœåŠ¡å™¨é€šä¿¡, éƒ½è¦å¸¦ä¸Šè¿™ä¸ªJWTå­—ç¬¦ä¸²è¿›è¡Œèº«ä»½éªŒè¯,æœ€å¥½æ˜¯æŠŠJWTæ”¾åœ¨HTTPè¯·æ±‚å¤´çš„Authorizationå­—æ®µä¸­</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-title class_">Authorization</span>: <span class="hljs-title class_">Bearer</span> &lt;token&gt;<br>npm install jsonwebtoken express-jwt<br><span class="hljs-comment">// jsonwebtokenç”¨äºç”ŸæˆJWTå­—ç¬¦ä¸²</span><br><span class="hljs-comment">// express-jwtç”¨äºå°†JWTå­—ç¬¦ä¸²è§£æè¿˜åŸæˆJSONå¯¹è±¡</span><br><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;jsonwebtoken&quot;</span>)<br><span class="hljs-keyword">const</span> expressJWT = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express-jwt&quot;</span>)<br><span class="hljs-comment">// ä¸ºé˜²æ­¢JWTå­—ç¬¦ä¸²åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­è¢«ç ´è§£, éœ€è¦ä¸“é—¨å®šä¹‰ä¸€ä¸ªç”¨äºåŠ å¯†å’Œè§£å¯†çš„secretå¯†é’¥</span><br><span class="hljs-comment">// ç”ŸæˆJWTå­—ç¬¦ä¸²æ—¶éœ€è¦ç”¨secretå¯†é’¥å¯¹ç”¨æˆ·ä¿¡æ¯è¿›è¡ŒåŠ å¯†</span><br><span class="hljs-comment">// å½“æŠŠJWTå­—ç¬¦ä¸²è§£æè¿˜åŸæˆJSONå¯¹è±¡æ—¶éœ€è¦ä½¿ç”¨secretå¯†é’¥è¿›è¡Œè§£å¯†</span><br><br><span class="hljs-comment">// ç™»é™†æˆåŠŸå, è°ƒç”¨jwt.sign()æ–¹æ³•æ¥ç”ŸæˆJWTå­—ç¬¦ä¸², å¹¶é€šè¿‡tokenå±æ€§å‘é€ç»™å®¢æˆ·ç«¯</span><br><span class="hljs-keyword">const</span> secretKey = <span class="hljs-string">&quot;zyliang666&quot;</span><br><span class="hljs-comment">// å‚æ•°: ç”¨æˆ·çš„ä¿¡æ¯å¯¹è±¡, åŠ å¯†çš„å¯†é’¥, é…ç½®å¯¹è±¡</span><br><span class="hljs-keyword">const</span> tokenStr jwt.<span class="hljs-title function_">sign</span>(&#123;<span class="hljs-attr">username</span>: userinfo.<span class="hljs-property">username</span>&#125;, secretKey, &#123;<span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&quot;1h&quot;</span>&#125;)<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/api/login&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123;<br>res.<span class="hljs-title function_">send</span>(&#123;<br><span class="hljs-attr">status</span>: <span class="hljs-number">200</span>,<br><span class="hljs-attr">message</span>: <span class="hljs-string">&quot;ç™»é™†æˆåŠŸ&quot;</span>,<br><span class="hljs-attr">token</span>: jwt.<span class="hljs-title function_">sign</span>(&#123;<span class="hljs-attr">username</span>: userinfo.<span class="hljs-property">username</span>&#125;, secretKey, &#123;<span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&quot;1h&quot;</span>&#125;)<br>&#125;)<br>&#125;)<br><br><span class="hljs-comment">// å°†JWTå­—ç¬¦ä¸²è¿˜åŸä¸ºJSONå¯¹è±¡</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">expressJWT</span>(&#123;<span class="hljs-attr">secret</span>: secretKey&#125;)).<span class="hljs-title function_">unless</span>(&#123;<span class="hljs-attr">path</span>: [<span class="hljs-regexp">/^\\/</span>api\\<span class="hljs-comment">//]&#125;)</span><br><span class="hljs-comment">// ä»¥&quot;/api&quot;å¼€å¤´çš„ä¸éœ€è¦è®¿é—®æƒé™; ä»¥&quot;/my&quot;å¼€å¤´çš„éœ€è¦è®¿é—®æƒé™</span><br><span class="hljs-comment">// é…ç½®express-jwtä¸­é—´ä»¶å, å°±èƒ½æŠŠè§£æå‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯æŒ‚è½½åˆ°req.userå±æ€§ä¸Š</span><br><span class="hljs-comment">// å¯é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–ç”¨æˆ·ä¿¡æ¯</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/admin/getinfo&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">user</span>)<br>res.<span class="hljs-title function_">send</span>(&#123;<br><span class="hljs-attr">status</span>: <span class="hljs-number">200</span>,<br><span class="hljs-attr">message</span>: <span class="hljs-string">&quot;è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ&quot;</span>,<br><span class="hljs-attr">data</span>: req.<span class="hljs-property">user</span>,<br>&#125;)<br>&#125;)<br><br><span class="hljs-comment">// å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span>(err.<span class="hljs-property">name</span> === <span class="hljs-string">&quot;UnauthorizedError&quot;</span>)&#123;<br><span class="hljs-keyword">return</span> res.<span class="hljs-title function_">send</span>(&#123;<br><span class="hljs-attr">status</span>: <span class="hljs-number">401</span>,<br><span class="hljs-attr">message</span>: <span class="hljs-string">&quot;æ— æ•ˆtoken&quot;</span>,<br>&#125;)<br>&#125;<br>res.<span class="hljs-title function_">send</span>(&#123;<br><span class="hljs-attr">status</span>: <span class="hljs-number">500</span>,<br><span class="hljs-attr">message</span>: <span class="hljs-string">&quot;æœªçŸ¥é”™è¯¯&quot;</span><br>&#125;)<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>AJAX: å¼‚æ­¥çš„JSå’ŒXML; å¯ä»¥åœ¨æµè§ˆå™¨ä¸­å‘æœåŠ¡å™¨å‘é€å¼‚æ­¥è¯·æ±‚;ä¼˜åŠ¿ä¸ºä¸éœ€è¦åˆ·æ–°å°±èƒ½è·å–æ•°æ®</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-comment">// reqæ˜¯å¯¹è¯·æ±‚æŠ¥æ–‡çš„å°è£…, resæ˜¯å¯¹å“åº”æŠ¥æ–‡çš„å°è£…</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/server&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-comment">// è®¾ç½®å“åº”å¤´, å…è®¸è·¨åŸŸ</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®å“åº”ä½“</span><br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;hello ajax&quot;</span>)<br>&#125;)<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/server&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-comment">// è®¾ç½®å“åº”å¤´, å…è®¸è·¨åŸŸ</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br><span class="hljs-comment">// è®¾ç½®å“åº”ä½“</span><br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;hello ajax post&quot;</span>)<br>&#125;)<br><br>app.<span class="hljs-title function_">all</span>(<span class="hljs-string">&quot;/json-server&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// è®¾ç½®å“åº”å¤´, å…è®¸è·¨åŸŸ</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>)<br><span class="hljs-comment">// å“åº”å¤´</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>)<br><span class="hljs-comment">// å“åº”ä¸€ä¸ªæ•°æ®</span><br><span class="hljs-keyword">const</span> data = &#123;<br><span class="hljs-attr">name</span>: <span class="hljs-string">&quot;mytest&quot;</span><br>&#125;;<br><span class="hljs-keyword">let</span> str = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data);<br><span class="hljs-comment">// è®¾ç½®å“åº”ä½“</span><br>res.<span class="hljs-title function_">send</span>(str);<br>&#125;)<br><br>app.<span class="hljs-title function_">all</span>(<span class="hljs-string">&quot;/jquery-server&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>)<br><span class="hljs-comment">// res.send(&quot;hello jquery ajax&quot;);</span><br><span class="hljs-keyword">const</span> data = &#123;<span class="hljs-attr">name</span>: <span class="hljs-string">&quot;test&quot;</span>&#125;;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));<br>&#125;)<br><br>app.<span class="hljs-title function_">all</span>(<span class="hljs-string">&quot;/axios-server&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>);<br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>)<br><span class="hljs-keyword">const</span> data = &#123;<span class="hljs-attr">name</span>: <span class="hljs-string">&quot;test&quot;</span>&#125;;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));<br>&#125;)<br>...<br>&lt;body&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>ç‚¹å‡»å‘é€è¯·æ±‚<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;result&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementByTagName</span>(<span class="hljs-string">&quot;button&quot;</span>)[<span class="hljs-number">0</span>];</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">const</span> result = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;result&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// const result = document.querySelector(&quot;#result&quot;);</span></span></span><br><span class="language-javascript"><span class="language-xml">btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// console.log(&quot;test&quot;);</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// åˆ›å»ºå¯¹è±¡</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// åˆå§‹åŒ–, è®¾ç½®è¯·æ±‚æ–¹æ³•å’Œurl</span></span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;&lt;http://127.0.0.1:8000/server&gt;&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// è§£å†³ajaxçš„ieç¼“å­˜é—®é¢˜</span></span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;&lt;http://127.0.0.1:8000/server?t=&gt;&quot;</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// è®¾ç½®è¯·æ±‚å‚æ•°</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// xhr.open(&quot;GET&quot;, &quot;&lt;http://127.0.0.1:8000/server?a=100&amp;b=200&amp;c=300&gt;&quot;);</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// å‘é€</span></span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-title function_">send</span>();</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// äº‹ä»¶ç»‘å®š, å¤„ç†æœåŠ¡å™¨è¿”å›çš„ç»“æœ</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// readystateæ˜¯xhrå¯¹è±¡ä¸­çš„å±æ€§, è¡¨ç¤ºçŠ¶æ€0 1 2 3 4</span></span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>)&#123; <span class="hljs-comment">// æ­¤æ—¶æœåŠ¡å™¨ç«¯å·²è¿”å›æ‰€æœ‰ç»“æœ</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// 200-299å‡ä¸ºæˆåŠŸ</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// å“åº”è¡Œ</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">status</span>); <span class="hljs-comment">// çŠ¶æ€ç </span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">statusText</span>); <span class="hljs-comment">// çŠ¶æ€å­—ç¬¦ä¸²</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-title function_">getAllResponseHeaders</span>()); <span class="hljs-comment">// æ‰€æœ‰å“åº”å¤´</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">response</span>);</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// è®¾ç½®resultçš„æ–‡æœ¬</span></span></span><br><span class="language-javascript"><span class="language-xml">result.<span class="hljs-property">innerHTML</span> = xhr.<span class="hljs-property">response</span>; <span class="hljs-comment">// å³hello ajax</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml"></span></span><br><span class="language-javascript"><span class="language-xml">result.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;mouseover&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;&lt;http://127.0.0.1:8000/server&gt;&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-title function_">send</span>();</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// xhr.send(&quot;a=100&amp;b=200&amp;c=300&quot;) // Request Payload</span></span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">result.<span class="hljs-property">innerHTML</span> = xhr.<span class="hljs-property">response</span>; <span class="hljs-comment">// å³hello ajax post</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// ç»‘å®šé”®ç›˜æŒ‰ä¸‹äº‹ä»¶</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">window</span>.<span class="hljs-property">onkeydown</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;&lt;http://127.0.0.1:8000/json-server&gt;&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-title function_">send</span>();</span></span><br><span class="language-javascript"><span class="language-xml">xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// result.innerHTML = xhr.response;</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// æ‰‹åŠ¨å¯¹æ•°æ®è¿›è¡Œè½¬æ¢</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// let data = JSON.parse(xhr.response);</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// console.log(data);</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// result.innerHTML = data.name;</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// è‡ªåŠ¨è½¬æ¢</span></span></span><br><span class="language-javascript"><span class="language-xml">result.<span class="hljs-property">innerHTML</span> = xhr.<span class="hljs-property">response</span>.<span class="hljs-property">name</span>;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">$(<span class="hljs-string">&quot;button&quot;</span>).<span class="hljs-title function_">eq</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">$.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;&lt;http://127.0.0.1:8000/jquery-server&gt;&quot;</span>, &#123;<span class="hljs-attr">a</span>:<span class="hljs-number">100</span>, <span class="hljs-attr">b</span>:<span class="hljs-number">200</span>&#125;, <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">$(<span class="hljs-string">&quot;button&quot;</span>).<span class="hljs-title function_">eq</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">$.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;&lt;http://127.0.0.1:8000/jquery-server&gt;&quot;</span>, &#123;<span class="hljs-attr">a</span>:<span class="hljs-number">100</span>, <span class="hljs-attr">b</span>:<span class="hljs-number">200</span>&#125;, <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);</span></span><br><span class="language-javascript"><span class="language-xml">&#125;, <span class="hljs-string">&quot;json&quot;</span>)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">$(<span class="hljs-string">&quot;button&quot;</span>).<span class="hljs-title function_">eq</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">$.<span class="hljs-title function_">ajax</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">url</span>: <span class="hljs-string">&quot;&lt;http://127.0.0.1:8000/jquery-server&gt;&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">data</span>: &#123;<span class="hljs-attr">a</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">200</span>&#125;,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">type</span>: <span class="hljs-string">&quot;GET&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// æˆåŠŸçš„å›è°ƒ</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// è¶…æ—¶æ—¶é—´</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">timeout</span>: <span class="hljs-number">2000</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// å¤±è´¥çš„å›è°ƒ</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">error</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;å‡ºé”™&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// å¤´ä¿¡æ¯</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">headers</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">c</span>: <span class="hljs-number">300</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">d</span>: <span class="hljs-number">400</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml"></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-keyword">const</span> btns = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;button&quot;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">btns[<span class="hljs-number">0</span>].<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/axios-server&quot;</span>, &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// url</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">params</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">id</span>: <span class="hljs-number">100</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">vip</span>: <span class="hljs-number">7</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-comment">// è¯·æ±‚å¤´å‚æ•°</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">headers</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">name</span>: <span class="hljs-string">&quot;test&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">age</span>: <span class="hljs-number">20</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">btns[<span class="hljs-number">0</span>].<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/axios-server&quot;</span>, &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">username</span>: <span class="hljs-string">&quot;zyliang&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">password</span>: <span class="hljs-string">&quot;zyliang666&quot;</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;, &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">params</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">id</span>: <span class="hljs-number">100</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">vip</span>: <span class="hljs-number">7</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">headers</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">name</span>: <span class="hljs-string">&quot;test&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">age</span>: <span class="hljs-number">20</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">btns[<span class="hljs-number">0</span>].<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-title function_">axios</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">url</span>: <span class="hljs-string">&quot;/axios-server&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">params</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">id</span>: <span class="hljs-number">100</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">vip</span>: <span class="hljs-number">7</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">headers</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">name</span>: <span class="hljs-string">&quot;test&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">age</span>: <span class="hljs-number">20</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">data</span>: &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">username</span>: <span class="hljs-string">&quot;zyliang&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">password</span>: <span class="hljs-string">&quot;zyliang666&quot;</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml">&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">status</span>); <span class="hljs-comment">// å“åº”çŠ¶æ€ç </span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">statusText</span>); <span class="hljs-comment">// å“åº”çŠ¶æ€å­—ç¬¦ä¸²</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">headers</span>); <span class="hljs-comment">// å“åº”çŠ¶æ€å¤´</span></span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>); <span class="hljs-comment">// å“åº”çŠ¶æ€ä½“</span></span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml">...</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Node.js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaWeb Basics</title>
    <link href="/2023/11/24/JavaWeb%20Basics/"/>
    <url>/2023/11/24/JavaWeb%20Basics/</url>
    
    <content type="html"><![CDATA[<p>æ•°æ®åº“é©±åŠ¨(é©±åŠ¨jaråŒ…, ä¸‹è½½åæ”¾åˆ°é¡¹ç›®ä¸‹çš„libç›®å½•å¹¶æ·»åŠ åˆ°libraries):å¯¹äºJDBCä¸­å®šä¹‰æ¥å£(ä¸€å¥—æ“ä½œæ‰€æœ‰å…³ç³»å‹æ•°æ®åº“çš„è§„åˆ™)çš„å®ç°ç±»JavaWebBasics</p><p>åˆ›å»ºä¸€ä¸ªEmpty Project; åœ¨Project Structureä¸­è®¾ç½®Project SDKå’ŒProjectlanguage level; åœ¨Project Structureä¸­Add New Module, ç„¶åé€‰ä¸­Javaå³å¯;æ–°å»ºlibç›®å½•, å°†jaråŒ…æ”¾åœ¨è¯¥ç›®å½•, å³é”®jaråŒ…, é€‰ä¸­Add as Library,åœ¨levelå¤„é€‰ä¸­Module Library</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// æ³¨å†Œé©±åŠ¨</span><br><span class="hljs-comment">// MySQL5ä¹‹åçš„é©±åŠ¨åŒ…, å¯ä»¥çœç•¥æ³¨å†Œé©±åŠ¨çš„æ­¥éª¤</span><br>Class.forName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br><span class="hljs-comment">// è·å–è¿æ¥</span><br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/mydb1&quot;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zyliang&quot;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test123&quot;</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, username, password);<br><span class="hljs-comment">// å®šä¹‰SQLè¯­å¥</span><br><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update account set money=20000 where id=1&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">sql2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;update account set money=20000 where id=2&quot;</span>;<br><span class="hljs-comment">// è·å–æ‰§è¡ŒSQLçš„å¯¹è±¡</span><br><span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();<br><span class="hljs-comment">// é¢„ç¼–è¯‘çš„æ‰§è¡ŒSQLçš„å¯¹è±¡, é˜²æ­¢æ³¨å…¥</span><br><span class="hljs-comment">// PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="hljs-comment">// æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹çš„å¯¹è±¡</span><br><span class="hljs-comment">// CallableStatement stmt = conn.prepareCall(sql);</span><br><span class="hljs-comment">// æ‰§è¡ŒSQL</span><br><span class="hljs-comment">// å¼€å¯äº‹åŠ¡--</span><br><span class="hljs-keyword">try</span>&#123;<br>conn.setAutoCommit(<span class="hljs-literal">false</span>);<br><span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> stmt.executeUpdate(sql); <span class="hljs-comment">// è¿”å›çš„countä¸ºæ‰§è¡Œè¯­å¥å—å½±å“çš„è¡Œæ•°</span><br><span class="hljs-type">int</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> stmt.executeUpdate(sql2);<br><span class="hljs-comment">// å¤„ç†è¿”å›ç»“æœ</span><br>System.out.println(count);<br>System.out.println(count2);<br><span class="hljs-comment">// æäº¤äº‹åŠ¡--</span><br>conn.commit();<br>&#125;<span class="hljs-keyword">catch</span>(Exception throwables)&#123;<br>conn.rollback();<br>throwables.printStackTrace();<br>&#125;<br><span class="hljs-comment">// é‡Šæ”¾èµ„æº</span><br>stmt.close();<br>conn.close();<br><span class="hljs-comment">// å¼€å¯äº‹åŠ¡</span><br>setAutoCommit(<span class="hljs-type">boolean</span> autoCommit) <span class="hljs-comment">// trueä¸ºè‡ªåŠ¨æäº¤, falseä¸ºæ‰‹åŠ¨æäº¤</span><br><span class="hljs-comment">// æäº¤äº‹åŠ¡</span><br>commit()<br><span class="hljs-comment">// å›æ»šäº‹åŠ¡</span><br>rollback()<br><span class="hljs-comment">// æ‰§è¡ŒDML(ä¿®æ”¹è¡¨)ã€DDLè¯­å¥(ä¿®æ”¹åº“)</span><br>executeUpdate(sql) <span class="hljs-comment">// è¿”å›int</span><br><span class="hljs-comment">// æ‰§è¡ŒDQL(æŸ¥è¯¢è¡¨)è¯­å¥</span><br>executeQuery(sql) <span class="hljs-comment">// è¿”å›ResultSet</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span>&#123;<br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br><span class="hljs-keyword">private</span> String name;<br><span class="hljs-keyword">private</span> <span class="hljs-type">double</span> money;<br>&#125;<br><br>Class.forName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br><br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/mydb1&quot;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zyliang&quot;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test123&quot;</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, username, password);<br><br><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from account&quot;</span>;<br><span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();<br><br><span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery(sql);<br>List&lt;Account&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br><span class="hljs-keyword">while</span>(rs.next())&#123; <span class="hljs-comment">// å…‰æ ‡å‘ä¸‹ç§»åŠ¨ä¸€è¡Œ, å¹¶åˆ¤æ–­å½“å‰è¡Œæ˜¯å¦æœ‰æ•°æ®</span><br><span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>();<br><span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> rs.getInt(<span class="hljs-string">&quot;id&quot;</span>);<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> rs.getString(<span class="hljs-string">&quot;name&quot;</span>);<br><span class="hljs-type">double</span> <span class="hljs-variable">money</span> <span class="hljs-operator">=</span> rs.getDouble(<span class="hljs-string">&quot;money&quot;</span>);<br>account.setId(id);<br>account.setName(name);<br>account.setMoney(money);<br>list.add(account);<br>&#125;<br><br>System.out.println(list);<br><br><span class="hljs-comment">// é‡Šæ”¾èµ„æº</span><br>rs.close();<br>stmt.close();<br>conn.close();<br></code></pre></td></tr></table></figure><p>ç›®å½•æ–‡ä»¶: application.properties, sql.jar;å¯èƒ½è¦ä¿®æ”¹application.propertiesæ–‡ä»¶ä¸­çš„usernameå’Œpassword</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java">jaråŒ…å¯åŠ¨: java -jar .\\sql.jar<br><br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/mydb1&quot;</span><br><span class="hljs-comment">// é€šè¿‡è®¾ç½®useServerPrepStmts=trueå¼€å¯é¢„ç¼–è¯‘åŠŸèƒ½</span><br><span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/mydb1?useSSL=false&amp;useServerPrepStmts=true&quot;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zyliang&quot;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test123&quot;</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, username, password);<br><br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zhangsan&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">pwd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123&quot;</span>; <span class="hljs-comment">// sqlæ³¨å…¥: &quot;&#x27;&#x27; or &#x27;1&#x27; = &#x27;1&#x27;&quot;</span><br><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;select * from tb_user where username = &#x27;&quot;</span>+name+<span class="hljs-string">&quot;&#x27; and password = &#x27;&quot;</span>+pwd+<span class="hljs-string">&quot;&#x27;&quot;</span>;<br><span class="hljs-comment">// é˜²æ­¢sqlæ³¨å…¥</span><br><span class="hljs-comment">//String sql = &quot;select * from tb_user where username = ? and password = ?&quot;;</span><br><span class="hljs-comment">// PreparedStatement pstmt = conn.prepareStatement(sql); // é¢„ç¼–è¯‘SQLæ€§èƒ½æ›´é«˜</span><br><span class="hljs-comment">// pstmt.setString(1, name);</span><br><span class="hljs-comment">// pstmt.setString(2, pwd);</span><br><span class="hljs-comment">// pstmt.executeQuery();</span><br><span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();<br><span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery(sql);<br><span class="hljs-keyword">if</span>(rs.next())&#123;<br>System.out.println(<span class="hljs-string">&quot;ç™»é™†æˆåŠŸ&quot;</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>System.out.println(<span class="hljs-string">&quot;ç™»å½•å¤±è´¥&quot;</span>);<br>&#125;<br><br>rs.close();<br>stmt.close();<br>conn.close();<br><br><span class="hljs-comment">// é…ç½®MySQLæ‰§è¡Œæ—¥å¿—(é‡å¯MySQLæœåŠ¡åç”Ÿæ•ˆ) (é€šè¿‡services.msc)</span><br>log-output=FILE<br>general-log=<span class="hljs-number">1</span><br>general_log_file=<span class="hljs-string">&quot;D:\\mysql.log&quot;</span><br>slow-query-log=<span class="hljs-number">1</span><br>slow_query_log_file=<span class="hljs-string">&quot;D:\\mysql_slow.log&quot;</span><br>long_query_time=<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><ul><li>æ•°æ®åº“è¿æ¥æ± </li></ul><p>ä¼˜ç‚¹: èµ„æºé‡ç”¨; æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦;é¿å…æ•°æ®åº“è¿æ¥é—æ¼(è®¾ç½®äº†æœ€å¤§ç©ºé—²æ—¶é—´)</p><p>æ ‡å‡†æ¥å£: DataSource</p><p>Connection getConnection()</p><p>å¸¸ç”¨çš„æ•°æ®åº“è¿æ¥æ± : DBCP; C3P0; Druid</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1.å¯¼å…¥jaråŒ…(e.g druid-1.1.12.jar)</span><br><span class="hljs-comment">// 2.å®šä¹‰é…ç½®æ–‡ä»¶</span><br><span class="hljs-comment">// druid.properties, å†…å®¹å¦‚ä¸‹</span><br><span class="hljs-comment">// driverClassName=com.mysql.jdbc.Driver</span><br><span class="hljs-comment">// url=jdbc:mysql://127.0.0.1:3306/mydb1</span><br><span class="hljs-comment">// username=zyliang</span><br><span class="hljs-comment">// password=123123</span><br><span class="hljs-comment">// initialSize=5 // åˆå§‹åŒ–è¿æ¥æ•°é‡</span><br><span class="hljs-comment">// maxActive=10 // æœ€å¤§è¿æ¥æ•°</span><br><span class="hljs-comment">// maxWait=3000 // æœ€å¤§ç­‰å¾…æ—¶é—´</span><br><span class="hljs-comment">// 3.åŠ è½½é…ç½®æ–‡ä»¶</span><br><span class="hljs-type">Properties</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>prop.load(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;jdbc-demo/src/druid.properties&quot;</span>));<br><span class="hljs-comment">// 4.è·å–æ•°æ®åº“è¿æ¥æ± å¯¹è±¡</span><br><span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> DruidDataSourceFactory.createDataSource(prop);<br><span class="hljs-comment">// 5.è·å–è¿æ¥</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> dataSource.getConnection();<br>System.out.println(connection);<br></code></pre></td></tr></table></figure><ul><li>Maven: ä¸“é—¨ç”¨äºç®¡ç†å’Œæ„å»ºJavaé¡¹ç›®çš„å·¥å…·</li></ul><p>poe.xml: Mavençš„é…ç½®æ–‡ä»¶</p><p>æä¾›äº†ä¸€å¥—æ ‡å‡†åŒ–çš„é¡¹ç›®ç»“æ„ã€æ„å»ºæµç¨‹(ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…ã€å‘å¸ƒ)ã€ä¾èµ–ç®¡ç†æœºåˆ¶</p><p>ä¸åŒIDEä¹‹é—´åˆ›å»ºçš„é¡¹ç›®ç»“æ„ä¸ä¸€æ ·</p><p>main/java: æºä»£ç Javaæ–‡ä»¶ç›®å½•; main/resources: æºä»£ç é…ç½®æ–‡ä»¶ç›®å½•</p><p>Run Maven â†’ compile / package â€¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// é€šè¿‡Mavenæ¥å¯¼å…¥jaråŒ…</span><br>&lt;dependencies&gt;<br>&lt;dependency&gt;<br>&lt;groupId&gt;mysql&lt;groupId&gt;<br>&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;<br>&lt;version&gt;<span class="hljs-number">5.1</span><span class="hljs-number">.32</span>&lt;/version&gt;<br>&lt;/dependency&gt;<br>&lt;/dependencies&gt;<br></code></pre></td></tr></table></figure><p>æœ¬åœ°ä»“åº“: æœ¬æœºä¸Šçš„ä¸€ä¸ªç›®å½•</p><p>ä¸­å¤®ä»“åº“: ç”±Mavenå›¢é˜Ÿç»´æŠ¤çš„å…¨çƒå”¯ä¸€çš„ä»“åº“</p><p>åœ°å€: https://repo1.maven.org/maven2/</p><p>è¿œç¨‹ä»“åº“(ç§æœ): ä¸€èˆ¬ç”±å…¬å¸å›¢é˜Ÿæ­å»ºçš„ç§æœ‰ä»“åº“</p><p>è‹¥æ­å»ºè¿œç¨‹ä»“åº“, åˆ™jaråŒ…çš„æŸ¥æ‰¾é¡ºåºå˜ä¸º: æœ¬åœ°ä»“åº“â†’è¿œç¨‹ä»“åº“â†’ä¸­å¤®ä»“åº“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Mavenå®‰è£…é…ç½®</span><br><span class="hljs-comment">// 1.è§£å‹apache-maven-3.6.1.rar (æˆ–.zip)</span><br><span class="hljs-comment">// è§£å‹å®Œæˆå³å®‰è£…æˆåŠŸ</span><br><span class="hljs-comment">// binç›®å½•: ä¸€äº›äºŒè¿›åˆ¶çš„å¯æ‰§è¡Œæ–‡ä»¶; boot: Mavenéœ€è¦ç”¨åˆ°çš„ä¸€ä¸ªjaråŒ…</span><br><span class="hljs-comment">// confç›®å½•: ä¸€äº›é…ç½®æ–‡ä»¶; lib: Mavenä¾èµ–çš„ä¸€äº›jaråŒ…</span><br><span class="hljs-comment">// 2. é…ç½®ç¯å¢ƒå˜é‡MAVEN_HOMEä¸ºå®‰è£…è·¯å¾„çš„binç›®å½•</span><br><span class="hljs-comment">// æ–°å»ºç³»ç»Ÿå˜é‡MAVEN_HOME(å˜é‡å), å˜é‡å€¼ä¸ºapache-maven-3.6.1çš„è·¯å¾„</span><br><span class="hljs-comment">// ç¼–è¾‘ç¯å¢ƒå˜é‡, æ–°å»º%MAVEN_HOME%\\bin</span><br><span class="hljs-comment">// åœ¨cmdåœ¨æŸ¥çœ‹ç‰ˆæœ¬: mvn -version</span><br><span class="hljs-comment">// 3.é…ç½®æœ¬åœ°ä»“åº“: ä¿®æ”¹conf/settings.xmlä¸­çš„&lt;localRepository&gt;ä¸ºä¸€ä¸ªæŒ‡å®šç›®å½•</span><br><span class="hljs-comment">// 4.é…ç½®é˜¿é‡Œäº‘ç§æœ: ä¿®æ”¹conf/settings.xmlä¸­çš„&lt;mirror&gt;æ ‡ç­¾, ä¸ºå…¶æ·»åŠ å¦‚ä¸‹çš„å­æ ‡ç­¾:</span><br>&lt;mirror&gt;<br>&lt;id&gt;alimaven&lt;/id&gt;<br>&lt;name&gt;aliyun maven&lt;/name&gt;<br>&lt;url&gt;&lt;http:<span class="hljs-comment">//maven.aliyun.com/nexus/content/groups/public/&gt;&lt;/url&gt;</span><br>&lt;mirrorOf&gt;central&lt;/mirrorOf&gt;<br>&lt;/mirror&gt;<br><span class="hljs-comment">// å¸¸ç”¨å‘½ä»¤ (maven-projectç›®å½•ä¸‹æœ‰srcç›®å½•å’Œpoe.xmlæ–‡ä»¶)</span><br>mvn compile<br><span class="hljs-comment">// æ‰§è¡Œååœ¨maven-projectç›®å½•ä¸‹ä¼šå‡ºç°ä¸€ä¸ªtargetç›®å½•, è‹¥ä¸ºåˆæ¬¡æ‰§è¡Œ, åˆ™è¿˜ä¼šä¸‹è½½æ’ä»¶</span><br>mvn clean<br><span class="hljs-comment">// æ‰§è¡Œåä¼šåˆ é™¤targetç›®å½•</span><br>mvn <span class="hljs-keyword">package</span><br><span class="hljs-comment">// æ‰§è¡Œååœ¨maven-projectç›®å½•ä¸‹ä¼šå‡ºç°ä¸€ä¸ªtargetç›®å½•, ç›®å½•ä¸‹æœ‰é¡¹ç›®å†…å®¹çš„jaråŒ…</span><br>mvn test<br><span class="hljs-comment">// æ‰§è¡Œtestç›®å½•ä¸‹çš„ä»£ç </span><br>mvn install<br><span class="hljs-comment">// å°†å½“å‰é¡¹ç›®çš„jaråŒ…å®‰è£…åˆ°æœ¬åœ°ä»“åº“</span><br><br><span class="hljs-comment">// Mavenå¯¹é¡¹ç›®æ„å»ºçš„ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ä¸º3å¥—</span><br><span class="hljs-comment">// clean(æ¸…ç†å·¥ä½œ): pre-clean, clean, post-clean</span><br><span class="hljs-comment">// default(æ ¸å¿ƒå·¥ä½œ): compile, test, package, install</span><br><span class="hljs-comment">// site(äº§ç”ŸæŠ¥å‘Š, å‘å¸ƒç«™ç‚¹): pre-site, site, post-site</span><br></code></pre></td></tr></table></figure><p>IDEAé…ç½®Maven: Fileâ†’settingâ†’æœç´¢Mavenâ†’é€‰æ‹©Mavenä¸­çš„Maven homepathã€User settings fileâ†’Apply</p><p>Mavenåæ ‡(èµ„æºçš„å”¯ä¸€æ ‡è¯†)çš„ä¸»è¦ç»„æˆ:</p><p>groupId: å½“å‰Mavené¡¹ç›®éš¶å±ç»„ç»‡çš„åç§°</p><p>artifactId: å½“å‰Mavené¡¹ç›®çš„åç§°</p><p>version: å½“å‰é¡¹ç›®ç‰ˆæœ¬å·</p><p>åˆ›å»ºMavené¡¹ç›®: Project Structureä¸­é€‰ä¸­Modulesâ†’é€‰æ‹©Mavené¡¹ç›®,å³å¯åˆ›å»º</p><p>å¯¼å…¥Mavené¡¹ç›®: ç‚¹å‡»Mavenç•Œé¢ä¸­çš„â€+â€œ(Add Maven Projects),æ‰¾åˆ°éœ€è¦å¯¼å…¥çš„é¡¹ç›®çš„poe.xmlæ–‡ä»¶, åŒå‡»å³å¯å¯¼å…¥</p><p>è‹¥æ²¡æœ‰Mavenç•Œé¢: Viewâ†’Appearanceâ†’Tool Window Bars</p><p>å¥½ç”¨çš„Mavenæ’ä»¶: Maven Helper</p><p>é…ç½®è‡ªåŠ¨ç”Ÿæ•ˆ: Fileâ†’Settingsâ†’Build Toolsâ†’Any changes</p><p>å¯¼å…¥æœ¬åœ°ä»“åº“jaråŒ…çš„å¿«æ·æ–¹å¼: åœ¨poe.xmlæ–‡ä»¶ä¸­æŒ‰Alt+Insert</p><ul><li>JavaEEçš„ä¸‰å±‚æ¶æ„:è¡¨ç°å±‚ã€ä¸šåŠ¡å±‚ã€æŒä¹…å±‚(è´Ÿè´£å°†æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“çš„é‚£ä¸€å±‚ä»£ç )</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Node.js Basics (1)</title>
    <link href="/2023/11/20/Node.js%20Basics%20(1)/"/>
    <url>/2023/11/20/Node.js%20Basics%20(1)/</url>
    
    <content type="html"><![CDATA[<p>åœ¨Node.jsç¯å¢ƒä¸­æ‰§è¡ŒJavaScriptä»£ç : åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥: node jsæ–‡ä»¶</p><ul><li>fs: Node.jsä¸­æä¾›çš„ç”¨äºæ“ä½œæ–‡ä»¶çš„æ¨¡å—</li></ul><p>fs.readFile(): è¯»å–æŒ‡å®šæ–‡ä»¶ä¸­çš„å†…å®¹</p><p>fs.writeFile(): å‘æŒ‡å®šçš„æ–‡ä»¶ä¸­å†™å…¥å†…å®¹</p><p>å¯¼å…¥fsæ¨¡å—: const fs = require(â€™fsâ€™)</p><ul><li>fs.readFile()</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)<br>fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&quot;./test.txt&quot;</span>, <span class="hljs-string">&quot;utf8&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">err, dataStr</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;-----&quot;</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dataStr)<br>&#125;)<br><span class="hljs-comment">// functionä¸ºå›è°ƒå‡½æ•°, errä¸ºè¯»å–å¤±è´¥çš„ç»“æœ(è‹¥è¯»å–æˆåŠŸåˆ™ä¸ºnull), </span><br><span class="hljs-comment">// dataSträ¸ºè¯»å–æˆåŠŸçš„ç»“æœ(è‹¥è¯»å–æˆåŠŸåˆ™ä¸ºundefined)</span><br><br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)<br>fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&quot;./test.txt&quot;</span>, <span class="hljs-string">&quot;utf8&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">err, dataStr</span>)&#123;<br><span class="hljs-keyword">if</span>(err)&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;è¯»å–å¤±è´¥&quot;</span> + err.<span class="hljs-property">message</span>)<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;è¯»å–æˆåŠŸ&quot;</span> + dataStr)<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>fs.writeFile()</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>)<br>fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">&quot;./test.txt&quot;</span>, <span class="hljs-string">&quot;hello world&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>)&#123;<br><span class="hljs-comment">// è‹¥æˆåŠŸå†™å…¥, errä¸ºnull</span><br><span class="hljs-keyword">if</span>(err)&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;å†™å…¥å¤±è´¥&quot;</span> + err.<span class="hljs-property">message</span>)<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;å†™å…¥æˆåŠŸ&quot;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>path: Node.jsæä¾›çš„ç”¨äºå¤„ç†è·¯å¾„çš„æ¨¡å—</li></ul><p>path.join(): å°†å¤šä¸ªè·¯å¾„ç‰‡æ®µæ‹¼æ¥æˆä¸€ä¸ªå®Œæ•´çš„è·¯å¾„å­—ç¬¦ä¸²</p><p>path.basename(): å°†æ–‡ä»¶åä»è·¯å¾„å­—ç¬¦ä¸²ä¸­è§£æå‡ºæ¥</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>)<br><span class="hljs-comment">// &quot;./test.txt&quot; -&gt; path.join(__dirname, &quot;test.txt&quot;)</span><br><br><span class="hljs-keyword">const</span> fpath = <span class="hljs-string">&quot;/a/b/c/index.html&quot;</span><br><span class="hljs-keyword">var</span> fullname = path.<span class="hljs-title function_">basename</span>(fpath)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fullname) <span class="hljs-comment">// index.html</span><br><span class="hljs-keyword">var</span> nameWithoutExt = path.<span class="hljs-title function_">basename</span>(fpath, <span class="hljs-string">&quot;.html&quot;</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nameWithoutExt) <span class="hljs-comment">// index</span><br></code></pre></td></tr></table></figure><ul><li>http: Node.jsæä¾›çš„ç”¨æ¥åˆ›å»ºwebæœåŠ¡å™¨çš„æ¨¡å—</li></ul><p>é€šè¿‡http.createServer()å¯ä»¥æŠŠä¸€å°æ™®é€šçš„ç”µè„‘å˜æˆä¸€å°webæœåŠ¡å™¨</p><p>æœåŠ¡å™¨ä¸æ™®é€šç”µè„‘çš„åŒºåˆ«: æœåŠ¡å™¨ä¸Šå®‰è£…äº†webæœåŠ¡å™¨è½¯ä»¶(IIS,Apacheç­‰)</p><p>å°†æœ¬æœºå½“ä½œæœåŠ¡å™¨è¿›è¡Œè®¿é—®: 127.0.0.1 (å¯¹åº”çš„åŸŸåä¸ºlocalhost)</p><p>urlåœ¨çš„80ç«¯å£å¯ä»¥è¢«çœç•¥</p><ul><li>åˆ›å»ºåŸºæœ¬çš„webæœåŠ¡å™¨</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// å¯¼å…¥httpæ¨¡å—</span><br><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;http&quot;</span>)<br><span class="hljs-comment">// åˆ›å»ºwebæœåŠ¡å™¨å®ä¾‹</span><br><span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>()<br><span class="hljs-comment">// ä¸ºæœåŠ¡å™¨å®ä¾‹ç»‘å®šrequestäº‹ä»¶, ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚</span><br>server.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;request&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123; <span class="hljs-comment">// å½“æœåŠ¡å™¨è¢«è®¿é—®æ—¶è§¦å‘</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Someone visits our web server.&quot;</span>)<br>&#125;)<br><span class="hljs-comment">// å¯åŠ¨æœåŠ¡å™¨</span><br>server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123; <span class="hljs-comment">// æŒ‡å®šæœåŠ¡å™¨è¿è¡Œçš„ç«¯å£</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;server is running at &lt;http://127.0.0.1:8080&gt;&quot;</span>)<br>&#125;)<br><span class="hljs-comment">// é€šè¿‡è¿è¡Œ node jsæ–‡ä»¶ æ¥å¯åŠ¨</span><br><br>server.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;request&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req</span>) =&gt;</span> &#123;<br><span class="hljs-comment">// reqæ˜¯è¯·æ±‚å¯¹è±¡, åŒ…å«äº†ä¸å®¢æˆ·ç«¯ç›¸å…³çš„æ•°æ®ä¸å±æ€§, å¦‚:</span><br><span class="hljs-comment">// req.url: å®¢æˆ·ç«¯è¯·æ±‚çš„urlåœ°å€</span><br><span class="hljs-comment">// req.method: å®¢æˆ·ç«¯çš„methodçš„è¯·æ±‚ç±»å‹</span><br><span class="hljs-keyword">const</span> str = <span class="hljs-string">&quot;Your request url is $&#123;req.url&#125;, and request method is $&#123;req.method&#125;&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str)<br>&#125;)<br><br>server.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;request&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-comment">// resæ˜¯å“åº”å¯¹è±¡, åŒ…å«äº†ä¸æœåŠ¡å™¨ç›¸å…³çš„æ•°æ®ä¸å±æ€§, å¦‚:</span><br><span class="hljs-keyword">const</span> str = <span class="hljs-string">&quot;Your request url is $&#123;req.url&#125;, and request method is $&#123;req.method&#125;&quot;</span><br>res.<span class="hljs-title function_">end</span>(str) <span class="hljs-comment">// å‘å®¢æˆ·ç«¯å‘é€æŒ‡å®šçš„å†…å®¹, å¹¶ç»“æŸè¿™æ¬¡è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹</span><br>&#125;)<br><br><span class="hljs-comment">// è§£å†³ä¸­æ–‡ä¹±ç çš„é—®é¢˜</span><br>server.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;request&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">const</span> str = <span class="hljs-string">&quot;æ‚¨è¯·æ±‚çš„urlåœ°å€æ˜¯$&#123;req.url&#125;, è¯·æ±‚çš„methodç±»å‹ä¸º$&#123;req.method&#125;&quot;</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;text/html; charset=utf-8&quot;</span>)<br>res.<span class="hljs-title function_">end</span>(str)<br>&#125;)<br><br><span class="hljs-comment">// æ ¹æ®ä¸åŒçš„urlå“åº”ä¸åŒçš„htmlå†…å®¹</span><br>server.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;request&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">const</span> url = req.<span class="hljs-property">url</span><br><span class="hljs-keyword">let</span> content = <span class="hljs-string">&#x27;&lt;h1&gt;404 Not found!&lt;/h1&gt;&#x27;</span><br><span class="hljs-keyword">if</span>(url === <span class="hljs-string">&quot;/&quot;</span> || url === <span class="hljs-string">&quot;/index/html&quot;</span>)&#123;<br>content = <span class="hljs-string">&quot;&lt;h1&gt;é¦–é¡µ&lt;/h1&gt;&quot;</span><br>&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(url === <span class="hljs-string">&quot;/about.html&quot;</span>)&#123;<br>content = <span class="hljs-string">&quot;&lt;h1&gt;å…³äºé¡µé¢&lt;/h1&gt;&quot;</span><br>&#125;<br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;text/html; charset=utf-8&quot;</span>)<br>res.<span class="hljs-title function_">end</span>(content)<br>&#125;)<br><br><span class="hljs-comment">// åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å—</span><br><span class="hljs-keyword">const</span> custom = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./custom.js&quot;</span>)<br><span class="hljs-comment">// ä½¿ç”¨requireæ–¹æ³•åŠ è½½å…¶å®ƒæ¨¡å—æ—¶, ä¼šæ‰§è¡Œè¢«åŠ è½½æ¨¡å—ä¸­çš„ä»£ç </span><br></code></pre></td></tr></table></figure><p>æ¨¡å—ä½œç”¨åŸŸ: å¯é¿å…å…¨å±€å˜é‡æ±¡æŸ“çš„é—®é¢˜</p><p>module: åœ¨æ¯ä¸ª.jsè‡ªå®šä¹‰æ¨¡å—ä¸­éƒ½æœ‰ä¸€ä¸ªmoduleå¯¹è±¡,å­˜å‚¨äº†ä¸å½“å‰æ¨¡å—æœ‰å…³çš„ä¿¡æ¯</p><p>å¤–ç•Œç”¨require()æ–¹æ³•å¯¼å…¥è‡ªå®šä¹‰æ¨¡å—æ—¶,å¾—åˆ°çš„å°±æ˜¯module.exportsæ‰€æŒ‡å‘çš„å¯¹è±¡</p><p>åœ¨ä¸€ä¸ªè‡ªå®šä¹‰æ¨¡å—ä¸­, é»˜è®¤æƒ…å†µä¸‹, module.exports = {}</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// åœ¨module.exportså¯¹è±¡ä¸ŠæŒ‚è½½å±æ€§/æ–¹æ³•</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-property">username</span> = <span class="hljs-string">&quot;zhangsan&quot;</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Hello!&quot;</span>)<br>&#125;<br><span class="hljs-keyword">const</span> age = <span class="hljs-number">20</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-property">age</span> = age<br></code></pre></td></tr></table></figure><p>exports: é»˜è®¤æƒ…å†µä¸‹,exportså’Œmodule.exportsæŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡(ä»£ç ç®€åŒ–)</p><p>åŒ…å…±äº«å¹³å°:</p><p>https://www.npmjs.com(æœç´¢)</p><p>https://registry.npmjs.org(ä¸‹è½½)</p><p>åŒ…ç®¡ç†å·¥å…·:</p><p>Node Package Manager(npmåŒ…ç®¡ç†å·¥å…·), éšNode.jsçš„å®‰è£…ä¸€å¹¶å®‰è£…</p><p>ç”¨npmå®‰è£…åŒ…: npm install åŒ…å®Œæ•´åç§° / npm i åŒ…å®Œæ•´åç§°</p><p>åˆæ¬¡è£…åŒ…å®Œæˆå,é¡¹ç›®æ–‡ä»¶å¤¹ä¸‹ä¼šå‡ºç°node_modulesæ–‡ä»¶å¤¹å’Œpackage-lock.jsoné…ç½®æ–‡ä»¶;node_modulesæ–‡ä»¶å¤¹ç”¨äºå­˜æ”¾æ‰€æœ‰å·²å®‰è£…åˆ°é¡¹ç›®ä¸­çš„åŒ…;package-lock.jsoné…ç½®æ–‡ä»¶ç”¨äºè®°å½•node_modulesç›®å½•ä¸‹æ¯ä¸€ä¸ªåŒ…çš„ä¸‹è½½ä¿¡æ¯(åŒ…å,ç‰ˆæœ¬å·, ä¸‹è½½åœ°å€ç­‰)</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jsx">npm i moment <span class="hljs-comment">// è‡ªåŠ¨å®‰è£…ç‰ˆæœ¬æœ€æ–°çš„åŒ…</span><br>npm i moment@<span class="hljs-number">2.22</span><span class="hljs-number">.2</span> <span class="hljs-comment">// å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„åŒ…</span><br><span class="hljs-comment">// å¤§ç‰ˆæœ¬.åŠŸèƒ½ç‰ˆæœ¬.Bugä¿®å¤ç‰ˆæœ¬</span><br></code></pre></td></tr></table></figure><p>åŒ…ç®¡ç†é…ç½®æ–‡ä»¶(package.json): ä½äºé¡¹ç›®æ ¹ç›®å½•,è®°å½•ä¸é¡¹ç›®æœ‰å…³çš„ä¸€äº›é…ç½®ä¿¡æ¯,ä»è€Œæ–¹ä¾¿åœ¨å‰”é™¤node_modulesç›®å½•ä¹‹ååœ¨å›¢é˜Ÿæˆå‘˜ä¹‹é—´å…±äº«é¡¹ç›®æºä»£ç </p><p>æ³¨: åœ¨é¡¹ç›®å¼€å‘ä¸­, æŠŠnode_modulesæ–‡ä»¶å¤¹æ·»åŠ åˆ°.gitignoreå¿½ç•¥æ–‡ä»¶ä¸­</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// åœ¨æ‰§è¡Œå‘½ä»¤æ‰€å¤„çš„ç›®å½•ä¸­, å¿«é€Ÿæ–°å»ºpackage.jsonæ–‡ä»¶</span><br>npm init -y <span class="hljs-comment">// é¡¹ç›®æ–‡ä»¶å¤¹ä¸èƒ½å‡ºç°ä¸­æ–‡å’Œç©ºæ ¼</span><br><span class="hljs-comment">// ä½¿ç”¨npmå‘½ä»¤å®‰è£…åŒ…æ—¶, npmåŒ…ç®¡ç†å·¥å…·ä¼šè‡ªåŠ¨å°†åŒ…åç§°ä¸ç‰ˆæœ¬å·è®°å½•åˆ°package.jsonæ–‡ä»¶ä¸­</span><br><br>npm install <span class="hljs-comment">// (æˆ– npm i)</span><br><span class="hljs-comment">// åŒ…ç®¡ç†å·¥å…·ä¼šè¯»å–package.jsonä¸­çš„dependenciesèŠ‚ç‚¹, å¹¶æ ¹æ®è¯»å–åˆ°çš„ä¾èµ–åç§°å’Œç‰ˆæœ¬å·</span><br><span class="hljs-comment">// ä¸€æ¬¡æ€§å®‰è£…è¿™äº›åŒ…</span><br><br>npm uninstall moment <span class="hljs-comment">// å¸è½½æŒ‡å®šçš„momentåŒ…</span><br></code></pre></td></tr></table></figure><p>å¯¹äºåªåœ¨é¡¹ç›®å¼€å‘é˜¶æ®µç”¨åˆ°ã€é¡¹ç›®ä¸Šçº¿ä¹‹åä¸ä¼šç”¨åˆ°çš„åŒ…,åº”è¯¥æŠŠè¿™äº›åŒ…è®°å½•åˆ°devDependenciesä¸­</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jsx">npm i monment -D <span class="hljs-comment">// æˆ– npm install moment --save-dev</span><br></code></pre></td></tr></table></figure><ul><li>æ¨¡å—çš„åŠ è½½æœºåˆ¶</li></ul><p>æ¨¡å—åœ¨ç¬¬ä¸€æ¬¡åŠ è½½åä¼šè¢«ç¼“å­˜, ç„¶åä¼˜å…ˆä»ç¼“å­˜ä¸­åŠ è½½</p><p>å†…ç½®æ¨¡å—(Node.jså®˜æ–¹æä¾›çš„æ¨¡å—)çš„åŠ è½½ä¼˜å…ˆçº§æœ€é«˜</p><p>åŠ è½½è‡ªå®šä¹‰æ¨¡å—æ—¶, å¿…é¡»æŒ‡å®šä»¥./æˆ–../å¼€å¤´çš„è·¯å¾„æ ‡è¯†ç¬¦</p><p>ç¬¬ä¸‰æ–¹æ¨¡å—ä»node_modulesæ–‡ä»¶å¤¹ä¸­è¿›è¡ŒåŠ è½½,å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ç¬¬ä¸‰æ–¹æ¨¡å—, åˆ™ç§»åŠ¨åˆ°å†ä¸Šä¸€å±‚çˆ¶ç›®å½•ä¸­è¿›è¡ŒåŠ è½½,ç›´åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ ¹ç›®å½•</p><ul><li>ç›®å½•ä½œä¸ºæ¨¡å—çš„åŠ è½½æœºåˆ¶</li></ul><p>åœ¨è¢«åŠ è½½çš„ç›®å½•ä¸­æŸ¥æ‰¾package.jsonæ–‡ä»¶, å¹¶å¯»æ‰¾mainå±æ€§,ä½œä¸ºrequireåŠ è½½çš„å…¥å£</p><p>è‹¥æ²¡æœ‰package.jsonæ–‡ä»¶æˆ–mainå…¥å£ä¸å­˜åœ¨æˆ–æ— æ³•è§£æ,åˆ™å°è¯•åŠ è½½ç›®å½•ä¸‹çš„index.jsæ–‡ä»¶; è‹¥éƒ½ä¸å­˜åœ¨, åˆ™åœ¨ç»ˆç«¯æ‰“å°é”™è¯¯ä¿¡æ¯</p><ul><li>Express: åŸºäºhttpå†…ç½®æ¨¡å—è¿›ä¸€æ­¥å°è£…å‡ºæ¥çš„, æ•ˆç‡æ›´é«˜,å¯ä»¥æ–¹ä¾¿ã€å¿«é€Ÿåœ°åˆ›å»ºwebç½‘ç«™æœåŠ¡å™¨æˆ–APIæ¥å£æœåŠ¡å™¨</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs jsx">npm i express@<span class="hljs-number">4.17</span><span class="hljs-number">.2</span><br><span class="hljs-comment">// å¯¼å…¥express</span><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>)<br><span class="hljs-comment">// åˆ›å»ºwebæœåŠ¡å™¨</span><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()<br><span class="hljs-comment">// è°ƒç”¨app.listen(ç«¯å£å·, å¯åŠ¨æˆåŠŸåçš„å›è°ƒå‡½æ•°), å¯åŠ¨æœåŠ¡å™¨</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">80</span>, <span class="hljs-function">() =&gt;</span> &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;express server is running at &lt;http://127.0.0.1&gt;&quot;</span>)<br>&#125;)<br><br><span class="hljs-comment">// é€šè¿‡app.get()æ¥ç›‘å¬å®¢æˆ·ç«¯GETè¯·æ±‚</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;è¯·æ±‚çš„urlåœ°å€&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<span class="hljs-comment">/*å¤„ç†å‡½æ•°*/</span>&#125;)<br><span class="hljs-comment">// reqä¸ºè¯·æ±‚å¯¹è±¡, resä¸ºå“åº”å¯¹è±¡, éƒ½åŒ…å«äº†ç›¸åº”çš„å±æ€§å’Œæ–¹æ³•</span><br><br><span class="hljs-comment">// é€šè¿‡app.post()æ¥ç›‘å¬å®¢æˆ·ç«¯çš„POSTè¯·æ±‚</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;è¯·æ±‚çš„urlåœ°å€&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<span class="hljs-comment">/*å¤„ç†å‡½æ•°*/</span>&#125;)<br><br><span class="hljs-comment">// å°†å†…å®¹å“åº”ç»™å®¢æˆ·ç«¯</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/user&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>res.<span class="hljs-title function_">send</span>(&#123;<span class="hljs-attr">name</span>: <span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>&#125;)<br>&#125;)<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/user&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;è¯·æ±‚æˆåŠŸ&quot;</span>)<br>&#125;)<br><br><span class="hljs-comment">// é€šè¿‡req.query(é»˜è®¤æƒ…å†µä¸‹ä¸ºç©ºå¯¹è±¡)è·å–å®¢æˆ·ç«¯å‘é€çš„æŸ¥è¯¢å‚æ•°</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">query</span>)<br>res.<span class="hljs-title function_">send</span>(req.<span class="hljs-property">query</span>)<br>&#125;)<br><span class="hljs-comment">// ç›´æ¥åœ¨ç½‘å€å¤„ä¼ å…¥æŸ¥è¯¢å‚æ•°</span><br><span class="hljs-comment">// &lt;http://127.0.0.1/?name=zhangsan&amp;age=20&gt;</span><br><br><span class="hljs-comment">// è·å–urlä¸­çš„åŠ¨æ€å‚æ•°</span><br><span class="hljs-comment">// é€šè¿‡req.paramså¯¹è±¡, å¯ä»¥è®¿é—®åˆ°urlä¸­é€šè¿‡:åŒ¹é…åˆ°çš„åŠ¨æ€å‚æ•°</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/user/:id/:name&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">params</span>)<br>res.<span class="hljs-title function_">send</span>(req.<span class="hljs-property">params</span>)<br>&#125;)<br><span class="hljs-comment">// è¯·æ±‚: &lt;http://127.0.0.1/user/2/zhangsan&gt;</span><br><span class="hljs-comment">// è¿”å›: &#123;</span><br><span class="hljs-comment">//        &quot;id&quot;: &quot;2&quot;</span><br><span class="hljs-comment">//        &quot;name&quot;: &quot;zhangsan&quot;</span><br><span class="hljs-comment">//       &#125;</span><br><br><span class="hljs-comment">// express.static(): åˆ›å»ºä¸€ä¸ªé™æ€èµ„æºæœåŠ¡å™¨</span><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;public&quot;</span>)) <span class="hljs-comment">// å°†publicç›®å½•ä¸‹çš„æ–‡ä»¶å¯¹å¤–å¼€æ”¾è®¿é—®</span><br><span class="hljs-comment">// Expressåœ¨æŒ‡å®šçš„é™æ€ç›®å½•åœ¨æŸ¥æ‰¾æ–‡ä»¶, å¹¶å¯¹å¤–æä¾›æä¾›èµ„æºçš„è®¿é—®è·¯å¾„,</span><br><span class="hljs-comment">// å­˜æ”¾é™æ€æ–‡ä»¶çš„ç›®å½•åä¸ä¼šå‡ºç°åœ¨urlä¸­</span><br><span class="hljs-comment">// e.g &lt;http://localhost:3000/image/bg.jpg&gt;</span><br><br><span class="hljs-comment">// æ‰˜ç®¡å¤šä¸ªé™æ€èµ„æºç›®å½•, æ ¹æ®ç›®å½•çš„æ·»åŠ é¡ºåºè¿›è¡ŒæŸ¥æ‰¾</span><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;public&quot;</span>))<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;files&quot;</span>))<br><br><span class="hljs-comment">// æŒ‚è½½è·¯å¾„å‰ç¼€</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;public&quot;</span>, express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;public&quot;</span>))<br><span class="hljs-comment">// e.g &lt;http://localhost:3000/public/image/bg.jpg&gt;</span><br></code></pre></td></tr></table></figure><ul><li>nodemon: ç›‘å¬é¡¹ç›®æ–‡ä»¶çš„å˜åŠ¨, å½“ä»£ç è¢«ä¿®æ”¹åä¼šè‡ªåŠ¨é‡å¯é¡¹ç›®,ä¸éœ€è¦æ‰‹åŠ¨close</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jsx">npm install -g nodemon<br><span class="hljs-comment">// å¯åŠ¨æ—¶å°†node app.jsæ›¿æ¢ä¸ºnodemon app.jså³å¯</span><br></code></pre></td></tr></table></figure><ul><li>Expressä¸­çš„è·¯ç”±: å®¢æˆ·ç«¯è¯·æ±‚ä¸æœåŠ¡å™¨å¤„ç†å‡½æ•°ä¹‹é—´çš„æ˜ å°„å…³ç³»</li></ul><p>è·¯ç”±æœ‰3éƒ¨åˆ†ç»„æˆ: è¯·æ±‚çš„ç±»å‹, è¯·æ±‚çš„urlåœ°å€, å¤„ç†å‡½æ•°;è‹¥è¯·æ±‚çš„ç±»å‹ã€è¯·æ±‚çš„urlåœ°å€èƒ½å¤ŸåŒ¹é…æˆåŠŸ,åˆ™Expressä¼šå°†è¿™æ¬¡è¯·æ±‚äº¤ç»™å¯¹åº”çš„å¤„ç†å‡½æ•°æ¥å¤„ç†</p><ul><li>æ¨¡å—åŒ–è·¯ç”±: å°†è·¯ç”±æŠ½ç¦»ä¸ºå•ç‹¬çš„æ¨¡å—, è€Œä¸æ˜¯ç›´æ¥æŒ‚è½½åˆ°appä¸Š</li></ul><p>åˆ›å»ºè·¯ç”±æ¨¡å—å¯¹åº”çš„.jsæ–‡ä»¶; è°ƒç”¨express.Router()å‡½æ•°åˆ›å»ºè·¯ç”±å¯¹è±¡;</p><p>å‘è·¯ç”±å¯¹è±¡ä¸ŠæŒ‚è½½å…·ä½“çš„è·¯ç”±; ä½¿ç”¨module.exportså‘å¤–å…±äº«è·¯ç”±å¯¹è±¡;</p><p>ä½¿ç”¨app.use()å‡½æ•°æ³¨å†Œè·¯ç”±æ¨¡å—</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>)<br><span class="hljs-keyword">var</span> router = express.<span class="hljs-title class_">Router</span>()<br><br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/user/list&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Get user list.&quot;</span>)<br>&#125;)<br><br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/user/list&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Add new user.&quot;</span>)<br>&#125;)<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = router <span class="hljs-comment">// å°†åˆ›å»ºçš„è·¯ç”±æ¨¡å—å¯¼å‡º</span><br>----------------------------------------------<br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>)<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()<br><span class="hljs-keyword">const</span> router = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;./myrouter.js&quot;</span>) <span class="hljs-comment">// å¯¼å…¥è·¯ç”±æ¨¡å—</span><br>app.<span class="hljs-title function_">use</span>(router) <span class="hljs-comment">// æ³¨å†Œè·¯ç”±æ¨¡å—</span><br><span class="hljs-comment">// app.use()çš„ä½œç”¨ä¸ºæ³¨å†Œå…¨å±€ä¸­é—´ä»¶</span><br><span class="hljs-comment">// æ·»åŠ è®¿é—®å‰ç¼€/api: app.use(&quot;/api&quot;, router)</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">80</span>, <span class="hljs-function">() =&gt;</span> &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;&lt;http://127.0.0.1&gt;&quot;</span>)<br>&#125;)<br><br><span class="hljs-comment">// ä¸­é—´ä»¶å¤„ç†å‡½æ•°: function(req, res, next); è·¯ç”±å¤„ç†å‡½æ•°: function(req, res)</span><br><span class="hljs-comment">// nextå‡½æ•°æ˜¯å®ç°å¤šä¸ªä¸­é—´ä»¶è¿ç»­è°ƒç”¨çš„å…³é”®, è¡¨ç¤ºæŠŠæµè½¬å…³ç³»è½¬äº¤ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯ç”±</span><br><span class="hljs-comment">// å³å…ˆç»è¿‡åˆé€‚çš„ä¸­é—´ä»¶, å†ç»è¿‡è·¯ç”±</span><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>)<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()<br><span class="hljs-keyword">const</span> mw = <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;æœ€ç®€å•çš„ä¸­é—´ä»¶å‡½æ•°&quot;</span>)<br><span class="hljs-title function_">next</span>()<br>&#125;<br><span class="hljs-comment">// å°†mwæ³¨å†Œä¸ºå…¨å±€ç”Ÿæ•ˆçš„ä¸­é—´ä»¶(å³å®¢æˆ·ç«¯ä»»ä½•è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨éƒ½ä¼šè§¦å‘çš„ä¸­é—´ä»¶)</span><br><span class="hljs-comment">// app.use(mw)</span><br><span class="hljs-comment">// ä¹Ÿå¯ç®€åŒ–å®šä¹‰ä¸º</span><br><span class="hljs-comment">// app.use(function(req, res, next)&#123;</span><br><span class="hljs-comment">//   console.log(&quot;æœ€ç®€å•çš„ä¸­é—´ä»¶å‡½æ•°&quot;)</span><br><span class="hljs-comment">// next()</span><br><span class="hljs-comment">// &#125;)</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">80</span>, <span class="hljs-function">() =&gt;</span> &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;&lt;http://127.0.0.1&gt;&quot;</span>)<br>&#125;)<br><span class="hljs-comment">// å¤šä¸ªä¸­é—´ä»¶ä¹‹é—´å…±äº«åŒä¸€ä»½reqå’Œres, éƒ½å¯ä»¥æŒ‚è½½è‡ªå®šä¹‰çš„å±æ€§å’Œæ–¹æ³•</span><br><br><span class="hljs-comment">// å®šä¹‰å¤šä¸ªå…¨å±€ä¸­é—´ä»¶</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;è°ƒç”¨äº†ç¬¬1ä¸ªå…¨å±€ä¸­é—´ä»¶&quot;</span>)<br><span class="hljs-title function_">next</span>()<br>&#125;)<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;è°ƒç”¨äº†ç¬¬2ä¸ªå…¨å±€ä¸­é—´ä»¶&quot;</span>)<br><span class="hljs-title function_">next</span>()<br>&#125;)<br><br><span class="hljs-comment">// ä½¿ç”¨å±€éƒ¨ä¸­é—´ä»¶</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, mw, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123;<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Home page.&quot;</span>)<br>&#125;)<br><span class="hljs-comment">// ä½¿ç”¨å¤šä¸ªå±€éƒ¨ä¸­é—´ä»¶</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, mw1, mw2, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Home page.&quot;</span>)&#125;)<br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, [mw1, mw2], <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Home page.&quot;</span>)&#125;)<br><span class="hljs-comment">// æ³¨: ä¸­é—´ä»¶éœ€è¦æ³¨å†Œåœ¨è·¯ç”±å‰é¢</span><br><span class="hljs-comment">// é”™è¯¯çº§åˆ«çš„ä¸­é—´ä»¶ (è¿™ç§ä¸­é—´çº§éœ€è¦æ³¨å†Œåœ¨è·¯ç”±åé¢)</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>)&#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;å‘ç”Ÿé”™è¯¯!&quot;</span>)<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Home page.&quot;</span>)<br>&#125;)<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>)&#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;å‘ç”Ÿé”™è¯¯:&quot;</span> + err.<span class="hljs-property">message</span>)<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;error&quot;</span> + err.<span class="hljs-property">message</span>)<br>&#125;)<br><br><span class="hljs-comment">// Expresså†…ç½®çš„ä¸­é—´ä»¶</span><br>express.<span class="hljs-property">static</span>: å¿«é€Ÿæ‰˜ç®¡é™æ€èµ„æºçš„å†…ç½®ä¸­é—´ä»¶<br>express.<span class="hljs-property">json</span>: è§£æ<span class="hljs-title class_">JSON</span>æ ¼å¼çš„è¯·æ±‚ä½“æ•°æ®<br>express.<span class="hljs-property">urlencoded</span>: è§£æ<span class="hljs-variable constant_">URL</span>-encodedæ ¼å¼çš„è¯·æ±‚ä½“æ•°æ®<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>())<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span>&#125;))<br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/user&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-comment">// åœ¨æœåŠ¡å™¨ä¸­å¯ä»¥ç”¨req.bodyè¿™ä¸ªå±æ€§æ¥æ¥æ”¶å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä½“æ•°æ®</span><br><span class="hljs-comment">// è‹¥ä¸é…ç½®è§£æè¡¨å•æ•°æ®çš„ä¸­é—´ä»¶, åˆ™req.bodyé»˜è®¤ç­‰äºundefined</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">body</span>)<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;ok&quot;</span>)<br>&#125;)<br><br><span class="hljs-comment">// ç¬¬ä¸‰æ–¹ä¸­é—´ä»¶</span><br>npm install body-parser<br><span class="hljs-keyword">const</span> parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;body-parser&quot;</span>)<br>app.<span class="hljs-title function_">use</span>(parser.<span class="hljs-title function_">urlencoded</span>(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span>&#125;))<br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/user&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">body</span>)<br>res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;ok&quot;</span>)<br>&#125;)<br><br><span class="hljs-comment">// è‡ªå®šä¹‰è§£æè¡¨å•çš„ä¸­é—´ä»¶</span><br><span class="hljs-keyword">const</span> qs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;querystring&quot;</span>)<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">let</span> str = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-comment">// ç›‘å¬reqçš„dataäº‹ä»¶, æ¥è·å–å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„æ•°æ®</span><br>req.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;data&quot;</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> &#123;<br>str += chunk<br>&#125;)<br><span class="hljs-comment">// ç›‘å¬reqçš„endäº‹ä»¶(å½“è¯·æ±‚ä½“æ•°æ®æ¥æ”¶å®Œæ¯•åè‡ªåŠ¨è§¦å‘)</span><br>req.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;end&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str)<br><span class="hljs-keyword">const</span> body = qs.<span class="hljs-title function_">parse</span>(str)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(body)<br><span class="hljs-comment">// req.body = body</span><br><span class="hljs-comment">// next()</span><br>&#125;)<br>&#125;)<br>--------------------------------------------------<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">bodyParser</span> = (<span class="hljs-params">req, res, next</span>) =&gt; &#123;<br><span class="hljs-keyword">let</span> str = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-comment">// ç›‘å¬reqçš„dataäº‹ä»¶, æ¥è·å–å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„æ•°æ®</span><br>req.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;data&quot;</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> &#123;<br>str += chunk<br>&#125;)<br><span class="hljs-comment">// ç›‘å¬reqçš„endäº‹ä»¶(å½“è¯·æ±‚ä½“æ•°æ®æ¥æ”¶å®Œæ¯•åè‡ªåŠ¨è§¦å‘)</span><br>req.<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;end&quot;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str)<br><span class="hljs-keyword">const</span> body = qs.<span class="hljs-title function_">parse</span>(str)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(body)<br><span class="hljs-comment">// req.body = body</span><br><span class="hljs-comment">// next()</span><br>&#125;)<br>&#125;<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = bodyParser<br></code></pre></td></tr></table></figure><ul><li>cors: Expressçš„ä¸€ä¸ªç¬¬ä¸‰æ–¹ä¸­é—´ä»¶,å¯ä»¥è§£å†³è·¨åŸŸé—®é¢˜(åè®®æˆ–åŸŸåæˆ–ç«¯å£å·ä¸åŒ)</li></ul><p>åªéœ€åœ¨æœåŠ¡å™¨ç«¯é…ç½®, å®¢æˆ·ç«¯æ— éœ€åšä»»ä½•é¢å¤–é…ç½®</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs jsx">npm install cors<br><span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cors&quot;</span>) <span class="hljs-comment">// ä¸€å®šè¦åœ¨è·¯ç”±ä¹‹å‰è¿›è¡Œé…ç½®</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>())<br><br>...<br>&lt;body&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;btnGET&quot;</span>&gt;</span>GET<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;btnPOST&quot;</span>&gt;</span>POST<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;btnJSONP&quot;</span>&gt;</span>JSONP<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">$(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">$(<span class="hljs-string">&quot;#btnGET&quot;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">$.<span class="hljs-title function_">ajax</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">type</span>: <span class="hljs-string">&quot;GET&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">url</span>: <span class="hljs-string">&quot;&lt;http://127.0.0.1/api/get&gt;&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">data</span>: &#123;<span class="hljs-attr">name</span>: <span class="hljs-string">&quot;zhangsan&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>&#125;,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;,</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml"></span></span><br><span class="language-javascript"><span class="language-xml">$(<span class="hljs-string">&quot;#btnPOST&quot;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">$.<span class="hljs-title function_">ajax</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">type</span>: <span class="hljs-string">&quot;POST&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">url</span>: <span class="hljs-string">&quot;&lt;http://127.0.0.1/api/post&gt;&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">data</span>: &#123;<span class="hljs-attr">bookname</span>: <span class="hljs-string">&quot;test1&quot;</span>, <span class="hljs-attr">author</span>: <span class="hljs-string">&quot;test2&quot;</span>&#125;,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;,</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml"></span></span><br><span class="language-javascript"><span class="language-xml">$(<span class="hljs-string">&quot;#btnJSONP&quot;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">$.<span class="hljs-title function_">ajax</span>(&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">type</span>: <span class="hljs-string">&quot;GET&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">url</span>: <span class="hljs-string">&quot;&lt;http://127.0.0.1/api/jsonp&gt;&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">dataType</span>: <span class="hljs-string">&quot;jsonp&quot;</span>,</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;,</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml">&#125;)</span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br>&lt;/body&gt;<br>...<br><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;&lt;http://itcast.cn&gt;&quot;</span>) <span class="hljs-comment">// åªå…è®¸æ¥è‡ªhttp://itcast.cnçš„è·¨åŸŸè¯·æ±‚</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>) <span class="hljs-comment">// å…è®¸æ¥è‡ªä»»ä½•åŸŸçš„è¯·æ±‚</span><br><br><span class="hljs-comment">// é»˜è®¤æƒ…å†µä¸‹, CORSä»…æ”¯æŒå®¢æˆ·ç«¯å‘èµ·GET, POST, HEADè¯·æ±‚</span><br><span class="hljs-comment">// è‹¥è¦ä½¿ç”¨PUT, DELETEç­‰è¯·æ±‚, åˆ™éœ€è¦è¿›è¡Œå£°æ˜</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;HEAD&quot;</span>, <span class="hljs-string">&quot;PUT&quot;</span>, <span class="hljs-string">&quot;DELETE&quot;</span>)<br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="hljs-string">&quot;*&quot;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Node.js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åœ¨è¿œç¨‹æœåŠ¡å™¨é…ç½®Clash</title>
    <link href="/2023/08/30/%E5%9C%A8%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEClash/"/>
    <url>/2023/08/30/%E5%9C%A8%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AEClash/</url>
    
    <content type="html"><![CDATA[<ul><li>åœ¨ https://github.com/doreamon-design/clash/releasesä¸‹è½½ä¸è‡ªå·±ç³»ç»Ÿç›¸ç¬¦çš„å®‰è£…åŒ…ï¼Œä¸€èˆ¬é€‰æ‹©clash_2.0.24_linux_amd64.tar.gz</li><li>å°†å‹ç¼©åŒ…ä¼ è‡³è¿œç¨‹æœåŠ¡å™¨åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar -xvf clash_2.0.24_linux_amd64.tar<br><span class="hljs-built_in">mv</span> clash_2.0.24_linux_amd64 /usr/local/bin/clash<br>clash -v<br></code></pre></td></tr></table></figure><p>è‹¥èƒ½æ˜¾ç¤ºclashçš„ç‰ˆæœ¬ï¼Œåˆ™è¯´æ˜å·²æˆåŠŸå®‰è£…</p><ul><li><p>åœ¨è¿œç¨‹æœåŠ¡å™¨çš„/etcç›®å½•ä¸‹æ–°å»ºclashç›®å½•ï¼›æŸ¥çœ‹æœ¬æœºçš„clashé…ç½®ï¼Œå°†config.yamlæ–‡ä»¶ä¼ è‡³è¿œç¨‹æœåŠ¡å™¨ï¼Œå¹¶ç§»åŠ¨è‡³/etc/clashç›®å½•ä¸‹ï¼›ä¸‹è½½ç›¸åº”çš„Country.mmdb(ç½‘ä¸Šå¾ˆå¥½æ‰¾) å¹¶ç§»åŠ¨è‡³/etc/clashç›®å½•ä¸‹</p></li><li><p>æ–°å»ºtmuxçª—å£ï¼Œå¹¶æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">clash -d /etc/clash<br></code></pre></td></tr></table></figure><ul><li>åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> https_proxy=http://127.0.0.1:7890Â http_proxy=http://127.0.0.1:7890Â all_proxy=socks5://127.0.0.1:7891<br></code></pre></td></tr></table></figure><p>å®Œæˆä¸Šè¿°æ­¥éª¤åï¼Œç†è®ºä¸Šä¾¿å·²æˆåŠŸé…ç½®ï¼Œè‹¥å‡ºç°å¦‚ä¸‹çš„è¿æ¥å¤±è´¥çš„é—®é¢˜ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">INFO[0000] Can<span class="hljs-string">&#x27;t find MMDB, start download</span><br><span class="hljs-string">FATA[0000] Initial configuration directory error: can&#x27;</span>t initial MMDB: can<span class="hljs-string">&#x27;t download MMDB: Get &quot;https://cdn.jsdelivr.net/gh/Dreamacro/maxmind-geoip@release/Country.mmdb&quot;: proxyconnect tcp: dial tcp 127.0.0.1:7890: connect: connection refused</span><br></code></pre></td></tr></table></figure><p>åˆ™å¯èƒ½æ˜¯ç«¯å£å ç”¨çš„é—®é¢˜ï¼ŒæŸ¥çœ‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">export</span> | grep -i proxy<br></code></pre></td></tr></table></figure><p>å–æ¶ˆç«¯å£å ç”¨ï¼Œå†æ¬¡æŸ¥çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">unset</span> http_proxy https_proxy <br><span class="hljs-built_in">export</span> | grep -i proxy<br></code></pre></td></tr></table></figure><p>é‡æ–°è®¾ç½®ï¼Œä¹‹åå³å¯æ­£å¸¸è¿æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">declare</span> -x http_proxy=<span class="hljs-string">&quot;http://127.0.0.1:7890&quot;</span><br><span class="hljs-built_in">declare</span> -x https_proxy=<span class="hljs-string">&quot;http://127.0.0.1:7890&quot;</span><br></code></pre></td></tr></table></figure><p>ä¸ºé¿å…ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­åŠ å…¥å¦‚ä¸‹è®¾ç½®ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">import os<br>os.environ[<span class="hljs-string">&#x27;HTTP_PROXY&#x27;</span>] = <span class="hljs-string">&#x27;http://127.0.0.1:7890&#x27;</span><br>os.environ[<span class="hljs-string">&#x27;HTTPS_PROXY&#x27;</span>] = <span class="hljs-string">&#x27;http://127.0.0.1:7890&#x27;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
